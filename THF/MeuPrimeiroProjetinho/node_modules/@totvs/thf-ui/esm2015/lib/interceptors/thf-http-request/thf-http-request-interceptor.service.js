/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { HttpResponse } from '@angular/common/http';
import { throwError } from 'rxjs';
import { catchError, tap } from 'rxjs/operators';
import { ThfComponentInjectorService } from '../../services/thf-component-injector/thf-component-injector.service';
import { ThfLoadingOverlayComponent } from '../../components/thf-loading/thf-loading-overlay/thf-loading-overlay.component';
import { ThfHttpRequesControltService } from './thf-http-request-control-service';
import * as i0 from "@angular/core";
import * as i1 from "./thf-http-request-control-service";
import * as i2 from "../../services/thf-component-injector/thf-component-injector.service";
/** @type {?} */
const noCountPendingRequests = 'X-Totvs-No-Count-Pending-Requests';
/** @type {?} */
const screenLock = 'X-Totvs-Screen-Lock';
/**
 * \@description
 *
 * O serviço Totvs Http Request Interceptor realiza a contabilização de requisições pendentes na aplicação.
 *
 * Existe a possibilidade de não efetuar a contabilização das requisições pendentes, utilizando o parâmetro
 * `X-Totvs-No-Count-Pending-Requests`. Para isso deve ser informado no cabeçalho da requisição com o valor `'true'`,
 * por exemplo:
 *
 * ```
 * ...
 *  const headers = { 'X-Totvs-No-Count-Pending-Requests': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 * Para obter a quantidade de requisições pendentes, deve inscrever-se no método `getCountPendingRequests` do
 * serviço `ThfHttpRequestInterceptorService`, com isso, ao realizar requisições utilizando `HttpClient`,
 * será retornado a quantidade de requisições pendentes.
 *
 * Também existe a possibildade de travar a tela e mostrar uma imagem de _loading_ durante o processamento de uma requisição
 * deve-se passar o parâmetro `X-Totvs-Screen-Lock` no cabeçalho da requisição com valor `'true'`.
 *
 * por exemplo:
 *
 * ```
 * ...
 *  const headers = { 'X-Totvs-Screen-Lock': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 * > Após a validação no interceptor, o parâmetro será removido do cabeçalho da requisição.
 *
 * Ao importar o módulo `ThfModule` na aplicação, o `thf-http-request-interceptor` é automaticamente configurado sem a necessidade
 * de qualquer configuração extra.
 *
 *
 * Segue abaixo um exemplo de uso:
 *
 * ```
 * import { HttpClient } from '\@angular/common/http';
 *
 * ...
 *
 * \@Injectable()
 * export class CustomersService {
 *
 *  headers = { 'X-Totvs-No-Count-Pending-Requests': true, 'X-Totvs-Screen-Lock': 'true' }
 *  pendingRequests: number = 0;
 *  subscription: Subscription;
 *
 *  constructor(
 *    private http: HttpClient,
 *    private httpRequestInterceptor: ThfHttpRequestInterceptorService) { }
 *
 *  ngOnDestroy(): void {
 *    this.subscription.unsubscribe();
 *  }
 *
 *  ngOnInit(): void {
 *    this.subscription = this.httpRequestInterceptor.getCountPendingRequests().subscribe(data => {
 *      this.pendingRequests = data;
 *    });
 *  }
 *
 *  getCustomers() {
 *    return this.http.get(`/customers/1`, { headers: headers });
 *  }
 *
 *  ...
 *
 * }
 * ```
 *
 * \@example
 * <example name='thf-http-request-interceptor-labs' title='Totvs Http Request Interceptor Labs'>
 *  <file name='sample-thf-http-request-interceptor-labs.component.ts'> </file>
 *  <file name='sample-thf-http-request-interceptor-labs.component.html'> </file>
 * </example>
 */
export class ThfHttpRequestInterceptorService {
    /**
     * @param {?} controlHttpRequest
     * @param {?} thfComponentInjector
     */
    constructor(controlHttpRequest, thfComponentInjector) {
        this.controlHttpRequest = controlHttpRequest;
        this.thfComponentInjector = thfComponentInjector;
        this.loadingOverlayComponent = undefined;
        this.pendingRequests = 0;
        this.overlayRequests = 0;
    }
    /**
     * @param {?} request
     * @param {?} next
     * @return {?}
     */
    intercept(request, next) {
        /** @type {?} */
        const requestClone = request.clone();
        request = this.requestCloneWithoutHeaderParam([noCountPendingRequests, screenLock], request);
        this.setCountPendingRequests(true, requestClone);
        this.setCountOverlayRequests(true, requestClone);
        return next.handle(request).pipe(tap((/**
         * @param {?} response
         * @return {?}
         */
        (response) => {
            if (response instanceof HttpResponse) {
                this.setCountPendingRequests(false, requestClone);
                this.setCountOverlayRequests(false, requestClone);
            }
        })), catchError((/**
         * @param {?} error
         * @return {?}
         */
        error => {
            this.setCountPendingRequests(false, requestClone);
            this.setCountOverlayRequests(false, requestClone);
            return throwError(error);
        })));
    }
    /**
     * @return {?}
     */
    getCountPendingRequests() {
        return this.controlHttpRequest.getControlHttpRequest();
    }
    /**
     * @private
     * @return {?}
     */
    buildLoading() {
        if (!this.loadingOverlayComponent) {
            this.loadingOverlayComponent = this.thfComponentInjector.createComponentInApplication(ThfLoadingOverlayComponent);
            this.loadingOverlayComponent.instance.screenLock = true;
            this.loadingOverlayComponent.instance.changeDetector.detectChanges();
        }
    }
    /**
     * @private
     * @return {?}
     */
    destroyLoading() {
        if (this.loadingOverlayComponent) {
            this.thfComponentInjector.destroyComponentInApplication(this.loadingOverlayComponent);
            this.loadingOverlayComponent = undefined;
        }
    }
    /**
     * @private
     * @param {?} headersParams
     * @param {?} request
     * @return {?}
     */
    requestCloneWithoutHeaderParam(headersParams, request) {
        /** @type {?} */
        let isRequestClone = false;
        headersParams.forEach((/**
         * @param {?} headerParam
         * @return {?}
         */
        headerParam => {
            if (request.headers.has(headerParam)) {
                request.headers.delete(headerParam);
                isRequestClone = true;
            }
        }));
        return isRequestClone ? request.clone({ headers: request.headers }) : request;
    }
    /**
     * @private
     * @param {?} isIncrement
     * @param {?} request
     * @return {?}
     */
    setCountPendingRequests(isIncrement, request) {
        /** @type {?} */
        const hasCountPendingRequestHeaderParam = request.headers.has(noCountPendingRequests);
        /** @type {?} */
        const headerParam = request.headers.get(noCountPendingRequests);
        if (hasCountPendingRequestHeaderParam && (headerParam.toString().toLowerCase() === 'true')) {
            return;
        }
        this.pendingRequests += isIncrement ? 1 : -1;
        this.controlHttpRequest.send(this.pendingRequests);
    }
    /**
     * @private
     * @param {?} isIncrement
     * @param {?} request
     * @return {?}
     */
    setCountOverlayRequests(isIncrement, request) {
        /** @type {?} */
        const hasOverlayRequestHeaderParam = request.headers.has(screenLock);
        if (hasOverlayRequestHeaderParam) {
            /** @type {?} */
            const headerParam = request.headers.get(screenLock);
            if (headerParam.toString().toLowerCase() === 'false') {
                return;
            }
            this.overlayRequests += isIncrement ? 1 : -1;
            this.overlayRequests > 0 ? this.buildLoading() : this.destroyLoading();
        }
    }
}
ThfHttpRequestInterceptorService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
ThfHttpRequestInterceptorService.ctorParameters = () => [
    { type: ThfHttpRequesControltService },
    { type: ThfComponentInjectorService }
];
/** @nocollapse */ ThfHttpRequestInterceptorService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function ThfHttpRequestInterceptorService_Factory() { return new ThfHttpRequestInterceptorService(i0.ɵɵinject(i1.ThfHttpRequesControltService), i0.ɵɵinject(i2.ThfComponentInjectorService)); }, token: ThfHttpRequestInterceptorService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    ThfHttpRequestInterceptorService.prototype.loadingOverlayComponent;
    /**
     * @type {?}
     * @private
     */
    ThfHttpRequestInterceptorService.prototype.pendingRequests;
    /**
     * @type {?}
     * @private
     */
    ThfHttpRequestInterceptorService.prototype.overlayRequests;
    /**
     * @type {?}
     * @private
     */
    ThfHttpRequestInterceptorService.prototype.controlHttpRequest;
    /**
     * @type {?}
     * @private
     */
    ThfHttpRequestInterceptorService.prototype.thfComponentInjector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGhmLWh0dHAtcmVxdWVzdC1pbnRlcmNlcHRvci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHRvdHZzL3RoZi11aS8iLCJzb3VyY2VzIjpbImxpYi9pbnRlcmNlcHRvcnMvdGhmLWh0dHAtcmVxdWVzdC90aGYtaHR0cC1yZXF1ZXN0LWludGVyY2VwdG9yLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBZ0IsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pELE9BQU8sRUFBd0QsWUFBWSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFMUcsT0FBTyxFQUFjLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM5QyxPQUFPLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRWpELE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLHNFQUFzRSxDQUFDO0FBQ25ILE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLGdGQUFnRixDQUFDO0FBRTVILE9BQU8sRUFBRSw0QkFBNEIsRUFBRSxNQUFNLG9DQUFvQyxDQUFDOzs7OztNQUU1RSxzQkFBc0IsR0FBRyxtQ0FBbUM7O01BQzVELFVBQVUsR0FBRyxxQkFBcUI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQXdGeEMsTUFBTSxPQUFPLGdDQUFnQzs7Ozs7SUFPM0MsWUFDVSxrQkFBZ0QsRUFDaEQsb0JBQWlEO1FBRGpELHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBOEI7UUFDaEQseUJBQW9CLEdBQXBCLG9CQUFvQixDQUE2QjtRQVBuRCw0QkFBdUIsR0FBNkMsU0FBUyxDQUFDO1FBRTlFLG9CQUFlLEdBQVcsQ0FBQyxDQUFDO1FBQzVCLG9CQUFlLEdBQVcsQ0FBQyxDQUFDO0lBSTRCLENBQUM7Ozs7OztJQUVqRSxTQUFTLENBQUMs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ZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cEV2ZW50LCBIdHRwSGFuZGxlciwgSHR0cEludGVyY2VwdG9yLCBIdHRwUmVxdWVzdCwgSHR0cFJlc3BvbnNlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IFRoZkNvbXBvbmVudEluamVjdG9yU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3RoZi1jb21wb25lbnQtaW5qZWN0b3IvdGhmLWNvbXBvbmVudC1pbmplY3Rvci5zZXJ2aWNlJztcbmltcG9ydCB7IFRoZkxvYWRpbmdPdmVybGF5Q29tcG9uZW50IH0gZnJvbSAnLi4vLi4vY29tcG9uZW50cy90aGYtbG9hZGluZy90aGYtbG9hZGluZy1vdmVybGF5L3RoZi1sb2FkaW5nLW92ZXJsYXkuY29tcG9uZW50JztcblxuaW1wb3J0IHsgVGhmSHR0cFJlcXVlc0NvbnRyb2x0U2VydmljZSB9IGZyb20gJy4vdGhmLWh0dHAtcmVxdWVzdC1jb250cm9sLXNlcnZpY2UnO1xuXG5jb25zdCBub0NvdW50UGVuZGluZ1JlcXVlc3RzID0gJ1gtVG90dnMtTm8tQ291bnQtUGVuZGluZy1SZXF1ZXN0cyc7XG5jb25zdCBzY3JlZW5Mb2NrID0gJ1gtVG90dnMtU2NyZWVuLUxvY2snO1xuXG4vKipcbiAqIEBkZXNjcmlwdGlvblxuICpcbiAqIE8gc2VydmnDp28gVG90dnMgSHR0cCBSZXF1ZXN0IEludGVyY2VwdG9yIHJlYWxpemEgYSBjb250YWJpbGl6YcOnw6NvIGRlIHJlcXVpc2nDp8O1ZXMgcGVuZGVudGVzIG5hIGFwbGljYcOnw6NvLlxuICpcbiAqIEV4aXN0ZSBhIHBvc3NpYmlsaWRhZGUgZGUgbsOjbyBlZmV0dWFyIGEgY29udGFiaWxpemHDp8OjbyBkYXMgcmVxdWlzacOnw7VlcyBwZW5kZW50ZXMsIHV0aWxpemFuZG8gbyBwYXLDom1ldHJvXG4gKiBgWC1Ub3R2cy1Oby1Db3VudC1QZW5kaW5nLVJlcXVlc3RzYC4gUGFyYSBpc3NvIGRldmUgc2VyIGluZm9ybWFkbyBubyBjYWJlw6dhbGhvIGRhIHJlcXVpc2nDp8OjbyBjb20gbyB2YWxvciBgJ3RydWUnYCxcbiAqIHBvciBleGVtcGxvOlxuICpcbiAqIGBgYFxuICogLi4uXG4gKiAgY29uc3QgaGVhZGVycyA9IHsgJ1gtVG90dnMtTm8tQ291bnQtUGVuZGluZy1SZXF1ZXN0cyc6ICd0cnVlJyB9O1xuICpcbiAqICB0aGlzLmh0dHAuZ2V0KGAvY3VzdG9tZXJzLzFgLCB7IGhlYWRlcnM6IGhlYWRlcnMgfSk7XG4gKiAuLi5cbiAqXG4gKiBgYGBcbiAqIFBhcmEgb2J0ZXIgYSBxdWFudGlkYWRlIGRlIHJlcXVpc2nDp8O1ZXMgcGVuZGVudGVzLCBkZXZlIGluc2NyZXZlci1zZSBubyBtw6l0b2RvIGBnZXRDb3VudFBlbmRpbmdSZXF1ZXN0c2AgZG9cbiAqIHNlcnZpw6dvIGBUaGZIdHRwUmVxdWVzdEludGVyY2VwdG9yU2VydmljZWAsIGNvbSBpc3NvLCBhbyByZWFsaXphciByZXF1aXNpw6fDtWVzIHV0aWxpemFuZG8gYEh0dHBDbGllbnRgLFxuICogc2Vyw6EgcmV0b3JuYWRvIGEgcXVhbnRpZGFkZSBkZSByZXF1aXNpw6fDtWVzIHBlbmRlbnRlcy5cbiAqXG4gKiBUYW1iw6ltIGV4aXN0ZSBhIHBvc3NpYmlsZGFkZSBkZSB0cmF2YXIgYSB0ZWxhIGUgbW9zdHJhciB1bWEgaW1hZ2VtIGRlIF9sb2FkaW5nXyBkdXJhbnRlIG8gcHJvY2Vzc2FtZW50byBkZSB1bWEgcmVxdWlzacOnw6NvXG4gKiBkZXZlLXNlIHBhc3NhciBvIHBhcsOibWV0cm8gYFgtVG90dnMtU2NyZWVuLUxvY2tgIG5vIGNhYmXDp2FsaG8gZGEgcmVxdWlzacOnw6NvIGNvbSB2YWxvciBgJ3RydWUnYC5cbiAqXG4gKiBwb3IgZXhlbXBsbzpcbiAqXG4gKiBgYGBcbiAqIC4uLlxuICogIGNvbnN0IGhlYWRlcnMgPSB7ICdYLVRvdHZzLVNjcmVlbi1Mb2NrJzogJ3RydWUnIH07XG4gKlxuICogIHRoaXMuaHR0cC5nZXQoYC9jdXN0b21lcnMvMWAsIHsgaGVhZGVyczogaGVhZGVycyB9KTtcbiAqIC4uLlxuICpcbiAqIGBgYFxuICogPiBBcMOzcyBhIHZhbGlkYcOnw6NvIG5vIGludGVyY2VwdG9yLCBvIHBhcsOibWV0cm8gc2Vyw6EgcmVtb3ZpZG8gZG8gY2FiZcOnYWxobyBkYSByZXF1aXNpw6fDo28uXG4gKlxuICogQW8gaW1wb3J0YXIgbyBtw7NkdWxvIGBUaGZNb2R1bGVgIG5hIGFwbGljYcOnw6NvLCBvIGB0aGYtaHR0cC1yZXF1ZXN0LWludGVyY2VwdG9yYCDDqSBhdXRvbWF0aWNhbWVudGUgY29uZmlndXJhZG8gc2VtIGEgbmVjZXNzaWRhZGVcbiAqIGRlIHF1YWxxdWVyIGNvbmZpZ3VyYcOnw6NvIGV4dHJhLlxuICpcbiAqXG4gKiBTZWd1ZSBhYmFpeG8gdW0gZXhlbXBsbyBkZSB1c286XG4gKlxuICogYGBgXG4gKiBpbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuICpcbiAqIC4uLlxuICpcbiAqIEBJbmplY3RhYmxlKClcbiAqIGV4cG9ydCBjbGFzcyBDdXN0b21lcnNTZXJ2aWNlIHtcbiAqXG4gKiAgaGVhZGVycyA9IHsgJ1gtVG90dnMtTm8tQ291bnQtUGVuZGluZy1SZXF1ZXN0cyc6IHRydWUsICdYLVRvdHZzLVNjcmVlbi1Mb2NrJzogJ3RydWUnIH1cbiAqICBwZW5kaW5nUmVxdWVzdHM6IG51bWJlciA9IDA7XG4gKiAgc3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG4gKlxuICogIGNvbnN0cnVjdG9yKFxuICogICAgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LFxuICogICAgcHJpdmF0ZSBodHRwUmVxdWVzdEludGVyY2VwdG9yOiBUaGZIdHRwUmVxdWVzdEludGVyY2VwdG9yU2VydmljZSkgeyB9XG4gKlxuICogIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICogICAgdGhpcy5zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAqICB9XG4gKlxuICogIG5nT25Jbml0KCk6IHZvaWQge1xuICogICAgdGhpcy5zdWJzY3JpcHRpb24gPSB0aGlzLmh0dHBSZXF1ZXN0SW50ZXJjZXB0b3IuZ2V0Q291bnRQZW5kaW5nUmVxdWVzdHMoKS5zdWJzY3JpYmUoZGF0YSA9PiB7XG4gKiAgICAgIHRoaXMucGVuZGluZ1JlcXVlc3RzID0gZGF0YTtcbiAqICAgIH0pO1xuICogIH1cbiAqXG4gKiAgZ2V0Q3VzdG9tZXJzKCkge1xuICogICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQoYC9jdXN0b21lcnMvMWAsIHsgaGVhZGVyczogaGVhZGVycyB9KTtcbiAqICB9XG4gKlxuICogIC4uLlxuICpcbiAqIH1cbiAqIGBgYFxuICpcbiAqIEBleGFtcGxlXG4gKiA8ZXhhbXBsZSBuYW1lPSd0aGYtaHR0cC1yZXF1ZXN0LWludGVyY2VwdG9yLWxhYnMnIHRpdGxlPSdUb3R2cyBIdHRwIFJlcXVlc3QgSW50ZXJjZXB0b3IgTGFicyc+XG4gKiAgPGZpbGUgbmFtZT0nc2FtcGxlLXRoZi1odHRwLXJlcXVlc3QtaW50ZXJjZXB0b3ItbGFicy5jb21wb25lbnQudHMnPiA8L2ZpbGU+XG4gKiAgPGZpbGUgbmFtZT0nc2FtcGxlLXRoZi1odHRwLXJlcXVlc3QtaW50ZXJjZXB0b3ItbGFicy5jb21wb25lbnQuaHRtbCc+IDwvZmlsZT5cbiAqIDwvZXhhbXBsZT5cbiAqL1xuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgVGhmSHR0cFJlcXVlc3RJbnRlcmNlcHRvclNlcnZpY2UgaW1wbGVtZW50cyBIdHRwSW50ZXJjZXB0b3Ige1xuXG4gIHByaXZhdGUgbG9hZGluZ092ZXJsYXlDb21wb25lbnQ6IENvbXBvbmVudFJlZjxUaGZMb2FkaW5nT3ZlcmxheUNvbXBvbmVudD4gPSB1bmRlZmluZWQ7XG5cbiAgcHJpdmF0ZSBwZW5kaW5nUmVxdWVzdHM6IG51bWJlciA9IDA7XG4gIHByaXZhdGUgb3ZlcmxheVJlcXVlc3RzOiBudW1iZXIgPSAwO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgY29udHJvbEh0dHBSZXF1ZXN0OiBUaGZIdHRwUmVxdWVzQ29udHJvbHRTZXJ2aWNlLFxuICAgIHByaXZhdGUgdGhmQ29tcG9uZW50SW5qZWN0b3I6IFRoZkNvbXBvbmVudEluamVjdG9yU2VydmljZSkgeyAgfVxuXG4gIGludGVyY2VwdChyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+LCBuZXh0OiBIdHRwSGFuZGxlcikge1xuXG4gICAgY29uc3QgcmVxdWVzdENsb25lID0gcmVxdWVzdC5jbG9uZSgpO1xuXG4gICAgcmVxdWVzdCA9IHRoaXMucmVxdWVzdENsb25lV2l0aG91dEhlYWRlclBhcmFtKFtub0NvdW50UGVuZGluZ1JlcXVlc3RzLCBzY3JlZW5Mb2NrXSwgcmVxdWVzdCk7XG5cbiAgICB0aGlzLnNldENvdW50UGVuZGluZ1JlcXVlc3RzKHRydWUsIHJlcXVlc3RDbG9uZSk7XG4gICAgdGhpcy5zZXRDb3VudE92ZXJsYXlSZXF1ZXN0cyh0cnVlLCByZXF1ZXN0Q2xvbmUpO1xuXG4gICAgcmV0dXJuIG5leHQuaGFuZGxlKHJlcXVlc3QpLnBpcGUoXG4gICAgICB0YXAoKHJlc3BvbnNlOiBIdHRwRXZlbnQ8YW55PikgPT4ge1xuICAgICAgICBpZiAocmVzcG9uc2UgaW5zdGFuY2VvZiBIdHRwUmVzcG9uc2UpIHtcbiAgICAgICAgICB0aGlzLnNldENvdW50UGVuZGluZ1JlcXVlc3RzKGZhbHNlLCByZXF1ZXN0Q2xvbmUpO1xuICAgICAgICAgIHRoaXMuc2V0Q291bnRPdmVybGF5UmVxdWVzdHMoZmFsc2UsIHJlcXVlc3RDbG9uZSk7XG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiB7XG4gICAgICAgIHRoaXMuc2V0Q291bnRQZW5kaW5nUmVxdWVzdHMoZmFsc2UsIHJlcXVlc3RDbG9uZSk7XG4gICAgICAgIHRoaXMuc2V0Q291bnRPdmVybGF5UmVxdWVzdHMoZmFsc2UsIHJlcXVlc3RDbG9uZSk7XG5cbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZXJyb3IpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgZ2V0Q291bnRQZW5kaW5nUmVxdWVzdHMoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5jb250cm9sSHR0cFJlcXVlc3QuZ2V0Q29udHJvbEh0dHBSZXF1ZXN0KCk7XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkTG9hZGluZygpIHtcbiAgICBpZiAoIXRoaXMubG9hZGluZ092ZXJsYXlDb21wb25lbnQpIHtcbiAgICAgIHRoaXMubG9hZGluZ092ZXJsYXlDb21wb25lbnQgPSB0aGlzLnRoZkNvbXBvbmVudEluamVjdG9yLmNyZWF0ZUNvbXBvbmVudEluQXBwbGljYXRpb24oVGhmTG9hZGluZ092ZXJsYXlDb21wb25lbnQpO1xuICAgICAgdGhpcy5sb2FkaW5nT3ZlcmxheUNvbXBvbmVudC5pbnN0YW5jZS5zY3JlZW5Mb2NrID0gdHJ1ZTtcbiAgICAgIHRoaXMubG9hZGluZ092ZXJsYXlDb21wb25lbnQuaW5zdGFuY2UuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZGVzdHJveUxvYWRpbmcoKSB7XG4gICAgaWYgKHRoaXMubG9hZGluZ092ZXJsYXlDb21wb25lbnQpIHtcbiAgICAgIHRoaXMudGhmQ29tcG9uZW50SW5qZWN0b3IuZGVzdHJveUNvbXBvbmVudEluQXBwbGljYXRpb24odGhpcy5sb2FkaW5nT3ZlcmxheUNvbXBvbmVudCk7XG4gICAgICB0aGlzLmxvYWRpbmdPdmVybGF5Q29tcG9uZW50ID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVxdWVzdENsb25lV2l0aG91dEhlYWRlclBhcmFtKGhlYWRlcnNQYXJhbXM6IEFycmF5PHN0cmluZz4sIHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pOiBIdHRwUmVxdWVzdDxhbnk+IHtcbiAgICBsZXQgaXNSZXF1ZXN0Q2xvbmUgPSBmYWxzZTtcblxuICAgIGhlYWRlcnNQYXJhbXMuZm9yRWFjaChoZWFkZXJQYXJhbSA9PiB7XG4gICAgICBpZiAocmVxdWVzdC5oZWFkZXJzLmhhcyhoZWFkZXJQYXJhbSkpIHtcbiAgICAgICAgcmVxdWVzdC5oZWFkZXJzLmRlbGV0ZShoZWFkZXJQYXJhbSk7XG4gICAgICAgIGlzUmVxdWVzdENsb25lID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGlzUmVxdWVzdENsb25lID8gcmVxdWVzdC5jbG9uZSh7aGVhZGVyczogcmVxdWVzdC5oZWFkZXJzfSkgOiByZXF1ZXN0O1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRDb3VudFBlbmRpbmdSZXF1ZXN0cyhpc0luY3JlbWVudDogYm9vbGVhbiwgcmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pikge1xuXG4gICAgY29uc3QgaGFzQ291bnRQZW5kaW5nUmVxdWVzdEhlYWRlclBhcmFtID0gcmVxdWVzdC5oZWFkZXJzLmhhcyhub0NvdW50UGVuZGluZ1JlcXVlc3RzKTtcbiAgICBjb25zdCBoZWFkZXJQYXJhbSA9IHJlcXVlc3QuaGVhZGVycy5nZXQobm9Db3VudFBlbmRpbmdSZXF1ZXN0cyk7XG5cbiAgICBpZiAoaGFzQ291bnRQZW5kaW5nUmVxdWVzdEhlYWRlclBhcmFtICYmIChoZWFkZXJQYXJhbS50b1N0cmluZygpLnRvTG93ZXJDYXNlKCkgPT09ICd0cnVlJyApICkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMucGVuZGluZ1JlcXVlc3RzICs9IGlzSW5jcmVtZW50ID8gMSA6IC0xO1xuICAgIHRoaXMuY29udHJvbEh0dHBSZXF1ZXN0LnNlbmQodGhpcy5wZW5kaW5nUmVxdWVzdHMpO1xuXG4gIH1cblxuICBwcml2YXRlIHNldENvdW50T3ZlcmxheVJlcXVlc3RzKGlzSW5jcmVtZW50OiBib29sZWFuLCByZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KSB7XG4gICAgY29uc3QgaGFzT3ZlcmxheVJlcXVlc3RIZWFkZXJQYXJhbSA9IHJlcXVlc3QuaGVhZGVycy5oYXMoc2NyZWVuTG9jayk7XG5cbiAgICBpZiAoaGFzT3ZlcmxheVJlcXVlc3RIZWFkZXJQYXJhbSkge1xuICAgICAgY29uc3QgaGVhZGVyUGFyYW0gPSByZXF1ZXN0LmhlYWRlcnMuZ2V0KHNjcmVlbkxvY2spO1xuXG4gICAgICBpZiAoaGVhZGVyUGFyYW0udG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpID09PSAnZmFsc2UnKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgdGhpcy5vdmVybGF5UmVxdWVzdHMgKz0gaXNJbmNyZW1lbnQgPyAxIDogLTE7XG4gICAgICB0aGlzLm92ZXJsYXlSZXF1ZXN0cyA+IDAgPyB0aGlzLmJ1aWxkTG9hZGluZygpIDogdGhpcy5kZXN0cm95TG9hZGluZygpO1xuICAgIH1cbiAgfVxuXG59XG4iXX0=