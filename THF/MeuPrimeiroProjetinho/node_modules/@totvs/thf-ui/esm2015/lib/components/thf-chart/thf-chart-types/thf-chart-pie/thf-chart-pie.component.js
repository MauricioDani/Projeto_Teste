/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, ElementRef, NgZone, Renderer2 } from '@angular/core';
import { thfChartAngleStepInterval, thfChartCompleteCircle, thfChartPadding, thfChartStartAngle } from './thf-chart-pie.constant';
import { ThfChartDynamicTypeComponent } from '../thf-chart-dynamic-type.component';
export class ThfChartPieComponent extends ThfChartDynamicTypeComponent {
    /**
     * @param {?} el
     * @param {?} ngZone
     * @param {?} renderer
     */
    constructor(el, ngZone, renderer) {
        super();
        this.el = el;
        this.ngZone = ngZone;
        this.renderer = renderer;
        this.chartItemsEndAngleList = [];
        this.svgPathElementsList = [];
    }
    /**
     * @private
     * @param {?} value
     * @param {?} totalValue
     * @return {?}
     */
    static calculateEndAngle(value, totalValue) {
        return value / totalValue * (Math.PI * 2);
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.removeWindowResizeListener();
        this.removeWindowScrollListener();
        this.animationRunning = false;
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.chartInitSetup();
        this.setEventListeners();
    }
    /**
     * @private
     * @return {?}
     */
    animationSetup() {
        this.chartItemStartAngle = thfChartStartAngle;
        this.chartItemEndAngle = this.chartItemsEndAngleList[0];
        this.animationRunning = true;
        this.drawPathInit();
    }
    /**
     * @private
     * @return {?}
     */
    calculateAngleRadians() {
        this.series.forEach((/**
         * @param {?} serie
         * @param {?} index
         * @return {?}
         */
        (serie, index) => this.chartItemsEndAngleList[index] = ThfChartPieComponent.calculateEndAngle(serie.value, this.totalValue)));
    }
    /**
     * @private
     * @param {?} angleCurrentPosition
     * @return {?}
     */
    calculateCurrentEndAngle(angleCurrentPosition) {
        /** @type {?} */
        const isSerieDrawCompleted = this.chartItemStartAngle + angleCurrentPosition > this.chartItemStartAngle + this.chartItemEndAngle;
        if (isSerieDrawCompleted) {
            return (this.chartItemStartAngle + this.chartItemEndAngle) - thfChartCompleteCircle;
        }
        else {
            return this.chartItemStartAngle + angleCurrentPosition;
        }
    }
    /**
     * @private
     * @param {?} event
     * @return {?}
     */
    changeTooltipPosition(event) {
        if (this.tooltipElement && this.tooltipElement.classList.contains('thf-invisible')) {
            this.showTooltip();
        }
        /** @type {?} */
        const tooltipPositions = this.setTooltipPositions(event);
        this.renderer.setStyle(this.tooltipElement, 'left', `${tooltipPositions.left}px`);
        this.renderer.setStyle(this.tooltipElement, 'top', `${tooltipPositions.top}px`);
    }
    /**
     * @private
     * @return {?}
     */
    chartInitSetup() {
        this.calculateSVGContainerDimensions(this.chartWrapper, this.chartHeader, this.chartLegend);
        this.calculateTotalValue();
        this.calculateAngleRadians();
        this.createSVGElements();
        this.animationSetup();
    }
    /**
     * @private
     * @param {?} index
     * @param {?} serie
     * @param {?} svgPathsWrapper
     * @return {?}
     */
    createPath(index, serie, svgPathsWrapper) {
        /** @type {?} */
        const svgPath = this.renderer.createElement('svg:path', 'svg');
        this.renderer.setAttribute(svgPath, 'class', 'thf-path-item');
        this.renderer.setAttribute(svgPath, 'fill', this.colors[index]);
        this.renderer.setAttribute(svgPath, 'data-tooltip-category', serie.category);
        this.renderer.setAttribute(svgPath, 'data-tooltip-value', serie.value.toString());
        this.renderer.setAttribute(svgPath, 'data-tooltip-text', serie.tooltip || `${serie.category}: ${serie.value}`);
        svgPathsWrapper.appendChild(svgPath);
        this.renderer.appendChild(this.svgElement, svgPathsWrapper);
        this.svgPathElementsList.push(svgPath);
    }
    /**
     * @private
     * @return {?}
     */
    createPaths() {
        /** @type {?} */
        const svgPathsWrapper = this.renderer.createElement('svg:g', 'svg');
        this.series.forEach((/**
         * @param {?} serie
         * @param {?} index
         * @return {?}
         */
        (serie, index) => this.createPath(index, serie, svgPathsWrapper)));
    }
    /**
     * @private
     * @return {?}
     */
    createSVGElements() {
        this.svgElement = this.renderer.createElement('svg:svg', 'svg');
        this.renderer.setAttribute(this.svgElement, 'viewBox', `0 0 ${this.chartWrapper} ${this.centerX * 2}`);
        this.renderer.setAttribute(this.svgElement, 'preserveAspectRatio', 'xMidYMin meet');
        this.renderer.setAttribute(this.svgElement, 'class', 'thf-chart-svg-element');
        this.renderer.setAttribute(this.svgElement, 'width', `${this.chartWrapper - thfChartPadding * 2}`);
        this.renderer.setAttribute(this.svgElement, 'height', `${this.svgHeight}`);
        this.svgContainer.nativeElement.appendChild(this.svgElement);
        this.createPaths();
    }
    /**
     * @private
     * @param {?} path
     * @param {?} chartItemStartAngle
     * @param {?} chartItemEndAngle
     * @return {?}
     */
    drawPath(path, chartItemStartAngle, chartItemEndAngle) {
        /** @type {?} */
        const largeArc = (chartItemEndAngle - chartItemStartAngle) % (Math.PI * 2) > Math.PI ? 1 : 0;
        /** @type {?} */
        const startX = this.centerX + Math.cos(chartItemStartAngle) * this.centerX;
        /** @type {?} */
        const startY = this.centerX + Math.sin(chartItemStartAngle) * this.centerX;
        /** @type {?} */
        const endX = this.centerX + Math.cos(chartItemEndAngle) * this.centerX;
        /** @type {?} */
        const endY = this.centerX + Math.sin(chartItemEndAngle) * this.centerX;
        /** @type {?} */
        const pathCoordinates = [
            'M', startX, startY,
            'A', this.centerX, this.centerX, 0, largeArc, 1, endX, endY,
            'L', this.centerX, this.centerX,
            'Z'
        ].join(' ');
        return path.setAttribute('d', pathCoordinates);
    }
    /**
     * @private
     * @return {?}
     */
    drawPathInit() {
        if (!this.animationRunning) {
            return;
        }
        else {
            this.ngZone.runOutsideAngular((/**
             * @return {?}
             */
            () => this.drawSeries()));
        }
    }
    /**
     * @private
     * @param {?=} currentSerieIndex
     * @param {?=} angleCurrentPosition
     * @return {?}
     */
    drawSeries(currentSerieIndex = 0, angleCurrentPosition = 0) {
        /** @type {?} */
        const isFinishedDrawingCurrentSeries = angleCurrentPosition > this.chartItemEndAngle;
        /** @type {?} */
        const isFinishedDrawingAllSeries = currentSerieIndex === this.svgPathElementsList.length;
        if (isFinishedDrawingAllSeries) {
            return;
        }
        if (isFinishedDrawingCurrentSeries) {
            this.chartItemStartAngle = this.chartItemStartAngle + this.chartItemEndAngle;
            currentSerieIndex++;
            this.chartItemEndAngle = this.chartItemsEndAngleList[currentSerieIndex];
            angleCurrentPosition = 0;
        }
        else {
            angleCurrentPosition += thfChartAngleStepInterval;
            this.drawPath(this.svgPathElementsList[currentSerieIndex], this.chartItemStartAngle, this.calculateCurrentEndAngle(angleCurrentPosition));
        }
        window.requestAnimationFrame(this.drawSeries.bind(this, currentSerieIndex, angleCurrentPosition));
    }
    /**
     * @private
     * @param {?} event
     * @return {?}
     */
    emitEventOnEnter(event) {
        this.onSerieHover.next(event);
    }
    /**
     * @private
     * @return {?}
     */
    onMouseClick() {
        /** @type {?} */
        const serieOnClick = { category: this.chartElementCategory, value: this.chartElementValue };
        this.onSerieClick.next(serieOnClick);
    }
    /**
     * @private
     * @param {?} event
     * @return {?}
     */
    onMouseEnter(event) {
        this.tooltipElement = this.chartBody.nativeElement.lastChild;
        this.chartElementCategory = event.target.getAttributeNS(null, 'data-tooltip-category');
        this.chartElementValue = event.target.getAttributeNS(null, 'data-tooltip-value');
        this.tooltipText = event.target.getAttributeNS(null, 'data-tooltip-text');
        this.showTooltip();
        this.changeTooltipPosition(event);
        /** @type {?} */
        const serieOnEnter = { category: this.chartElementCategory, value: this.chartElementValue };
        this.emitEventOnEnter(serieOnEnter);
    }
    /**
     * @private
     * @return {?}
     */
    onWindowResize() {
        this.calculateSVGContainerDimensions(this.chartWrapper, this.chartHeader, this.chartLegend);
        this.renderer.setAttribute(this.svgElement, 'width', `${this.chartWrapper - thfChartPadding * 2}`);
        this.renderer.setAttribute(this.svgElement, 'height', `${this.svgHeight}`);
    }
    /**
     * @private
     * @return {?}
     */
    removeTooltip() {
        if (this.tooltipElement) {
            this.renderer.addClass(this.tooltipElement, 'thf-invisible');
        }
    }
    /**
     * @private
     * @return {?}
     */
    removeWindowResizeListener() {
        if (this.windowResizeListener) {
            this.windowResizeListener();
        }
    }
    /**
     * @private
     * @return {?}
     */
    removeWindowScrollListener() {
        if (this.windowScrollListener) {
            this.windowScrollListener();
        }
    }
    /**
     * @private
     * @return {?}
     */
    setEventListeners() {
        /** @type {?} */
        let chartSeries = this.el.nativeElement.querySelectorAll('.thf-path-item');
        chartSeries = Array.from(chartSeries);
        chartSeries.forEach((/**
         * @param {?} serie
         * @return {?}
         */
        serie => {
            this.renderer.listen(serie, 'click', this.onMouseClick.bind(this));
            this.renderer.listen(serie, 'mouseenter', this.onMouseEnter.bind(this));
            this.renderer.listen(serie, 'mousemove', this.changeTooltipPosition.bind(this));
            this.renderer.listen(serie, 'mouseleave', this.removeTooltip.bind(this));
        }));
        this.windowResizeListener = this.renderer.listen(window, 'resize', this.onWindowResize.bind(this));
        this.windowScrollListener = this.renderer.listen(this.checkingIfScrollsWithThfPage(), 'scroll', this.removeTooltip.bind(this));
    }
    /**
     * @private
     * @return {?}
     */
    checkingIfScrollsWithThfPage() {
        /** @type {?} */
        const thfPageContent = document.getElementsByClassName('thf-page-content');
        return thfPageContent.length ? thfPageContent[0] : window;
    }
    /**
     * @private
     * @param {?} event
     * @return {?}
     */
    setTooltipPositions(event) {
        /** @type {?} */
        const displacement = 8;
        return {
            left: event.clientX - this.tooltipElement.offsetWidth / 2,
            top: event.clientY - this.tooltipElement.offsetHeight - displacement
        };
    }
    /**
     * @private
     * @return {?}
     */
    showTooltip() {
        this.renderer.removeClass(this.tooltipElement, 'thf-invisible');
    }
}
ThfChartPieComponent.decorators = [
    { type: Component, args: [{
                selector: 'thf-chart-pie',
                template: "<div #chartBody class=\"thf-chart-body\">\n  <div #svgContainer class=\"thf-chart-svg-container\"></div>\n  <div class=\"thf-chart-tooltip thf-tooltip thf-invisible\">\n    <div class=\"thf-tooltip-arrow thf-arrow-bottom\"></div>\n    <div class=\"thf-tooltip-content\">{{ tooltipText }}</div>\n  </div>\n</div>"
            }] }
];
/** @nocollapse */
ThfChartPieComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: NgZone },
    { type: Renderer2 }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    ThfChartPieComponent.prototype.animationRunning;
    /**
     * @type {?}
     * @private
     */
    ThfChartPieComponent.prototype.chartItemEndAngle;
    /**
     * @type {?}
     * @private
     */
    ThfChartPieComponent.prototype.chartItemStartAngle;
    /**
     * @type {?}
     * @private
     */
    ThfChartPieComponent.prototype.chartItemsEndAngleList;
    /**
     * @type {?}
     * @private
     */
    ThfChartPieComponent.prototype.svgPathElementsList;
    /**
     * @type {?}
     * @private
     */
    ThfChartPieComponent.prototype.el;
    /**
     * @type {?}
     * @private
     */
    ThfChartPieComponent.prototype.ngZone;
    /**
     * @type {?}
     * @private
     */
    ThfChartPieComponent.prototype.renderer;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGhmLWNoYXJ0LXBpZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdG90dnMvdGhmLXVpLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvdGhmLWNoYXJ0L3RoZi1jaGFydC10eXBlcy90aGYtY2hhcnQtcGllL3RoZi1jaGFydC1waWUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQXFCLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUU1RixPQUFPLEVBQUUseUJBQXlCLEVBQUUsc0JBQXNCLEVBQUUsZUFBZSxFQUFFLGtCQUFrQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDbEksT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFPbkYsTUFBTSxPQUFPLG9CQUFxQixTQUFRLDRCQUE0Qjs7Ozs7O0lBWXBFLFlBQW9CLEVBQWMsRUFBVSxNQUFjLEVBQVUsUUFBbUI7UUFDckYsS0FBSyxFQUFFLENBQUM7UUFEVSxPQUFFLEdBQUYsRUFBRSxDQUFZO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUFVLGFBQVEsR0FBUixRQUFRLENBQVc7UUFQL0UsMkJBQXNCLEdBQWtCLEVBQUUsQ0FBQztRQUMzQyx3QkFBbUIsR0FBa0IsRUFBRSxDQUFDO0lBUWhELENBQUM7Ozs7Ozs7SUFOTyxNQUFNLENBQUMsaUJBQWlCLENBQUMsS0FBYSxFQUFFLFVBQWtCO1FBQ2hFLE9BQU8sS0FBSyxHQUFHLFVBQVUsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDNUMsQ0FBQzs7OztJQU1ELFdBQVc7UUFDVCxJQUFJLENBQUMsMEJBQTBCLEVBQUUsQ0FBQztRQUNsQyxJQUFJLENBQUMsMEJBQTBCLEVBQUUsQ0FBQztRQUNsQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsS0FBSyxDQUFDO0lBQ2hDLENBQUM7Ozs7SUFFRCxRQUFRO1FBQ04sSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO0lBQzNCLENBQUM7Ozs7O0lBRU8sY0FBYztRQUNwQixJQUFJLENBQUMsbUJBQW1CLEdBQUcsa0JBQWtCLENBQUM7UUFDOUMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4RCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO1FBQzdCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUN0QixDQUFDOzs7OztJQUVPLHFCQUFxQjtRQUMzQixJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU87Ozs7O1FBQUMsQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FDbkMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLEtBQUssQ0FBQyxHQUFHLG9CQUFvQixDQUFDLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUMxRyxDQUFDO0lBQ0osQ0FBQzs7Ozs7O0lBRU8sd0JBQXdCLENBQUMsb0JBQTRCOztjQUNyRCxvQkFBb0IsR0FBRyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsb0JBQW9CLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksQ0FBQyxpQkFBaUI7UUFFaEksSUFBSSxvQkFBb0IsRUFBRTtZQUN4QixPQUFPLENBQUMsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLHNCQUFzQixDQUFDO1NBQ3JGO2FBQU07WUFDTCxPQUFPLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxvQkFBb0IsQ0FBQztTQUN4RDtJQUNILENBQUM7Ozs7OztJQUVPLHFCQUFxQixDQUFDLEtBQWlCO1FBQzdDLElBQUksSUFBSSxDQUFDLGNBQWMsSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUFDLEVBQUU7WUFDbEYsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1NBQ3BCOztjQUVLLGdCQUFnQixHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxLQUFLLENBQUM7UUFDeEQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxNQUFNLEVBQUUsR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDO1FBQ2xGLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsS0FBSyxFQUFFLEdBQUcsZ0JBQWdCLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQztJQUNsRixDQUFDOzs7OztJQUVPLGNBQWM7UUFDcEIsSUFBSSxDQUFDLCtCQUErQixDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDNUYsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLHFCQUFxQixFQUFFLENBQUM7UUFDN0IsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFDekIsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO0lBQ3hCLENBQUM7Ozs7Ozs7O0lBRU8sVUFBVSxDQUFDLEtBQWEsRUFBRSxLQUF3QixFQUFFLGVBQW9COztjQUN4RSxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQztRQUU5RCxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLGVBQWUsQ0FBQyxDQUFDO1FBQzlELElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQ2hFLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDN0UsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLG9CQUFvQixFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztRQUNsRixJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsS0FBSyxDQUFDLE9BQU8sSUFBSSxHQUFHLEtBQUssQ0FBQyxRQUFRLEtBQUssS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7UUFFL0csZUFBZSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUVyQyxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLGVBQWUsQ0FBQyxDQUFDO1FBQzVELElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDekMsQ0FBQzs7Ozs7SUFFTyxXQUFXOztjQUNYLGVBQWUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDO1FBRW5FLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTzs7Ozs7UUFBQyxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLEtBQUssRUFBRSxlQUFlLENBQUMsRUFBQyxDQUFDO0lBQ3hGLENBQUM7Ozs7O0lBRU8saUJBQWlCO1FBQ3ZCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRWhFLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsU0FBUyxFQUFFLE9BQU8sSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsT0FBTyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDdkcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxxQkFBcUIsRUFBRSxlQUFlLENBQUMsQ0FBQztRQUNwRixJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLE9BQU8sRUFBRSx1QkFBdUIsQ0FBQyxDQUFDO1FBQzlFLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsT0FBTyxFQUFFLEdBQUcsSUFBSSxDQUFDLFlBQVksR0FBRyxlQUFlLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNuRyxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLFFBQVEsRUFBRSxHQUFHLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDO1FBRTNFLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFN0QsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3JCLENBQUM7Ozs7Ozs7O0lBRU8sUUFBUSxDQUFDLElBQUksRUFBRSxtQkFBbUIsRUFBRSxpQkFBaUI7O2NBRXJELFFBQVEsR0FBRyxDQUFDLGlCQUFpQixHQUFHLG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzs7Y0FDdEYsTUFBTSxHQUFHLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHLElBQUksQ0FBQyxPQUFPOztjQUNwRSxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDLEdBQUcsSUFBSSxDQUFDLE9BQU87O2NBQ3BFLElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsR0FBRyxJQUFJLENBQUMsT0FBTzs7Y0FDaEUsSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLElBQUksQ0FBQyxPQUFPOztjQUVoRSxlQUFlLEdBQUc7WUFDdEIsR0FBRyxFQUFFLE1BQU0sRUFBRSxNQUFNO1lBQ25CLEdBQUcsRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUk7WUFDM0QsR0FBRyxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87WUFDL0IsR0FBRztTQUNKLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztRQUVYLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUUsZUFBZSxDQUFDLENBQUM7SUFDakQsQ0FBQzs7Ozs7SUFFTyxZQUFZO1FBRWxCLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7WUFDMUIsT0FBTztTQUNSO2FBQU07WUFDTCxJQUFJLENBQUMsTUFBTSxDQUFDLGlCQUFpQjs7O1lBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxFQUFDLENBQUM7U0FDeEQ7SUFDSCxDQUFDOzs7Ozs7O0lBRU8sVUFBVSxDQUFDLG9CQUE0QixDQUFDLEVBQUUsdUJBQStCLENBQUM7O2NBQzFFLDhCQUE4QixHQUFHLG9CQUFvQixHQUFHLElBQUksQ0FBQyxpQkFBaUI7O2NBQzlFLDBCQUEwQixHQUFHLGlCQUFpQixLQUFLLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNO1FBRXhGLElBQUssMEJBQTBCLEVBQUc7WUFDaEMsT0FBTztTQUNSO1FBRUQsSUFBSyw4QkFBOEIsRUFBRztZQUVwQyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQztZQUM3RSxpQkFBaUIsRUFBRSxDQUFDO1lBQ3BCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsaUJBQWlCLENBQUMsQ0FBQztZQUN4RSxvQkFBb0IsR0FBRyxDQUFDLENBQUM7U0FFMUI7YUFBTTtZQUNMLG9CQUFvQixJQUFJLHlCQUF5QixDQUFDO1lBRWxELElBQUksQ0FBQyxRQUFRLENBQ1gsSUFBSSxDQUFDLG1CQUFtQixDQUFDLGlCQUFpQixDQUFDLEVBQzNDLElBQUksQ0FBQyxtQkFBbUIsRUFDeEIsSUFBSSxDQUFDLHdCQUF3QixDQUFDLG9CQUFvQixDQUFDLENBQ3BELENBQUM7U0FDSDtRQUVELE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsaUJBQWlCLEVBQUUsb0JBQW9CLENBQUMsQ0FBQyxDQUFDO0lBRXBHLENBQUM7Ozs7OztJQUVPLGdCQUFnQixDQUFDLEtBQXdCO1FBQy9DLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2hDLENBQUM7Ozs7O0lBRU8sWUFBWTs7Y0FDWixZQUFZLEdBQXNCLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixFQUFFO1FBRTlHLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7Ozs7OztJQUVPLFlBQVksQ0FBQyxLQUFLO1FBQ3hCLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDO1FBQzdELElBQUksQ0FBQyxvQkFBb0IsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsdUJBQXVCLENBQUMsQ0FBQztRQUN2RixJQUFJLENBQUMsaUJBQWlCLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLG9CQUFvQixDQUFDLENBQUM7UUFDakYsSUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsbUJBQW1CLENBQUMsQ0FBQztRQUMxRSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLHFCQUFxQixDQUFDLEtBQUssQ0FBQyxDQUFDOztjQUU1QixZQUFZLEdBQUcsRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLG9CQUFvQixFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsaUJBQWlCLEVBQUU7UUFDM0YsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQ3RDLENBQUM7Ozs7O0lBRU8sY0FBYztRQUNwQixJQUFJLENBQUMsK0JBQStCLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUM1RixJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQyxZQUFZLEdBQUcsZUFBZSxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDbkcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxRQUFRLEVBQUUsR0FBRyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQztJQUM3RSxDQUFDOzs7OztJQUVPLGFBQWE7UUFDbkIsSUFBSSxJQUFJLENBQUMsY0FBYyxFQUFFO1lBQ3ZCLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsZUFBZSxDQUFDLENBQUM7U0FDOUQ7SUFDSCxDQUFDOzs7OztJQUVPLDBCQUEwQjtRQUNoQyxJQUFJLElBQUksQ0FBQyxvQkFBb0IsRUFBRTtZQUM3QixJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztTQUM3QjtJQUNILENBQUM7Ozs7O0lBRU8sMEJBQTBCO1FBQ2hDLElBQUksSUFBSSxDQUFDLG9CQUFvQixFQUFFO1lBQzdCLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1NBQzdCO0lBQ0gsQ0FBQzs7Ozs7SUFFTyxpQkFBaUI7O1lBQ25CLFdBQVcsR0FBa0IsSUFBSSxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUMsZ0JBQWdCLENBQUMsZ0JBQWdCLENBQUM7UUFDekYsV0FBVyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFdEMsV0FBVyxDQUFDLE9BQU87Ozs7UUFBQyxLQUFLLENBQUMsRUFBRTtZQUMxQixJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDbkUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLFlBQVksRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3hFLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxXQUFXLEVBQUUsSUFBSSxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ2hGLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxZQUFZLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUMzRSxDQUFDLEVBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDbkcsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyw0QkFBNEIsRUFBRSxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ2pJLENBQUM7Ozs7O0lBRU8sNEJBQTRCOztjQUM1QixjQUFjLEdBQUcsUUFBUSxDQUFDLHNCQUFzQixDQUFDLGtCQUFrQixDQUFDO1FBRTFFLE9BQU8sY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDNUQsQ0FBQzs7Ozs7O0lBRU8sbUJBQW1CLENBQUMsS0FBaUI7O2NBQ3JDLFlBQVksR0FBVyxDQUFDO1FBRTlCLE9BQU87WUFDTCxJQUFJLEVBQUUsS0FBSyxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLFdBQVcsR0FBRyxDQUFDO1lBQ3pELEdBQUcsRUFBRSxLQUFLLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsWUFBWSxHQUFHLFlBQVk7U0FDckUsQ0FBQztJQUNKLENBQUM7Ozs7O0lBRU8sV0FBVztRQUNqQixJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLGVBQWUsQ0FBQyxDQUFDO0lBQ2xFLENBQUM7OztZQWpQRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLGVBQWU7Z0JBQ3pCLG1VQUE2QzthQUM5Qzs7OztZQVRtQixVQUFVO1lBQUUsTUFBTTtZQUFxQixTQUFTOzs7Ozs7O0lBWWxFLGdEQUFrQzs7Ozs7SUFDbEMsaURBQWtDOzs7OztJQUNsQyxtREFBb0M7Ozs7O0lBQ3BDLHNEQUFtRDs7Ozs7SUFDbkQsbURBQWdEOzs7OztJQU1wQyxrQ0FBc0I7Ozs7O0lBQUUsc0NBQXNCOzs7OztJQUFFLHdDQUEyQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgRWxlbWVudFJlZiwgTmdab25lLCBPbkRlc3Ryb3ksIE9uSW5pdCwgUmVuZGVyZXIyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IHRoZkNoYXJ0QW5nbGVTdGVwSW50ZXJ2YWwsIHRoZkNoYXJ0Q29tcGxldGVDaXJjbGUsIHRoZkNoYXJ0UGFkZGluZywgdGhmQ2hhcnRTdGFydEFuZ2xlIH0gZnJvbSAnLi90aGYtY2hhcnQtcGllLmNvbnN0YW50JztcbmltcG9ydCB7IFRoZkNoYXJ0RHluYW1pY1R5cGVDb21wb25lbnQgfSBmcm9tICcuLi90aGYtY2hhcnQtZHluYW1pYy10eXBlLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBUaGZQaWVDaGFydFNlcmllcyB9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvdGhmLWNoYXJ0LXNlcmllcy5pbnRlcmZhY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICd0aGYtY2hhcnQtcGllJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3RoZi1jaGFydC1waWUuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFRoZkNoYXJ0UGllQ29tcG9uZW50IGV4dGVuZHMgVGhmQ2hhcnREeW5hbWljVHlwZUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uRGVzdHJveSwgT25Jbml0IHtcblxuICBwcml2YXRlIGFuaW1hdGlvblJ1bm5pbmc6IGJvb2xlYW47XG4gIHByaXZhdGUgY2hhcnRJdGVtRW5kQW5nbGU6IG51bWJlcjtcbiAgcHJpdmF0ZSBjaGFydEl0ZW1TdGFydEFuZ2xlOiBudW1iZXI7XG4gIHByaXZhdGUgY2hhcnRJdGVtc0VuZEFuZ2xlTGlzdDogQXJyYXk8bnVtYmVyPiA9IFtdO1xuICBwcml2YXRlIHN2Z1BhdGhFbGVtZW50c0xpc3Q6IEFycmF5PHN0cmluZz4gPSBbXTtcblxuICBwcml2YXRlIHN0YXRpYyBjYWxjdWxhdGVFbmRBbmdsZSh2YWx1ZTogbnVtYmVyLCB0b3RhbFZhbHVlOiBudW1iZXIpOiBudW1iZXIge1xuICAgIHJldHVybiB2YWx1ZSAvIHRvdGFsVmFsdWUgKiAoTWF0aC5QSSAqIDIpO1xuICB9XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBlbDogRWxlbWVudFJlZiwgcHJpdmF0ZSBuZ1pvbmU6IE5nWm9uZSwgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMucmVtb3ZlV2luZG93UmVzaXplTGlzdGVuZXIoKTtcbiAgICB0aGlzLnJlbW92ZVdpbmRvd1Njcm9sbExpc3RlbmVyKCk7XG4gICAgdGhpcy5hbmltYXRpb25SdW5uaW5nID0gZmFsc2U7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmNoYXJ0SW5pdFNldHVwKCk7XG4gICAgdGhpcy5zZXRFdmVudExpc3RlbmVycygpO1xuICB9XG5cbiAgcHJpdmF0ZSBhbmltYXRpb25TZXR1cCgpIHtcbiAgICB0aGlzLmNoYXJ0SXRlbVN0YXJ0QW5nbGUgPSB0aGZDaGFydFN0YXJ0QW5nbGU7XG4gICAgdGhpcy5jaGFydEl0ZW1FbmRBbmdsZSA9IHRoaXMuY2hhcnRJdGVtc0VuZEFuZ2xlTGlzdFswXTtcbiAgICB0aGlzLmFuaW1hdGlvblJ1bm5pbmcgPSB0cnVlO1xuICAgIHRoaXMuZHJhd1BhdGhJbml0KCk7XG4gIH1cblxuICBwcml2YXRlIGNhbGN1bGF0ZUFuZ2xlUmFkaWFucygpIHtcbiAgICB0aGlzLnNlcmllcy5mb3JFYWNoKChzZXJpZSwgaW5kZXgpID0+XG4gICAgICB0aGlzLmNoYXJ0SXRlbXNFbmRBbmdsZUxpc3RbaW5kZXhdID0gVGhmQ2hhcnRQaWVDb21wb25lbnQuY2FsY3VsYXRlRW5kQW5nbGUoc2VyaWUudmFsdWUsIHRoaXMudG90YWxWYWx1ZSlcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBjYWxjdWxhdGVDdXJyZW50RW5kQW5nbGUoYW5nbGVDdXJyZW50UG9zaXRpb246IG51bWJlcikge1xuICAgIGNvbnN0IGlzU2VyaWVEcmF3Q29tcGxldGVkID0gdGhpcy5jaGFydEl0ZW1TdGFydEFuZ2xlICsgYW5nbGVDdXJyZW50UG9zaXRpb24gPiB0aGlzLmNoYXJ0SXRlbVN0YXJ0QW5nbGUgKyB0aGlzLmNoYXJ0SXRlbUVuZEFuZ2xlO1xuXG4gICAgaWYgKGlzU2VyaWVEcmF3Q29tcGxldGVkKSB7XG4gICAgICByZXR1cm4gKHRoaXMuY2hhcnRJdGVtU3RhcnRBbmdsZSArIHRoaXMuY2hhcnRJdGVtRW5kQW5nbGUpIC0gdGhmQ2hhcnRDb21wbGV0ZUNpcmNsZTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMuY2hhcnRJdGVtU3RhcnRBbmdsZSArIGFuZ2xlQ3VycmVudFBvc2l0aW9uO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY2hhbmdlVG9vbHRpcFBvc2l0aW9uKGV2ZW50OiBNb3VzZUV2ZW50KSB7XG4gICAgaWYgKHRoaXMudG9vbHRpcEVsZW1lbnQgJiYgdGhpcy50b29sdGlwRWxlbWVudC5jbGFzc0xpc3QuY29udGFpbnMoJ3RoZi1pbnZpc2libGUnKSkge1xuICAgICAgdGhpcy5zaG93VG9vbHRpcCgpO1xuICAgIH1cblxuICAgIGNvbnN0IHRvb2x0aXBQb3NpdGlvbnMgPSB0aGlzLnNldFRvb2x0aXBQb3NpdGlvbnMoZXZlbnQpO1xuICAgIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUodGhpcy50b29sdGlwRWxlbWVudCwgJ2xlZnQnLCBgJHt0b29sdGlwUG9zaXRpb25zLmxlZnR9cHhgKTtcbiAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKHRoaXMudG9vbHRpcEVsZW1lbnQsICd0b3AnLCBgJHt0b29sdGlwUG9zaXRpb25zLnRvcH1weGApO1xuICB9XG5cbiAgcHJpdmF0ZSBjaGFydEluaXRTZXR1cCgpIHtcbiAgICB0aGlzLmNhbGN1bGF0ZVNWR0NvbnRhaW5lckRpbWVuc2lvbnModGhpcy5jaGFydFdyYXBwZXIsIHRoaXMuY2hhcnRIZWFkZXIsIHRoaXMuY2hhcnRMZWdlbmQpO1xuICAgIHRoaXMuY2FsY3VsYXRlVG90YWxWYWx1ZSgpO1xuICAgIHRoaXMuY2FsY3VsYXRlQW5nbGVSYWRpYW5zKCk7XG4gICAgdGhpcy5jcmVhdGVTVkdFbGVtZW50cygpO1xuICAgIHRoaXMuYW5pbWF0aW9uU2V0dXAoKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUGF0aChpbmRleDogbnVtYmVyLCBzZXJpZTogVGhmUGllQ2hhcnRTZXJpZXMsIHN2Z1BhdGhzV3JhcHBlcjogYW55KSB7XG4gICAgY29uc3Qgc3ZnUGF0aCA9IHRoaXMucmVuZGVyZXIuY3JlYXRlRWxlbWVudCgnc3ZnOnBhdGgnLCAnc3ZnJyk7XG5cbiAgICB0aGlzLnJlbmRlcmVyLnNldEF0dHJpYnV0ZShzdmdQYXRoLCAnY2xhc3MnLCAndGhmLXBhdGgtaXRlbScpO1xuICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKHN2Z1BhdGgsICdmaWxsJywgdGhpcy5jb2xvcnNbaW5kZXhdKTtcbiAgICB0aGlzLnJlbmRlcmVyLnNldEF0dHJpYnV0ZShzdmdQYXRoLCAnZGF0YS10b29sdGlwLWNhdGVnb3J5Jywgc2VyaWUuY2F0ZWdvcnkpO1xuICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKHN2Z1BhdGgsICdkYXRhLXRvb2x0aXAtdmFsdWUnLCBzZXJpZS52YWx1ZS50b1N0cmluZygpKTtcbiAgICB0aGlzLnJlbmRlcmVyLnNldEF0dHJpYnV0ZShzdmdQYXRoLCAnZGF0YS10b29sdGlwLXRleHQnLCBzZXJpZS50b29sdGlwIHx8IGAke3NlcmllLmNhdGVnb3J5fTogJHtzZXJpZS52YWx1ZX1gKTtcblxuICAgIHN2Z1BhdGhzV3JhcHBlci5hcHBlbmRDaGlsZChzdmdQYXRoKTtcblxuICAgIHRoaXMucmVuZGVyZXIuYXBwZW5kQ2hpbGQodGhpcy5zdmdFbGVtZW50LCBzdmdQYXRoc1dyYXBwZXIpO1xuICAgIHRoaXMuc3ZnUGF0aEVsZW1lbnRzTGlzdC5wdXNoKHN2Z1BhdGgpO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVQYXRocygpIHtcbiAgICBjb25zdCBzdmdQYXRoc1dyYXBwZXIgPSB0aGlzLnJlbmRlcmVyLmNyZWF0ZUVsZW1lbnQoJ3N2ZzpnJywgJ3N2ZycpO1xuXG4gICAgdGhpcy5zZXJpZXMuZm9yRWFjaCgoc2VyaWUsIGluZGV4KSA9PiB0aGlzLmNyZWF0ZVBhdGgoaW5kZXgsIHNlcmllLCBzdmdQYXRoc1dyYXBwZXIpKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlU1ZHRWxlbWVudHMoKSB7XG4gICAgdGhpcy5zdmdFbGVtZW50ID0gdGhpcy5yZW5kZXJlci5jcmVhdGVFbGVtZW50KCdzdmc6c3ZnJywgJ3N2ZycpO1xuXG4gICAgdGhpcy5yZW5kZXJlci5zZXRBdHRyaWJ1dGUodGhpcy5zdmdFbGVtZW50LCAndmlld0JveCcsIGAwIDAgJHt0aGlzLmNoYXJ0V3JhcHBlcn0gJHt0aGlzLmNlbnRlclggKiAyfWApO1xuICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKHRoaXMuc3ZnRWxlbWVudCwgJ3ByZXNlcnZlQXNwZWN0UmF0aW8nLCAneE1pZFlNaW4gbWVldCcpO1xuICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKHRoaXMuc3ZnRWxlbWVudCwgJ2NsYXNzJywgJ3RoZi1jaGFydC1zdmctZWxlbWVudCcpO1xuICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKHRoaXMuc3ZnRWxlbWVudCwgJ3dpZHRoJywgYCR7dGhpcy5jaGFydFdyYXBwZXIgLSB0aGZDaGFydFBhZGRpbmcgKiAyfWApO1xuICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKHRoaXMuc3ZnRWxlbWVudCwgJ2hlaWdodCcsIGAke3RoaXMuc3ZnSGVpZ2h0fWApO1xuXG4gICAgdGhpcy5zdmdDb250YWluZXIubmF0aXZlRWxlbWVudC5hcHBlbmRDaGlsZCh0aGlzLnN2Z0VsZW1lbnQpO1xuXG4gICAgdGhpcy5jcmVhdGVQYXRocygpO1xuICB9XG5cbiAgcHJpdmF0ZSBkcmF3UGF0aChwYXRoLCBjaGFydEl0ZW1TdGFydEFuZ2xlLCBjaGFydEl0ZW1FbmRBbmdsZSkge1xuXG4gICAgY29uc3QgbGFyZ2VBcmMgPSAoY2hhcnRJdGVtRW5kQW5nbGUgLSBjaGFydEl0ZW1TdGFydEFuZ2xlKSAlIChNYXRoLlBJICogMikgPiBNYXRoLlBJID8gMSA6IDA7XG4gICAgY29uc3Qgc3RhcnRYID0gdGhpcy5jZW50ZXJYICsgTWF0aC5jb3MoY2hhcnRJdGVtU3RhcnRBbmdsZSkgKiB0aGlzLmNlbnRlclg7XG4gICAgY29uc3Qgc3RhcnRZID0gdGhpcy5jZW50ZXJYICsgTWF0aC5zaW4oY2hhcnRJdGVtU3RhcnRBbmdsZSkgKiB0aGlzLmNlbnRlclg7XG4gICAgY29uc3QgZW5kWCA9IHRoaXMuY2VudGVyWCArIE1hdGguY29zKGNoYXJ0SXRlbUVuZEFuZ2xlKSAqIHRoaXMuY2VudGVyWDtcbiAgICBjb25zdCBlbmRZID0gdGhpcy5jZW50ZXJYICsgTWF0aC5zaW4oY2hhcnRJdGVtRW5kQW5nbGUpICogdGhpcy5jZW50ZXJYO1xuXG4gICAgY29uc3QgcGF0aENvb3JkaW5hdGVzID0gW1xuICAgICAgJ00nLCBzdGFydFgsIHN0YXJ0WSxcbiAgICAgICdBJywgdGhpcy5jZW50ZXJYLCB0aGlzLmNlbnRlclgsIDAsIGxhcmdlQXJjLCAxLCBlbmRYLCBlbmRZLFxuICAgICAgJ0wnLCB0aGlzLmNlbnRlclgsIHRoaXMuY2VudGVyWCxcbiAgICAgICdaJ1xuICAgIF0uam9pbignICcpO1xuXG4gICAgcmV0dXJuIHBhdGguc2V0QXR0cmlidXRlKCdkJywgcGF0aENvb3JkaW5hdGVzKTtcbiAgfVxuXG4gIHByaXZhdGUgZHJhd1BhdGhJbml0KCkge1xuXG4gICAgaWYgKCF0aGlzLmFuaW1hdGlvblJ1bm5pbmcpIHtcbiAgICAgIHJldHVybjtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4gdGhpcy5kcmF3U2VyaWVzKCkpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZHJhd1NlcmllcyhjdXJyZW50U2VyaWVJbmRleDogbnVtYmVyID0gMCwgYW5nbGVDdXJyZW50UG9zaXRpb246IG51bWJlciA9IDApIHtcbiAgICBjb25zdCBpc0ZpbmlzaGVkRHJhd2luZ0N1cnJlbnRTZXJpZXMgPSBhbmdsZUN1cnJlbnRQb3NpdGlvbiA+IHRoaXMuY2hhcnRJdGVtRW5kQW5nbGU7XG4gICAgY29uc3QgaXNGaW5pc2hlZERyYXdpbmdBbGxTZXJpZXMgPSBjdXJyZW50U2VyaWVJbmRleCA9PT0gdGhpcy5zdmdQYXRoRWxlbWVudHNMaXN0Lmxlbmd0aDtcblxuICAgIGlmICggaXNGaW5pc2hlZERyYXdpbmdBbGxTZXJpZXMgKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKCBpc0ZpbmlzaGVkRHJhd2luZ0N1cnJlbnRTZXJpZXMgKSB7XG5cbiAgICAgIHRoaXMuY2hhcnRJdGVtU3RhcnRBbmdsZSA9IHRoaXMuY2hhcnRJdGVtU3RhcnRBbmdsZSArIHRoaXMuY2hhcnRJdGVtRW5kQW5nbGU7XG4gICAgICBjdXJyZW50U2VyaWVJbmRleCsrO1xuICAgICAgdGhpcy5jaGFydEl0ZW1FbmRBbmdsZSA9IHRoaXMuY2hhcnRJdGVtc0VuZEFuZ2xlTGlzdFtjdXJyZW50U2VyaWVJbmRleF07XG4gICAgICBhbmdsZUN1cnJlbnRQb3NpdGlvbiA9IDA7XG5cbiAgICB9IGVsc2Uge1xuICAgICAgYW5nbGVDdXJyZW50UG9zaXRpb24gKz0gdGhmQ2hhcnRBbmdsZVN0ZXBJbnRlcnZhbDtcblxuICAgICAgdGhpcy5kcmF3UGF0aChcbiAgICAgICAgdGhpcy5zdmdQYXRoRWxlbWVudHNMaXN0W2N1cnJlbnRTZXJpZUluZGV4XSxcbiAgICAgICAgdGhpcy5jaGFydEl0ZW1TdGFydEFuZ2xlLFxuICAgICAgICB0aGlzLmNhbGN1bGF0ZUN1cnJlbnRFbmRBbmdsZShhbmdsZUN1cnJlbnRQb3NpdGlvbilcbiAgICAgICk7XG4gICAgfVxuXG4gICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSh0aGlzLmRyYXdTZXJpZXMuYmluZCh0aGlzLCBjdXJyZW50U2VyaWVJbmRleCwgYW5nbGVDdXJyZW50UG9zaXRpb24pKTtcblxuICB9XG5cbiAgcHJpdmF0ZSBlbWl0RXZlbnRPbkVudGVyKGV2ZW50OiBUaGZQaWVDaGFydFNlcmllcykge1xuICAgIHRoaXMub25TZXJpZUhvdmVyLm5leHQoZXZlbnQpO1xuICB9XG5cbiAgcHJpdmF0ZSBvbk1vdXNlQ2xpY2soKSB7XG4gICAgY29uc3Qgc2VyaWVPbkNsaWNrOiBUaGZQaWVDaGFydFNlcmllcyA9IHsgY2F0ZWdvcnk6IHRoaXMuY2hhcnRFbGVtZW50Q2F0ZWdvcnksIHZhbHVlOiB0aGlzLmNoYXJ0RWxlbWVudFZhbHVlIH07XG5cbiAgICB0aGlzLm9uU2VyaWVDbGljay5uZXh0KHNlcmllT25DbGljayk7XG4gIH1cblxuICBwcml2YXRlIG9uTW91c2VFbnRlcihldmVudCkge1xuICAgIHRoaXMudG9vbHRpcEVsZW1lbnQgPSB0aGlzLmNoYXJ0Qm9keS5uYXRpdmVFbGVtZW50Lmxhc3RDaGlsZDtcbiAgICB0aGlzLmNoYXJ0RWxlbWVudENhdGVnb3J5ID0gZXZlbnQudGFyZ2V0LmdldEF0dHJpYnV0ZU5TKG51bGwsICdkYXRhLXRvb2x0aXAtY2F0ZWdvcnknKTtcbiAgICB0aGlzLmNoYXJ0RWxlbWVudFZhbHVlID0gZXZlbnQudGFyZ2V0LmdldEF0dHJpYnV0ZU5TKG51bGwsICdkYXRhLXRvb2x0aXAtdmFsdWUnKTtcbiAgICB0aGlzLnRvb2x0aXBUZXh0ID0gZXZlbnQudGFyZ2V0LmdldEF0dHJpYnV0ZU5TKG51bGwsICdkYXRhLXRvb2x0aXAtdGV4dCcpO1xuICAgIHRoaXMuc2hvd1Rvb2x0aXAoKTtcbiAgICB0aGlzLmNoYW5nZVRvb2x0aXBQb3NpdGlvbihldmVudCk7XG5cbiAgICBjb25zdCBzZXJpZU9uRW50ZXIgPSB7IGNhdGVnb3J5OiB0aGlzLmNoYXJ0RWxlbWVudENhdGVnb3J5LCB2YWx1ZTogdGhpcy5jaGFydEVsZW1lbnRWYWx1ZSB9O1xuICAgIHRoaXMuZW1pdEV2ZW50T25FbnRlcihzZXJpZU9uRW50ZXIpO1xuICB9XG5cbiAgcHJpdmF0ZSBvbldpbmRvd1Jlc2l6ZSgpIHtcbiAgICB0aGlzLmNhbGN1bGF0ZVNWR0NvbnRhaW5lckRpbWVuc2lvbnModGhpcy5jaGFydFdyYXBwZXIsIHRoaXMuY2hhcnRIZWFkZXIsIHRoaXMuY2hhcnRMZWdlbmQpO1xuICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKHRoaXMuc3ZnRWxlbWVudCwgJ3dpZHRoJywgYCR7dGhpcy5jaGFydFdyYXBwZXIgLSB0aGZDaGFydFBhZGRpbmcgKiAyfWApO1xuICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKHRoaXMuc3ZnRWxlbWVudCwgJ2hlaWdodCcsIGAke3RoaXMuc3ZnSGVpZ2h0fWApO1xuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVUb29sdGlwKCkge1xuICAgIGlmICh0aGlzLnRvb2x0aXBFbGVtZW50KSB7XG4gICAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKHRoaXMudG9vbHRpcEVsZW1lbnQsICd0aGYtaW52aXNpYmxlJyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVXaW5kb3dSZXNpemVMaXN0ZW5lcigpIHtcbiAgICBpZiAodGhpcy53aW5kb3dSZXNpemVMaXN0ZW5lcikge1xuICAgICAgdGhpcy53aW5kb3dSZXNpemVMaXN0ZW5lcigpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlV2luZG93U2Nyb2xsTGlzdGVuZXIoKSB7XG4gICAgaWYgKHRoaXMud2luZG93U2Nyb2xsTGlzdGVuZXIpIHtcbiAgICAgIHRoaXMud2luZG93U2Nyb2xsTGlzdGVuZXIoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNldEV2ZW50TGlzdGVuZXJzKCkge1xuICAgIGxldCBjaGFydFNlcmllczogQXJyYXk8c3RyaW5nPiA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCcudGhmLXBhdGgtaXRlbScpO1xuICAgIGNoYXJ0U2VyaWVzID0gQXJyYXkuZnJvbShjaGFydFNlcmllcyk7XG5cbiAgICBjaGFydFNlcmllcy5mb3JFYWNoKHNlcmllID0+IHtcbiAgICAgIHRoaXMucmVuZGVyZXIubGlzdGVuKHNlcmllLCAnY2xpY2snLCB0aGlzLm9uTW91c2VDbGljay5iaW5kKHRoaXMpKTtcbiAgICAgIHRoaXMucmVuZGVyZXIubGlzdGVuKHNlcmllLCAnbW91c2VlbnRlcicsIHRoaXMub25Nb3VzZUVudGVyLmJpbmQodGhpcykpO1xuICAgICAgdGhpcy5yZW5kZXJlci5saXN0ZW4oc2VyaWUsICdtb3VzZW1vdmUnLCB0aGlzLmNoYW5nZVRvb2x0aXBQb3NpdGlvbi5iaW5kKHRoaXMpKTtcbiAgICAgIHRoaXMucmVuZGVyZXIubGlzdGVuKHNlcmllLCAnbW91c2VsZWF2ZScsIHRoaXMucmVtb3ZlVG9vbHRpcC5iaW5kKHRoaXMpKTtcbiAgICB9KTtcblxuICAgIHRoaXMud2luZG93UmVzaXplTGlzdGVuZXIgPSB0aGlzLnJlbmRlcmVyLmxpc3Rlbih3aW5kb3csICdyZXNpemUnLCB0aGlzLm9uV2luZG93UmVzaXplLmJpbmQodGhpcykpO1xuICAgIHRoaXMud2luZG93U2Nyb2xsTGlzdGVuZXIgPSB0aGlzLnJlbmRlcmVyLmxpc3Rlbih0aGlzLmNoZWNraW5nSWZTY3JvbGxzV2l0aFRoZlBhZ2UoKSwgJ3Njcm9sbCcsIHRoaXMucmVtb3ZlVG9vbHRpcC5iaW5kKHRoaXMpKTtcbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tpbmdJZlNjcm9sbHNXaXRoVGhmUGFnZSgpIHtcbiAgICBjb25zdCB0aGZQYWdlQ29udGVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ3RoZi1wYWdlLWNvbnRlbnQnKTtcblxuICAgIHJldHVybiB0aGZQYWdlQ29udGVudC5sZW5ndGggPyB0aGZQYWdlQ29udGVudFswXSA6IHdpbmRvdztcbiAgfVxuXG4gIHByaXZhdGUgc2V0VG9vbHRpcFBvc2l0aW9ucyhldmVudDogTW91c2VFdmVudCkge1xuICAgIGNvbnN0IGRpc3BsYWNlbWVudDogbnVtYmVyID0gODtcblxuICAgIHJldHVybiB7XG4gICAgICBsZWZ0OiBldmVudC5jbGllbnRYIC0gdGhpcy50b29sdGlwRWxlbWVudC5vZmZzZXRXaWR0aCAvIDIsXG4gICAgICB0b3A6IGV2ZW50LmNsaWVudFkgLSB0aGlzLnRvb2x0aXBFbGVtZW50Lm9mZnNldEhlaWdodCAtIGRpc3BsYWNlbWVudFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIHNob3dUb29sdGlwKCkge1xuICAgIHRoaXMucmVuZGVyZXIucmVtb3ZlQ2xhc3ModGhpcy50b29sdGlwRWxlbWVudCwgJ3RoZi1pbnZpc2libGUnKTtcbiAgfVxuXG59XG4iXX0=