/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, ElementRef, forwardRef, ViewChild } from '@angular/core';
import { NG_VALIDATORS, NG_VALUE_ACCESSOR } from '@angular/forms';
import { ThfUploadBaseComponent } from './thf-upload-base.component';
import { ThfUploadService } from './thf-upload.service';
import { ThfUploadStatus } from './thf-upload-status.enum';
/**
 * \@docsExtends ThfUploadBaseComponent
 *
 * \@example
 *
 * <example name="thf-upload-basic" title="Totvs Upload Basic">
 *   <file name="sample-thf-upload-basic/sample-thf-upload-basic.component.html"> </file>
 *   <file name="sample-thf-upload-basic/sample-thf-upload-basic.component.ts"> </file>
 * </example>
 *
 * <example name="thf-upload-labs" title="Totvs Upload Labs">
 *   <file name="sample-thf-upload-labs/sample-thf-upload-labs.component.html"> </file>
 *   <file name="sample-thf-upload-labs/sample-thf-upload-labs.component.ts"> </file>
 * </example>
 *
 * <example name="thf-upload-resume" title="Totvs Upload - Resume">
 *   <file name="sample-thf-upload-resume/sample-thf-upload-resume.component.html"> </file>
 *   <file name="sample-thf-upload-resume/sample-thf-upload-resume.component.ts"> </file>
 * </example>
 *
 * <example name="thf-upload-rs" title="Totvs Upload - Realize & Show">
 *   <file name="sample-thf-upload-rs/sample-thf-upload-rs.component.html"> </file>
 *   <file name="sample-thf-upload-rs/sample-thf-upload-rs.component.ts"> </file>
 * </example>
 */
export class ThfUploadComponent extends ThfUploadBaseComponent {
    /**
     * @param {?} elementRef
     * @param {?} uploadService
     */
    constructor(elementRef, uploadService) {
        super(uploadService);
        this.elementRef = elementRef;
        this.calledByCleanInputValue = false;
    }
    /**
     * @return {?}
     */
    get displaySendButton() {
        /** @type {?} */
        const currentFiles = this.currentFiles || [];
        return !this.hideSendButton && !this.autoUpload && (currentFiles.length > 0 && this.hasFileNotUploaded);
    }
    /**
     * @return {?}
     */
    get hasFileNotUploaded() {
        if (Array.isArray(this.currentFiles)) {
            return this.currentFiles.some((/**
             * @param {?} file
             * @return {?}
             */
            file => file.status !== ThfUploadStatus.Uploaded));
        }
        return false;
    }
    /**
     * @return {?}
     */
    get isDisabled() {
        /** @type {?} */
        const currentFiles = this.currentFiles || [];
        return this.hasAnyFileUploading(this.currentFiles) ||
            !this.url ||
            this.disabled ||
            this.isExceededFileLimit(currentFiles.length);
    }
    /**
     * Método responsável por **limpar** o(s) arquivo(s) selecionado(s).
     * @return {?}
     */
    clear() {
        this.currentFiles = undefined;
        this.updateModel([]);
        this.cleanInputValue();
    }
    // Função disparada ao selecionar algum arquivo.
    /**
     * @param {?} event
     * @return {?}
     */
    onFileChange(event) {
        // necessario este tratamento quando para IE, pois nele o change é disparado quando o campo é limpado também
        if (this.calledByCleanInputValue) {
            this.calledByCleanInputValue = false;
            return event.preventDefault();
        }
        /** @type {?} */
        const files = event.target.files;
        this.currentFiles = this.currentFiles || [];
        this.currentFiles = this.parseFiles(files);
        this.updateModel([...this.currentFiles]);
        if (this.autoUpload) {
            this.uploadFiles(this.currentFiles);
        }
        this.cleanInputValue();
    }
    // Remove o arquivo passado por parametro da lista dos arquivos correntes.
    /**
     * @param {?} file
     * @return {?}
     */
    removeFile(file) {
        /** @type {?} */
        const index = this.currentFiles.indexOf(file);
        this.currentFiles.splice(index, 1);
        this.updateModel([...this.currentFiles]);
    }
    /**
     * Método responsável por **abrir** a janela para seleção de arquivo(s).
     * @return {?}
     */
    selectFiles() {
        this.calledByCleanInputValue = false;
        this.inputFile.nativeElement.click();
    }
    /**
     * Método responsável por **enviar** o(s) arquivo(s) selecionado(s).
     * @return {?}
     */
    sendFiles() {
        if (this.currentFiles && this.currentFiles.length) {
            this.uploadFiles(this.currentFiles);
        }
    }
    // Retorna o tamanho do arquivo em KBytes.
    /**
     * @protected
     * @param {?} size
     * @return {?}
     */
    getFileSize(size) {
        /** @type {?} */
        let kbSize = 0;
        if (size) {
            kbSize = Math.ceil(size / 1024);
        }
        return `${kbSize} KB`;
    }
    // Retorna o thf-icon de acordo com o status do arquivo.
    /**
     * @protected
     * @param {?} file
     * @return {?}
     */
    getThfIcon(file) {
        switch (file.status) {
            case ThfUploadStatus.Uploaded:
                return 'thf-icon-ok';
            case ThfUploadStatus.Error:
                return 'thf-icon-close';
            case ThfUploadStatus.None:
                return 'thf-icon-info';
            case ThfUploadStatus.Uploading:
            default:
                return '';
        }
    }
    // Verifica se existe algum arquivo sendo enviado ao serviço.
    /**
     * @protected
     * @param {?} files
     * @return {?}
     */
    hasAnyFileUploading(files) {
        if (files && files.length) {
            return files.some((/**
             * @param {?} file
             * @return {?}
             */
            file => file.status === ThfUploadStatus.Uploading));
        }
        return false;
    }
    // Valida se o status passado por parâmetro é igual ao status do arquivo.
    /**
     * @protected
     * @param {?} status
     * @param {?} file
     * @return {?}
     */
    isStatusFile(status, file) {
        return file.status === ThfUploadStatus[status];
    }
    // Caso o componente estiver no modo AutoUpload, o arquivo também será removido da lista.
    /**
     * @protected
     * @param {?} file
     * @return {?}
     */
    stopUpload(file) {
        this.uploadService.stopRequestByFile(file, (/**
         * @return {?}
         */
        () => {
            if (this.autoUpload) {
                this.removeFile(file);
            }
            else {
                this.stopUploadHandler(file);
            }
        }));
    }
    // Envia os arquivos passados por parâmetro, exceto os que já foram enviados ao serviço.
    /**
     * @protected
     * @param {?} files
     * @return {?}
     */
    uploadFiles(files) {
        /** @type {?} */
        const filesFiltered = files.filter((/**
         * @param {?} file
         * @return {?}
         */
        file => {
            return file.status !== ThfUploadStatus.Uploaded;
        }));
        this.uploadService.upload(this.url, filesFiltered, this.onUpload, (/**
         * @param {?} file
         * @param {?} percent
         * @return {?}
         */
        (file, percent) => {
            // UPLOADING
            this.uploadingHandler(file, percent);
        }), (/**
         * @param {?} file
         * @param {?} eventResponse
         * @return {?}
         */
        (file, eventResponse) => {
            // SUCCESS
            this.successHandler(file);
            this.onSuccess.emit(eventResponse);
        }), (/**
         * @param {?} file
         * @param {?} eventError
         * @return {?}
         */
        (file, eventError) => {
            // Error
            this.errorHandler(file);
            this.onError.emit(eventError);
        }));
    }
    // Atualiza a classe da div, que conter a classe 'thf-upload-filename', para 'thf-upload-filename-loading'.
    /**
     * @private
     * @param {?} uid
     * @return {?}
     */
    addFileNameClass(uid) {
        /** @type {?} */
        const divStatus = this.elementRef.nativeElement.querySelector(`div[id='${uid}'].thf-upload-progress`);
        /** @type {?} */
        const fileNameDiv = divStatus.querySelector('.thf-upload-filename');
        fileNameDiv.classList.add('thf-upload-filename-loading');
    }
    /**
     * @private
     * @return {?}
     */
    cleanInputValue() {
        this.calledByCleanInputValue = true;
        this.inputFile.nativeElement.value = '';
    }
    // Função disparada quando é retornado um erro no envio do arquivo.
    /**
     * @private
     * @param {?} file
     * @return {?}
     */
    errorHandler(file) {
        file.status = ThfUploadStatus.Error;
        this.setProgressStatus(file.uid, 0, false);
        this.setUploadStatus(file, 'thf-upload-progress-error', 100);
    }
    // Remove a classe 'thf-upload-filename-loading' da div que conter a classe 'thf-upload-filename'.
    /**
     * @private
     * @param {?} uid
     * @return {?}
     */
    removeFileNameClass(uid) {
        /** @type {?} */
        const divStatus = this.elementRef.nativeElement.querySelector(`div[id='${uid}'].thf-upload-progress`);
        /** @type {?} */
        const fileNameDiv = divStatus.querySelector('.thf-upload-filename');
        fileNameDiv.classList.remove('thf-upload-filename-loading');
    }
    // Atualiza o status do progresso do envio do arquivo.
    /**
     * @private
     * @param {?} uid
     * @param {?} percent
     * @param {?} isShow
     * @return {?}
     */
    setProgressStatus(uid, percent, isShow) {
        /** @type {?} */
        const divStatus = this.elementRef.nativeElement.querySelector(`div[id='${uid}'].thf-upload-progress`);
        /** @type {?} */
        const divProgress = divStatus.querySelector('.thf-upload-progress-status');
        /** @type {?} */
        const isDisplay = isShow ? 'block' : 'none';
        divProgress.setAttribute('style', `display: ${isDisplay};`);
        divProgress.setAttribute('style', `width: ${percent}%;`);
    }
    // Atualiza o status do envio de arquivos.
    /**
     * @private
     * @param {?} file
     * @param {?} className
     * @param {?} percent
     * @return {?}
     */
    setUploadStatus(file, className, percent) {
        /** @type {?} */
        const uid = file.uid;
        /** @type {?} */
        const divStatus = this.elementRef.nativeElement.querySelector(`div[id='${uid}'].thf-upload-progress`);
        divStatus.classList.remove('thf-upload-progress-error', 'thf-upload-progress-success');
        divStatus.classList.add(className);
        if (percent > 5 && file.status !== ThfUploadStatus.None) {
            this.addFileNameClass(uid);
        }
    }
    // Função disparada ao parar um envio de arquivo.
    /**
     * @private
     * @param {?} file
     * @return {?}
     */
    stopUploadHandler(file) {
        file.status = ThfUploadStatus.None;
        this.removeFileNameClass(file.uid);
        this.setProgressStatus(file.uid, 0, false);
        this.setUploadStatus(file, 'thf-upload-progress', 100);
    }
    // Função disparada quando o envio é realizado com sucesso.
    /**
     * @private
     * @param {?} file
     * @return {?}
     */
    successHandler(file) {
        file.status = ThfUploadStatus.Uploaded;
        this.setProgressStatus(file.uid, 0, false);
        this.setUploadStatus(file, 'thf-upload-progress-success', 100);
    }
    // Atualiza o ngModel para os arquivos passados por parâmetro.
    /**
     * @private
     * @param {?} files
     * @return {?}
     */
    updateModel(files) {
        this.onModelChange ? this.onModelChange(files) : this.ngModelChange.emit(files);
    }
    // Função disparada enquanto o arquivo está sendo enviado ao serviço.
    /**
     * @private
     * @param {?} file
     * @param {?} percent
     * @return {?}
     */
    uploadingHandler(file, percent) {
        file.status = ThfUploadStatus.Uploading;
        this.setProgressStatus(file.uid, percent, true);
        this.setUploadStatus(file, 'thf-upload-progress', percent);
    }
}
ThfUploadComponent.decorators = [
    { type: Component, args: [{
                selector: 'thf-upload',
                template: "<thf-field-container\n  [t-label]=\"label\"\n  [t-help]=\"help\"\n  [t-optional]=\"!required && optional\">\n\n  <div class=\"thf-upload\">\n    <input\n      #inputFile\n      class=\"thf-upload-input\"\n      type=\"file\"\n      [accept]=\"allowedExtensions\"\n      [attr.name]=\"name\"\n      [disabled]=\"isDisabled\"\n      [multiple]=\"isMultiple\"\n      [required]=\"required\"\n      (change)=\"onFileChange($event)\">\n\n    <thf-button\n      *ngIf=\"!hideSelectButton\"\n      class=\"thf-upload-button\"\n      for=\"file\"\n      [t-disabled]=\"isDisabled\"\n      [t-label]=\"literals.selectFile\"\n      (t-click)=\"selectFiles()\">\n    </thf-button>\n\n    <div class=\"thf-upload-progress\" *ngFor=\"let file of currentFiles\" [id]=\"file.uid\">\n      <div class=\"thf-upload-progress-status\"></div>\n      <div class=\"thf-upload-filename-foreground\">\n\n        <div class=\"thf-upload-filename\">\n          <span class=\"thf-icon {{ getThfIcon(file) }}\"></span> {{ file.name }} - {{ getFileSize(file.size) }}\n        </div>\n\n        <div class=\"thf-upload-group-actions\">\n          <span\n            *ngIf=\"isStatusFile('None', file) || isStatusFile('Error', file)\"\n            class=\"thf-upload-action\"\n            (click)=\"removeFile(file)\">\n            {{ literals.deleteFile }}\n          </span>\n\n          <span\n            *ngIf=\"isStatusFile('Uploading', file)\"\n            class=\"thf-upload-action\"\n            (click)=\"stopUpload(file)\">\n            {{ literals.cancel }}\n          </span>\n\n          <span\n            *ngIf=\"isStatusFile('Error', file)\"\n            class=\"thf-upload-action\"\n            (click)=\"uploadFiles([file])\">\n\n            {{ literals.tryAgain }}\n          </span>\n        </div>\n\n      </div>\n    </div>\n\n    <thf-button\n      *ngIf=\"displaySendButton\"\n      t-type=\"primary\"\n      [t-disabled]=\"hasAnyFileUploading(currentFiles)\"\n      [t-label]=\"literals.startSending\"\n      (t-click)=\"uploadFiles(currentFiles)\">\n    </thf-button>\n\n  </div>\n\n</thf-field-container>\n",
                providers: [
                    ThfUploadService,
                    {
                        provide: NG_VALUE_ACCESSOR,
                        useExisting: forwardRef((/**
                         * @return {?}
                         */
                        () => ThfUploadComponent)),
                        multi: true,
                    },
                    {
                        provide: NG_VALIDATORS,
                        useExisting: forwardRef((/**
                         * @return {?}
                         */
                        () => ThfUploadComponent)),
                        multi: true,
                    }
                ]
            }] }
];
/** @nocollapse */
ThfUploadComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: ThfUploadService }
];
ThfUploadComponent.propDecorators = {
    inputFile: [{ type: ViewChild, args: ['inputFile', { read: ElementRef, static: true },] }]
};
if (false) {
    /**
     * @type {?}
     * @private
     */
    ThfUploadComponent.prototype.calledByCleanInputValue;
    /**
     * @type {?}
     * @private
     */
    ThfUploadComponent.prototype.inputFile;
    /**
     * @type {?}
     * @private
     */
    ThfUploadComponent.prototype.elementRef;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGhmLXVwbG9hZC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdG90dnMvdGhmLXVpLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvdGhmLWZpZWxkL3RoZi11cGxvYWQvdGhmLXVwbG9hZC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDN0UsT0FBTyxFQUFFLGFBQWEsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRWxFLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBRXJFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUE0QzNELE1BQU0sT0FBTyxrQkFBbUIsU0FBUSxzQkFBc0I7Ozs7O0lBTTVELFlBQW9CLFVBQXNCLEVBQUUsYUFBK0I7UUFDekUsS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBREgsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUpsQyw0QkFBdUIsR0FBWSxLQUFLLENBQUM7SUFNakQsQ0FBQzs7OztJQUVELElBQUksaUJBQWlCOztjQUNiLFlBQVksR0FBRyxJQUFJLENBQUMsWUFBWSxJQUFJLEVBQUU7UUFDNUMsT0FBTyxDQUFDLElBQUksQ0FBQyxjQUFjLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7SUFDMUcsQ0FBQzs7OztJQUVELElBQUksa0JBQWtCO1FBQ3BCLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUU7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LEVBQUUsT0FBZTtRQUMzRCxJQUFJLENBQUMsTUFBTSxHQUFHLGVBQWUsQ0FBQyxTQUFTLENBQUM7UUFDeEMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ2hELElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxFQUFFLHFCQUFxQixFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzdELENBQUM7OztZQTFQRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLFlBQVk7Z0JBQ3RCLG9rRUFBMEM7Z0JBQzFDLFNBQVMsRUFBRTtvQkFDVCxnQkFBZ0I7b0JBQ2hCO3dCQUNFLE9BQU8sRUFBRSxpQkFBaUI7d0JBQzFCLFdBQVcsRUFBRSxVQUFVOzs7d0JBQUMsR0FBRyxFQUFFLENBQUMsa0JBQWtCLEVBQUM7d0JBQ2pELEtBQUssRUFBRSxJQUFJO3FCQUNaO29CQUNEO3dCQUNFLE9BQU8sRUFBRSxhQUFhO3dCQUN0QixXQUFXLEVBQUUsVUFBVTs7O3dCQUFDLEdBQUcsRUFBRSxDQUFDLGtCQUFrQixFQUFDO3dCQUNqRCxLQUFLLEVBQUUsSUFBSTtxQkFDWjtpQkFDRjthQUNGOzs7O1lBakRtQixVQUFVO1lBS3JCLGdCQUFnQjs7O3dCQWlEdEIsU0FBUyxTQUFDLFdBQVcsRUFBRSxFQUFDLElBQUksRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTs7Ozs7OztJQUZ6RCxxREFBaUQ7Ozs7O0lBRWpELHVDQUF5Rjs7Ozs7SUFFN0Usd0NBQThCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBFbGVtZW50UmVmLCBmb3J3YXJkUmVmLCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5HX1ZBTElEQVRPUlMsIE5HX1ZBTFVFX0FDQ0VTU09SIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuXG5pbXBvcnQgeyBUaGZVcGxvYWRCYXNlQ29tcG9uZW50IH0gZnJvbSAnLi90aGYtdXBsb2FkLWJhc2UuY29tcG9uZW50JztcbmltcG9ydCB7IFRoZlVwbG9hZEZpbGUgfSBmcm9tICcuL3RoZi11cGxvYWQtZmlsZSc7XG5pbXBvcnQgeyBUaGZVcGxvYWRTZXJ2aWNlIH0gZnJvbSAnLi90aGYtdXBsb2FkLnNlcnZpY2UnO1xuaW1wb3J0IHsgVGhmVXBsb2FkU3RhdHVzIH0gZnJvbSAnLi90aGYtdXBsb2FkLXN0YXR1cy5lbnVtJztcblxuLyoqXG4gKiBAZG9jc0V4dGVuZHMgVGhmVXBsb2FkQmFzZUNvbXBvbmVudFxuICpcbiAqIEBleGFtcGxlXG4gKlxuICogPGV4YW1wbGUgbmFtZT1cInRoZi11cGxvYWQtYmFzaWNcIiB0aXRsZT1cIlRvdHZzIFVwbG9hZCBCYXNpY1wiPlxuICogICA8ZmlsZSBuYW1lPVwic2FtcGxlLXRoZi11cGxvYWQtYmFzaWMvc2FtcGxlLXRoZi11cGxvYWQtYmFzaWMuY29tcG9uZW50Lmh0bWxcIj4gPC9maWxlPlxuICogICA8ZmlsZSBuYW1lPVwic2FtcGxlLXRoZi11cGxvYWQtYmFzaWMvc2FtcGxlLXRoZi11cGxvYWQtYmFzaWMuY29tcG9uZW50LnRzXCI+IDwvZmlsZT5cbiAqIDwvZXhhbXBsZT5cbiAqXG4gKiA8ZXhhbXBsZSBuYW1lPVwidGhmLXVwbG9hZC1sYWJzXCIgdGl0bGU9XCJUb3R2cyBVcGxvYWQgTGFic1wiPlxuICogICA8ZmlsZSBuYW1lPVwic2FtcGxlLXRoZi11cGxvYWQtbGFicy9zYW1wbGUtdGhmLXVwbG9hZC1sYWJzLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cbiAqICAgPGZpbGUgbmFtZT1cInNhbXBsZS10aGYtdXBsb2FkLWxhYnMvc2FtcGxlLXRoZi11cGxvYWQtbGFicy5jb21wb25lbnQudHNcIj4gPC9maWxlPlxuICogPC9leGFtcGxlPlxuICpcbiAqIDxleGFtcGxlIG5hbWU9XCJ0aGYtdXBsb2FkLXJlc3VtZVwiIHRpdGxlPVwiVG90dnMgVXBsb2FkIC0gUmVzdW1lXCI+XG4gKiAgIDxmaWxlIG5hbWU9XCJzYW1wbGUtdGhmLXVwbG9hZC1yZXN1bWUvc2FtcGxlLXRoZi11cGxvYWQtcmVzdW1lLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cbiAqICAgPGZpbGUgbmFtZT1cInNhbXBsZS10aGYtdXBsb2FkLXJlc3VtZS9zYW1wbGUtdGhmLXVwbG9hZC1yZXN1bWUuY29tcG9uZW50LnRzXCI+IDwvZmlsZT5cbiAqIDwvZXhhbXBsZT5cbiAqXG4gKiA8ZXhhbXBsZSBuYW1lPVwidGhmLXVwbG9hZC1yc1wiIHRpdGxlPVwiVG90dnMgVXBsb2FkIC0gUmVhbGl6ZSAmIFNob3dcIj5cbiAqICAgPGZpbGUgbmFtZT1cInNhbXBsZS10aGYtdXBsb2FkLXJzL3NhbXBsZS10aGYtdXBsb2FkLXJzLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cbiAqICAgPGZpbGUgbmFtZT1cInNhbXBsZS10aGYtdXBsb2FkLXJzL3NhbXBsZS10aGYtdXBsb2FkLXJzLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XG4gKiA8L2V4YW1wbGU+XG4gKi9cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3RoZi11cGxvYWQnLFxuICB0ZW1wbGF0ZVVybDogJy4vdGhmLXVwbG9hZC5jb21wb25lbnQuaHRtbCcsXG4gIHByb3ZpZGVyczogW1xuICAgIFRoZlVwbG9hZFNlcnZpY2UsXG4gICAge1xuICAgICAgcHJvdmlkZTogTkdfVkFMVUVfQUNDRVNTT1IsXG4gICAgICB1c2VFeGlzdGluZzogZm9yd2FyZFJlZigoKSA9PiBUaGZVcGxvYWRDb21wb25lbnQpLFxuICAgICAgbXVsdGk6IHRydWUsXG4gICAgfSxcbiAgICB7XG4gICAgICBwcm92aWRlOiBOR19WQUxJREFUT1JTLFxuICAgICAgdXNlRXhpc3Rpbmc6IGZvcndhcmRSZWYoKCkgPT4gVGhmVXBsb2FkQ29tcG9uZW50KSxcbiAgICAgIG11bHRpOiB0cnVlLFxuICAgIH1cbiAgXVxufSlcbmV4cG9ydCBjbGFzcyBUaGZVcGxvYWRDb21wb25lbnQgZXh0ZW5kcyBUaGZVcGxvYWRCYXNlQ29tcG9uZW50IHtcblxuICBwcml2YXRlIGNhbGxlZEJ5Q2xlYW5JbnB1dFZhbHVlOiBib29sZWFuID0gZmFsc2U7XG5cbiAgQFZpZXdDaGlsZCgnaW5wdXRGaWxlJywge3JlYWQ6IEVsZW1lbnRSZWYsIHN0YXRpYzogdHJ1ZSB9KSBwcml2YXRlIGlucHV0RmlsZTogRWxlbWVudFJlZjtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsIHVwbG9hZFNlcnZpY2U6IFRoZlVwbG9hZFNlcnZpY2UpIHtcbiAgICBzdXBlcih1cGxvYWRTZXJ2aWNlKTtcbiAgfVxuXG4gIGdldCBkaXNwbGF5U2VuZEJ1dHRvbigpOiBib29sZWFuIHtcbiAgICBjb25zdCBjdXJyZW50RmlsZXMgPSB0aGlzLmN1cnJlbnRGaWxlcyB8fCBbXTtcbiAgICByZXR1cm4gIXRoaXMuaGlkZVNlbmRCdXR0b24gJiYgIXRoaXMuYXV0b1VwbG9hZCAmJiAoY3VycmVudEZpbGVzLmxlbmd0aCA+IDAgJiYgdGhpcy5oYXNGaWxlTm90VXBsb2FkZWQpO1xuICB9XG5cbiAgZ2V0IGhhc0ZpbGVOb3RVcGxvYWRlZCgpOiBib29sZWFuIHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLmN1cnJlbnRGaWxlcykpIHtcbiAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRGaWxlcy5zb21lKGZpbGUgPT4gZmlsZS5zdGF0dXMgIT09IFRoZlVwbG9hZFN0YXR1cy5VcGxvYWRlZCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgZ2V0IGlzRGlzYWJsZWQoKTogYm9vbGVhbiB7XG4gICAgY29uc3QgY3VycmVudEZpbGVzID0gdGhpcy5jdXJyZW50RmlsZXMgfHwgW107XG5cbiAgICByZXR1cm4gdGhpcy5oYXNBbnlGaWxlVXBsb2FkaW5nKHRoaXMuY3VycmVudEZpbGVzKSB8fFxuICAgICF0aGlzLnVybCB8fFxuICAgIHRoaXMuZGlzYWJsZWQgfHxcbiAgICB0aGlzLmlzRXhjZWVkZWRGaWxlTGltaXQoY3VycmVudEZpbGVzLmxlbmd0aCk7XG4gIH1cblxuICAvKiogTcOpdG9kbyByZXNwb25zw6F2ZWwgcG9yICoqbGltcGFyKiogbyhzKSBhcnF1aXZvKHMpIHNlbGVjaW9uYWRvKHMpLiAqL1xuICBjbGVhcigpIHtcbiAgICB0aGlzLmN1cnJlbnRGaWxlcyA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnVwZGF0ZU1vZGVsKFtdKTtcbiAgICB0aGlzLmNsZWFuSW5wdXRWYWx1ZSgpO1xuICB9XG5cbiAgLy8gRnVuw6fDo28gZGlzcGFyYWRhIGFvIHNlbGVjaW9uYXIgYWxndW0gYXJxdWl2by5cbiAgb25GaWxlQ2hhbmdlKGV2ZW50KTogdm9pZCB7XG4gICAgLy8gbmVjZXNzYXJpbyBlc3RlIHRyYXRhbWVudG8gcXVhbmRvIHBhcmEgSUUsIHBvaXMgbmVsZSBvIGNoYW5nZSDDqSBkaXNwYXJhZG8gcXVhbmRvIG8gY2FtcG8gw6kgbGltcGFkbyB0YW1iw6ltXG4gICAgaWYgKHRoaXMuY2FsbGVkQnlDbGVhbklucHV0VmFsdWUpIHtcbiAgICAgIHRoaXMuY2FsbGVkQnlDbGVhbklucHV0VmFsdWUgPSBmYWxzZTtcbiAgICAgIHJldHVybiBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIH1cblxuICAgIGNvbnN0IGZpbGVzID0gZXZlbnQudGFyZ2V0LmZpbGVzO1xuICAgIHRoaXMuY3VycmVudEZpbGVzID0gdGhpcy5jdXJyZW50RmlsZXMgfHwgW107XG5cbiAgICB0aGlzLmN1cnJlbnRGaWxlcyA9IHRoaXMucGFyc2VGaWxlcyhmaWxlcyk7XG5cbiAgICB0aGlzLnVwZGF0ZU1vZGVsKFsuLi50aGlzLmN1cnJlbnRGaWxlc10pO1xuXG4gICAgaWYgKHRoaXMuYXV0b1VwbG9hZCkge1xuICAgICAgdGhpcy51cGxvYWRGaWxlcyh0aGlzLmN1cnJlbnRGaWxlcyk7XG4gICAgfVxuXG4gICAgdGhpcy5jbGVhbklucHV0VmFsdWUoKTtcbiAgfVxuXG4gIC8vIFJlbW92ZSBvIGFycXVpdm8gcGFzc2FkbyBwb3IgcGFyYW1ldHJvIGRhIGxpc3RhIGRvcyBhcnF1aXZvcyBjb3JyZW50ZXMuXG4gIHJlbW92ZUZpbGUoZmlsZSk6IHZvaWQge1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5jdXJyZW50RmlsZXMuaW5kZXhPZihmaWxlKTtcbiAgICB0aGlzLmN1cnJlbnRGaWxlcy5zcGxpY2UoaW5kZXgsIDEpO1xuXG4gICAgdGhpcy51cGRhdGVNb2RlbChbLi4udGhpcy5jdXJyZW50RmlsZXNdKTtcbiAgfVxuXG4gIC8qKiBNw6l0b2RvIHJlc3BvbnPDoXZlbCBwb3IgKiphYnJpcioqIGEgamFuZWxhIHBhcmEgc2VsZcOnw6NvIGRlIGFycXVpdm8ocykuICovXG4gIHNlbGVjdEZpbGVzKCk6IHZvaWQge1xuICAgIHRoaXMuY2FsbGVkQnlDbGVhbklucHV0VmFsdWUgPSBmYWxzZTtcbiAgICB0aGlzLmlucHV0RmlsZS5uYXRpdmVFbGVtZW50LmNsaWNrKCk7XG4gIH1cblxuICAvKiogTcOpdG9kbyByZXNwb25zw6F2ZWwgcG9yICoqZW52aWFyKiogbyhzKSBhcnF1aXZvKHMpIHNlbGVjaW9uYWRvKHMpLiAqL1xuICBzZW5kRmlsZXMoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuY3VycmVudEZpbGVzICYmIHRoaXMuY3VycmVudEZpbGVzLmxlbmd0aCkge1xuXG4gICAgICB0aGlzLnVwbG9hZEZpbGVzKHRoaXMuY3VycmVudEZpbGVzKTtcbiAgICB9XG4gIH1cblxuICAvLyBSZXRvcm5hIG8gdGFtYW5obyBkbyBhcnF1aXZvIGVtIEtCeXRlcy5cbiAgcHJvdGVjdGVkIGdldEZpbGVTaXplKHNpemU6IG51bWJlcik6IHN0cmluZyB7XG4gICAgbGV0IGtiU2l6ZSA9IDA7XG5cbiAgICBpZiAoc2l6ZSkge1xuICAgICAgICBrYlNpemUgPSBNYXRoLmNlaWwoc2l6ZSAvIDEwMjQpO1xuICAgIH1cblxuICAgIHJldHVybiBgJHtrYlNpemV9IEtCYDtcbiAgfVxuXG4gIC8vIFJldG9ybmEgbyB0aGYtaWNvbiBkZSBhY29yZG8gY29tIG8gc3RhdHVzIGRvIGFycXVpdm8uXG4gIHByb3RlY3RlZCBnZXRUaGZJY29uKGZpbGU6IFRoZlVwbG9hZEZpbGUpOiBzdHJpbmcge1xuICAgIHN3aXRjaCAoZmlsZS5zdGF0dXMpIHtcbiAgICAgIGNhc2UgVGhmVXBsb2FkU3RhdHVzLlVwbG9hZGVkOlxuICAgICAgICByZXR1cm4gJ3RoZi1pY29uLW9rJztcblxuICAgICAgY2FzZSBUaGZVcGxvYWRTdGF0dXMuRXJyb3I6XG4gICAgICAgIHJldHVybiAndGhmLWljb24tY2xvc2UnO1xuXG4gICAgICBjYXNlIFRoZlVwbG9hZFN0YXR1cy5Ob25lOlxuICAgICAgICByZXR1cm4gJ3RoZi1pY29uLWluZm8nO1xuXG4gICAgICBjYXNlIFRoZlVwbG9hZFN0YXR1cy5VcGxvYWRpbmc6XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gJyc7XG4gICAgfVxuICB9XG5cbiAgLy8gVmVyaWZpY2Egc2UgZXhpc3RlIGFsZ3VtIGFycXVpdm8gc2VuZG8gZW52aWFkbyBhbyBzZXJ2acOnby5cbiAgcHJvdGVjdGVkIGhhc0FueUZpbGVVcGxvYWRpbmcoZmlsZXM6IEFycmF5PFRoZlVwbG9hZEZpbGU+KSB7XG4gICAgaWYgKGZpbGVzICYmIGZpbGVzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIGZpbGVzLnNvbWUoZmlsZSA9PiBmaWxlLnN0YXR1cyA9PT0gVGhmVXBsb2FkU3RhdHVzLlVwbG9hZGluZyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgLy8gVmFsaWRhIHNlIG8gc3RhdHVzIHBhc3NhZG8gcG9yIHBhcsOibWV0cm8gw6kgaWd1YWwgYW8gc3RhdHVzIGRvIGFycXVpdm8uXG4gIHByb3RlY3RlZCBpc1N0YXR1c0ZpbGUoc3RhdHVzOiBzdHJpbmcsIGZpbGU6IFRoZlVwbG9hZEZpbGUpIHtcbiAgICByZXR1cm4gZmlsZS5zdGF0dXMgPT09IFRoZlVwbG9hZFN0YXR1c1tzdGF0dXNdO1xuICB9XG5cbiAgLy8gQ2FzbyBvIGNvbXBvbmVudGUgZXN0aXZlciBubyBtb2RvIEF1dG9VcGxvYWQsIG8gYXJxdWl2byB0YW1iw6ltIHNlcsOhIHJlbW92aWRvIGRhIGxpc3RhLlxuICBwcm90ZWN0ZWQgc3RvcFVwbG9hZChmaWxlOiBUaGZVcGxvYWRGaWxlKSB7XG4gICAgdGhpcy51cGxvYWRTZXJ2aWNlLnN0b3BSZXF1ZXN0QnlGaWxlKGZpbGUsICgpID0+IHtcbiAgICAgIGlmICh0aGlzLmF1dG9VcGxvYWQpIHtcbiAgICAgICAgdGhpcy5yZW1vdmVGaWxlKGZpbGUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zdG9wVXBsb2FkSGFuZGxlcihmaWxlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIC8vIEVudmlhIG9zIGFycXVpdm9zIHBhc3NhZG9zIHBvciBwYXLDom1ldHJvLCBleGNldG8gb3MgcXVlIGrDoSBmb3JhbSBlbnZpYWRvcyBhbyBzZXJ2acOnby5cbiAgcHJvdGVjdGVkIHVwbG9hZEZpbGVzKGZpbGVzOiBBcnJheTxUaGZVcGxvYWRGaWxlPikge1xuICAgIGNvbnN0IGZpbGVzRmlsdGVyZWQgPSBmaWxlcy5maWx0ZXIoZmlsZSA9PiB7XG4gICAgICByZXR1cm4gZmlsZS5zdGF0dXMgIT09IFRoZlVwbG9hZFN0YXR1cy5VcGxvYWRlZDtcbiAgICB9KTtcblxuICAgIHRoaXMudXBsb2FkU2VydmljZS51cGxvYWQodGhpcy51cmwsIGZpbGVzRmlsdGVyZWQsIHRoaXMub25VcGxvYWQsXG4gICAgICAoZmlsZSwgcGVyY2VudCk6IGFueSA9PiB7XG4gICAgICAgIC8vIFVQTE9BRElOR1xuICAgICAgICB0aGlzLnVwbG9hZGluZ0hhbmRsZXIoZmlsZSwgcGVyY2VudCk7XG5cbiAgICAgIH0sIChmaWxlLCBldmVudFJlc3BvbnNlKTogYW55ID0+IHtcbiAgICAgICAgLy8gU1VDQ0VTU1xuICAgICAgICB0aGlzLnN1Y2Nlc3NIYW5kbGVyKGZpbGUpO1xuICAgICAgICB0aGlzLm9uU3VjY2Vzcy5lbWl0KGV2ZW50UmVzcG9uc2UpO1xuXG4gICAgICB9LCAoZmlsZSwgZXZlbnRFcnJvcik6IGFueSA9PiB7XG4gICAgICAgIC8vIEVycm9yXG4gICAgICAgIHRoaXMuZXJyb3JIYW5kbGVyKGZpbGUpO1xuICAgICAgICB0aGlzLm9uRXJyb3IuZW1pdChldmVudEVycm9yKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8vIEF0dWFsaXphIGEgY2xhc3NlIGRhIGRpdiwgcXVlIGNvbnRlciBhIGNsYXNzZSAndGhmLXVwbG9hZC1maWxlbmFtZScsIHBhcmEgJ3RoZi11cGxvYWQtZmlsZW5hbWUtbG9hZGluZycuXG4gIHByaXZhdGUgYWRkRmlsZU5hbWVDbGFzcyh1aWQ6IHN0cmluZykge1xuICAgIGNvbnN0IGRpdlN0YXR1cyA9IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoYGRpdltpZD0nJHt1aWR9J10udGhmLXVwbG9hZC1wcm9ncmVzc2ApO1xuICAgIGNvbnN0IGZpbGVOYW1lRGl2ID0gZGl2U3RhdHVzLnF1ZXJ5U2VsZWN0b3IoJy50aGYtdXBsb2FkLWZpbGVuYW1lJyk7XG4gICAgZmlsZU5hbWVEaXYuY2xhc3NMaXN0LmFkZCgndGhmLXVwbG9hZC1maWxlbmFtZS1sb2FkaW5nJyk7XG4gIH1cblxuICBwcml2YXRlIGNsZWFuSW5wdXRWYWx1ZSgpIHtcbiAgICB0aGlzLmNhbGxlZEJ5Q2xlYW5JbnB1dFZhbHVlID0gdHJ1ZTtcbiAgICB0aGlzLmlucHV0RmlsZS5uYXRpdmVFbGVtZW50LnZhbHVlID0gJyc7XG4gIH1cblxuICAvLyBGdW7Dp8OjbyBkaXNwYXJhZGEgcXVhbmRvIMOpIHJldG9ybmFkbyB1bSBlcnJvIG5vIGVudmlvIGRvIGFycXVpdm8uXG4gIHByaXZhdGUgZXJyb3JIYW5kbGVyKGZpbGU6IFRoZlVwbG9hZEZpbGUpIHtcbiAgICBmaWxlLnN0YXR1cyA9IFRoZlVwbG9hZFN0YXR1cy5FcnJvcjtcbiAgICB0aGlzLnNldFByb2dyZXNzU3RhdHVzKGZpbGUudWlkLCAwLCBmYWxzZSk7XG4gICAgdGhpcy5zZXRVcGxvYWRTdGF0dXMoZmlsZSwgJ3RoZi11cGxvYWQtcHJvZ3Jlc3MtZXJyb3InLCAxMDApO1xuICB9XG5cbiAgLy8gUmVtb3ZlIGEgY2xhc3NlICd0aGYtdXBsb2FkLWZpbGVuYW1lLWxvYWRpbmcnIGRhIGRpdiBxdWUgY29udGVyIGEgY2xhc3NlICd0aGYtdXBsb2FkLWZpbGVuYW1lJy5cbiAgcHJpdmF0ZSByZW1vdmVGaWxlTmFtZUNsYXNzKHVpZDogc3RyaW5nKSB7XG4gICAgY29uc3QgZGl2U3RhdHVzID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcihgZGl2W2lkPScke3VpZH0nXS50aGYtdXBsb2FkLXByb2dyZXNzYCk7XG4gICAgY29uc3QgZmlsZU5hbWVEaXYgPSBkaXZTdGF0dXMucXVlcnlTZWxlY3RvcignLnRoZi11cGxvYWQtZmlsZW5hbWUnKTtcbiAgICBmaWxlTmFtZURpdi5jbGFzc0xpc3QucmVtb3ZlKCd0aGYtdXBsb2FkLWZpbGVuYW1lLWxvYWRpbmcnKTtcbiAgfVxuXG4gIC8vIEF0dWFsaXphIG8gc3RhdHVzIGRvIHByb2dyZXNzbyBkbyBlbnZpbyBkbyBhcnF1aXZvLlxuICBwcml2YXRlIHNldFByb2dyZXNzU3RhdHVzKHVpZDogc3RyaW5nLCBwZXJjZW50OiBudW1iZXIsIGlzU2hvdzogYm9vbGVhbikge1xuICAgIGNvbnN0IGRpdlN0YXR1cyA9IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoYGRpdltpZD0nJHt1aWR9J10udGhmLXVwbG9hZC1wcm9ncmVzc2ApO1xuICAgIGNvbnN0IGRpdlByb2dyZXNzID0gZGl2U3RhdHVzLnF1ZXJ5U2VsZWN0b3IoJy50aGYtdXBsb2FkLXByb2dyZXNzLXN0YXR1cycpO1xuICAgIGNvbnN0IGlzRGlzcGxheSA9IGlzU2hvdyA/ICdibG9jaycgOiAnbm9uZSc7XG5cbiAgICBkaXZQcm9ncmVzcy5zZXRBdHRyaWJ1dGUoJ3N0eWxlJywgYGRpc3BsYXk6ICR7aXNEaXNwbGF5fTtgKTtcbiAgICBkaXZQcm9ncmVzcy5zZXRBdHRyaWJ1dGUoJ3N0eWxlJywgYHdpZHRoOiAke3BlcmNlbnR9JTtgKTtcbiAgfVxuXG4gIC8vIEF0dWFsaXphIG8gc3RhdHVzIGRvIGVudmlvIGRlIGFycXVpdm9zLlxuICBwcml2YXRlIHNldFVwbG9hZFN0YXR1cyhmaWxlLCBjbGFzc05hbWU6IHN0cmluZywgcGVyY2VudDogbnVtYmVyKSB7XG4gICAgY29uc3QgdWlkID0gZmlsZS51aWQ7XG4gICAgY29uc3QgZGl2U3RhdHVzID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcihgZGl2W2lkPScke3VpZH0nXS50aGYtdXBsb2FkLXByb2dyZXNzYCk7XG4gICAgZGl2U3RhdHVzLmNsYXNzTGlzdC5yZW1vdmUoJ3RoZi11cGxvYWQtcHJvZ3Jlc3MtZXJyb3InLCAndGhmLXVwbG9hZC1wcm9ncmVzcy1zdWNjZXNzJyk7XG4gICAgZGl2U3RhdHVzLmNsYXNzTGlzdC5hZGQoY2xhc3NOYW1lKTtcblxuICAgIGlmIChwZXJjZW50ID4gNSAmJiBmaWxlLnN0YXR1cyAhPT0gVGhmVXBsb2FkU3RhdHVzLk5vbmUpIHtcbiAgICAgIHRoaXMuYWRkRmlsZU5hbWVDbGFzcyh1aWQpO1xuICAgIH1cbiAgfVxuXG4gIC8vIEZ1bsOnw6NvIGRpc3BhcmFkYSBhbyBwYXJhciB1bSBlbnZpbyBkZSBhcnF1aXZvLlxuICBwcml2YXRlIHN0b3BVcGxvYWRIYW5kbGVyKGZpbGU6IFRoZlVwbG9hZEZpbGUpIHtcbiAgICBmaWxlLnN0YXR1cyA9IFRoZlVwbG9hZFN0YXR1cy5Ob25lO1xuICAgIHRoaXMucmVtb3ZlRmlsZU5hbWVDbGFzcyhmaWxlLnVpZCk7XG4gICAgdGhpcy5zZXRQcm9ncmVzc1N0YXR1cyhmaWxlLnVpZCwgMCwgZmFsc2UpO1xuICAgIHRoaXMuc2V0VXBsb2FkU3RhdHVzKGZpbGUsICd0aGYtdXBsb2FkLXByb2dyZXNzJywgMTAwKTtcbiAgfVxuXG4gIC8vIEZ1bsOnw6NvIGRpc3BhcmFkYSBxdWFuZG8gbyBlbnZpbyDDqSByZWFsaXphZG8gY29tIHN1Y2Vzc28uXG4gIHByaXZhdGUgc3VjY2Vzc0hhbmRsZXIoZmlsZTogVGhmVXBsb2FkRmlsZSkge1xuICAgIGZpbGUuc3RhdHVzID0gVGhmVXBsb2FkU3RhdHVzLlVwbG9hZGVkO1xuICAgIHRoaXMuc2V0UHJvZ3Jlc3NTdGF0dXMoZmlsZS51aWQsIDAsIGZhbHNlKTtcbiAgICB0aGlzLnNldFVwbG9hZFN0YXR1cyhmaWxlLCAndGhmLXVwbG9hZC1wcm9ncmVzcy1zdWNjZXNzJywgMTAwKTtcbiAgfVxuXG4gIC8vIEF0dWFsaXphIG8gbmdNb2RlbCBwYXJhIG9zIGFycXVpdm9zIHBhc3NhZG9zIHBvciBwYXLDom1ldHJvLlxuICBwcml2YXRlIHVwZGF0ZU1vZGVsKGZpbGVzOiBBcnJheTxUaGZVcGxvYWRGaWxlPikge1xuICAgIHRoaXMub25Nb2RlbENoYW5nZSA/IHRoaXMub25Nb2RlbENoYW5nZShmaWxlcykgOiB0aGlzLm5nTW9kZWxDaGFuZ2UuZW1pdChmaWxlcyk7XG4gIH1cblxuICAvLyBGdW7Dp8OjbyBkaXNwYXJhZGEgZW5xdWFudG8gbyBhcnF1aXZvIGVzdMOhIHNlbmRvIGVudmlhZG8gYW8gc2VydmnDp28uXG4gIHByaXZhdGUgdXBsb2FkaW5nSGFuZGxlcihmaWxlOiBUaGZVcGxvYWRGaWxlLCBwZXJjZW50OiBudW1iZXIpIHtcbiAgICBmaWxlLnN0YXR1cyA9IFRoZlVwbG9hZFN0YXR1cy5VcGxvYWRpbmc7XG4gICAgdGhpcy5zZXRQcm9ncmVzc1N0YXR1cyhmaWxlLnVpZCwgcGVyY2VudCwgdHJ1ZSk7XG4gICAgdGhpcy5zZXRVcGxvYWRTdGF0dXMoZmlsZSwgJ3RoZi11cGxvYWQtcHJvZ3Jlc3MnLCBwZXJjZW50KTtcbiAgfVxuXG59XG4iXX0=