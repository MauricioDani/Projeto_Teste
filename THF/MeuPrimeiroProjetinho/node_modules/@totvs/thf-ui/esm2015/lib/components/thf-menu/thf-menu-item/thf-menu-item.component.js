/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, ElementRef, Input, ViewChild } from '@angular/core';
import { convertToInt, convertToBoolean } from '../../../utils/util';
import { ThfMenuItemsService } from '../services/thf-menu-items.service';
// valor para que caibam 3 linhas de `label`
/** @type {?} */
const thfMenuItemSubItemSize = 98;
/**
 * \@docsPrivate
 *
 * \@description
 *
 * Componente que implementa cada item do thf-menu.
 */
export class ThfMenuItemComponent {
    /**
     * @param {?} menuItemsService
     */
    constructor(menuItemsService) {
        this.menuItemsService = menuItemsService;
        this._isSelected = false;
        this._isSubItem = false;
        this.maxHeight = 0;
    }
    // Valor do badge.
    /**
     * @param {?} badgeValue
     * @return {?}
     */
    set badgeValue(badgeValue) {
        this._badgeValue = convertToInt(badgeValue);
    }
    /**
     * @return {?}
     */
    get badgeValue() {
        return this._badgeValue;
    }
    // Indica se o item está selecionado.
    /**
     * @param {?} value
     * @return {?}
     */
    set isSelected(value) {
        this._isSelected = convertToBoolean(value);
        this.isSelectedSubItem = this.isSelected && this.isSubItem;
    }
    /**
     * @return {?}
     */
    get isSelected() {
        return this._isSelected;
    }
    // Indica se o item é um sub item
    /**
     * @param {?} value
     * @return {?}
     */
    set isSubItem(value) {
        this._isSubItem = convertToBoolean(value);
    }
    /**
     * @return {?}
     */
    get isSubItem() {
        return this._isSubItem;
    }
    // Lista de sub-items.
    /**
     * @param {?} subitems
     * @return {?}
     */
    set subItems(subitems) {
        this._subItems = subitems;
        if (this.isOpened) {
            this.calcMenuSubItemsMaxHeight();
        }
    }
    /**
     * @return {?}
     */
    get subItems() {
        return this._subItems;
    }
    /**
     * @return {?}
     */
    get canShowBadge() {
        return this.type !== 'subItems' && (this.badgeValue || this.badgeValue === 0) && this.badgeValue >= 0;
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.itemSubscription.unsubscribe();
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        // subscribe to menu component messages
        this.itemSubscription = this.menuItemsService.receiveFromParentMenuClicked().subscribe((/**
         * @param {?} menu
         * @return {?}
         */
        menu => {
            this.processMenuItem(menu);
        }));
    }
    /**
     * @param {?} event
     * @return {?}
     */
    clickMenuItem(event) {
        if (!(event.ctrlKey || event.metaKey)) {
            event.preventDefault();
            // Emmit to parent
            this.menuItemsService.sendToParentMenuClicked({
                link: this.link,
                action: this.action,
                id: this.id,
                icon: this.icon,
                label: this.label,
                level: this.level,
                subItems: this.subItems,
                isSelected: this.isSelected,
                isOpened: this.isOpened,
                shortLabel: this.shortLabel,
                type: this.type
            });
        }
    }
    /**
     * @private
     * @param {?} menuActive
     * @param {?} menuOpened
     * @param {?} hasSubItemOpened
     * @param {?} activatedByRoute
     * @return {?}
     */
    accordionAnimation(menuActive, menuOpened, hasSubItemOpened, activatedByRoute) {
        if (this.id === menuOpened['id']) {
            this.maxHeight = this.subItems.length * thfMenuItemSubItemSize;
        }
        if (hasSubItemOpened) {
            this.maxHeight = menuOpened['isOpened'] ?
                (this.maxHeight + menuOpened.subItems.length * thfMenuItemSubItemSize) :
                (this.maxHeight - menuOpened.subItems.length * thfMenuItemSubItemSize);
            if (activatedByRoute) {
                this.maxHeight = this.getMinimumHeight(0, this, menuActive);
            }
        }
    }
    /**
     * @private
     * @param {?} menu
     * @return {?}
     */
    activateMenu(menu) {
        this.isSelected = menu && this.id === menu.id;
    }
    /**
     * @private
     * @return {?}
     */
    calcMenuSubItemsMaxHeight() {
        setTimeout((/**
         * @return {?}
         */
        () => {
            /** @type {?} */
            const subItems = Array.from(this.menuSubItems.nativeElement.querySelectorAll('.thf-menu-item'));
            subItems.forEach((/**
             * @param {?} menuItem
             * @return {?}
             */
            (menuItem) => this.maxHeight += menuItem.offsetHeight));
        }));
    }
    /**
     * @private
     * @param {?} minimumHeight
     * @param {?} menuItem
     * @param {?} menuActive
     * @return {?}
     */
    getMinimumHeight(minimumHeight, menuItem, menuActive) {
        minimumHeight += thfMenuItemSubItemSize;
        if (menuItem.subItems && this.hasSubItem(menuItem.subItems, menuActive['id'])) {
            for (let index = 0; index < menuItem.subItems.length; index++) {
                minimumHeight = this.getMinimumHeight(minimumHeight, menuItem.subItems[index], menuActive);
            }
        }
        return minimumHeight;
    }
    /**
     * @private
     * @param {?} menuActive
     * @param {?} menuOpened
     * @param {?=} activatedByRoute
     * @return {?}
     */
    groupedMenu(menuActive, menuOpened, activatedByRoute = false) {
        /** @type {?} */
        const hasSubItemOpened = (menuOpened && this.id !== menuOpened['id']) ? this.hasSubItem(this.subItems, menuOpened['id']) : false;
        this.isOpened = this.isMenuOpened(menuOpened, hasSubItemOpened);
        this.isSelected = (menuActive && !this.isOpened) ? this.hasSubItem(this.subItems, menuActive['id']) : false;
        if (!this.isOpened) {
            this.maxHeight = 0;
            return;
        }
        this.accordionAnimation(menuActive, menuOpened, hasSubItemOpened, activatedByRoute);
    }
    /**
     * @private
     * @param {?} subItems
     * @param {?} id
     * @return {?}
     */
    hasSubItem(subItems, id) {
        if (subItems) {
            return subItems.some((/**
             * @param {?} item
             * @return {?}
             */
            item => {
                return item['id'] === id ? true : this.hasSubItem(item.subItems, id);
            }));
        }
    }
    /**
     * @private
     * @param {?} menuOpened
     * @param {?} hasSubItemOpened
     * @return {?}
     */
    isMenuOpened(menuOpened, hasSubItemOpened) {
        if (menuOpened) {
            return (this.id === menuOpened['id']) ? menuOpened['isOpened'] : hasSubItemOpened;
        }
        return false;
    }
    /**
     * @private
     * @param {?} menu
     * @return {?}
     */
    processMenuItem(menu) {
        if (this.type === 'internalLink') {
            this.activateMenu(menu.active);
            return;
        }
        if (this.type === 'subItems') {
            this.groupedMenu(menu.active, menu.grouped, menu.activatedByRoute);
            return;
        }
    }
}
ThfMenuItemComponent.decorators = [
    { type: Component, args: [{
                selector: 'thf-menu-item',
                template: "<!-- menu com link interno -->\n<a *ngIf=\"type === 'internalLink'\" class=\"thf-menu-item-link\" [routerLink]=\"link\">\n  <ng-container *ngTemplateOutlet=\"menuItemTemplate\"></ng-container>\n</a>\n<!-- menu com link externo -->\n<a *ngIf=\"type === 'externalLink'\" class=\"thf-menu-item-link\" [href]=\"link\">\n  <ng-container *ngTemplateOutlet=\"menuItemTemplate\"></ng-container>\n</a>\n<!-- menu sem link -->\n<a *ngIf=\"type === 'noLink'\" class=\"thf-menu-item-link\" href=\"javascript:;\">\n  <ng-container *ngTemplateOutlet=\"menuItemTemplate\"></ng-container>\n</a>\n<!-- menu com sub itens -->\n<div *ngIf=\"type === 'subItems'\" class=\"thf-menu-item-link thf-clickable\">\n  <ng-container *ngTemplateOutlet=\"menuItemTemplate;\"></ng-container>\n  <div #menuSubItems\n    class=\"thf-menu-sub-items\"\n    [hidden]=\"collapsedMenu\"\n    [style.maxHeight.px]=\"maxHeight\">\n    <div *ngFor=\"let subItem of subItems\">\n      <thf-menu-item\n        t-is-sub-item\n        [t-action]=\"subItem.action\"\n        [t-badge-alert]=\"subItem.badgeAlert\"\n        [t-badge-color]=\"subItem.badge ? subItem.badge.color : undefined\"\n        [t-badge-value]=\"subItem.badge ? subItem.badge.value : undefined\"\n        [t-id]=\"subItem.id\"\n        [t-label]=\"subItem.label\"\n        [t-level]=\"subItem.level\"\n        [t-link]=\"subItem.link\"\n        [t-sub-items]=\"subItem.subItems\"\n        [t-type]=\"subItem.type\">\n      </thf-menu-item>\n    </div>\n  </div>\n</div>\n\n<ng-template #menuItemTemplate>\n  <div class=\"thf-menu-item\"\n    [class.thf-menu-icon-container]=\"level === 1 && icon\"\n    [class.thf-menu-item-selected]=\"isSelected\"\n    [class.thf-menu-item-level-two]=\"level === 2\"\n    [class.thf-menu-item-level-three]=\"level === 3\"\n    [class.thf-menu-item-level-four]=\"level === 4\"\n    [class.thf-menu-item-grouper-up]=\"type === 'subItems' && isOpened\"\n    [class.thf-menu-item-grouper-down]=\"type === 'subItems' && !isOpened\"\n    [class.thf-menu-sub-item-selected]=\"isSelectedSubItem\"\n    (click)=\"clickMenuItem($event);\">\n    <thf-badge *ngIf=\"canShowBadge\"\n      [ngClass]=\"!collapsedMenu ? 'thf-menu-badge-align' : 'thf-menu-badge-align-collapsed'\"\n      [t-color]=\"badgeColor\"\n      [t-value]=\"badgeValue\">\n    </thf-badge>\n    <span *ngIf=\"level === 1 && icon\" class=\"thf-icon {{icon}} thf-menu-icon-item\"></span>\n    <div *ngIf=\"badgeAlert\"\n      class=\"thf-color-07\"\n      [ngClass]=\"!collapsedMenu ? 'thf-menu-badge-alert' : 'thf-menu-badge-alert-collapsed'\">\n    </div>\n    <span *ngIf=\"type === 'subItems' && !collapsedMenu\"\n      class=\"thf-icon thf-menu-group-icon\"\n      [class.thf-icon-arrow-up]=\"isOpened\"\n      [class.thf-icon-arrow-down]=\"!isOpened\">\n    </span>\n    <div [class.thf-menu-icon-label]=\"level === 1 && icon\">\n      {{ label }}\n    </div>\n    <div *ngIf=\"collapsedMenu\" class=\"thf-menu-short-label\">{{ shortLabel }}</div>\n  </div>\n</ng-template>\n"
            }] }
];
/** @nocollapse */
ThfMenuItemComponent.ctorParameters = () => [
    { type: ThfMenuItemsService }
];
ThfMenuItemComponent.propDecorators = {
    action: [{ type: Input, args: ['t-action',] }],
    badgeAlert: [{ type: Input, args: ['t-badge-alert',] }],
    badgeColor: [{ type: Input, args: ['t-badge-color',] }],
    badgeValue: [{ type: Input, args: ['t-badge-value',] }],
    collapsedMenu: [{ type: Input, args: ['t-collapsed-menu',] }],
    icon: [{ type: Input, args: ['t-icon',] }],
    id: [{ type: Input, args: ['t-id',] }],
    isOpened: [{ type: Input, args: ['t-is-opened',] }],
    isSelected: [{ type: Input, args: ['t-is-selected',] }],
    isSubItem: [{ type: Input, args: ['t-is-sub-item',] }],
    label: [{ type: Input, args: ['t-label',] }],
    level: [{ type: Input, args: ['t-level',] }],
    link: [{ type: Input, args: ['t-link',] }],
    shortLabel: [{ type: Input, args: ['t-short-label',] }],
    subItems: [{ type: Input, args: ['t-sub-items',] }],
    type: [{ type: Input, args: ['t-type',] }],
    menuSubItems: [{ type: ViewChild, args: ['menuSubItems', { static: false },] }]
};
if (false) {
    /**
     * @type {?}
     * @private
     */
    ThfMenuItemComponent.prototype._badgeValue;
    /**
     * @type {?}
     * @private
     */
    ThfMenuItemComponent.prototype._isSelected;
    /**
     * @type {?}
     * @private
     */
    ThfMenuItemComponent.prototype._isSubItem;
    /**
     * @type {?}
     * @private
     */
    ThfMenuItemComponent.prototype._subItems;
    /** @type {?} */
    ThfMenuItemComponent.prototype.isSelectedSubItem;
    /** @type {?} */
    ThfMenuItemComponent.prototype.maxHeight;
    /**
     * @type {?}
     * @private
     */
    ThfMenuItemComponent.prototype.itemSubscription;
    /** @type {?} */
    ThfMenuItemComponent.prototype.action;
    /** @type {?} */
    ThfMenuItemComponent.prototype.badgeAlert;
    /** @type {?} */
    ThfMenuItemComponent.prototype.badgeColor;
    /** @type {?} */
    ThfMenuItemComponent.prototype.collapsedMenu;
    /** @type {?} */
    ThfMenuItemComponent.prototype.icon;
    /** @type {?} */
    ThfMenuItemComponent.prototype.id;
    /** @type {?} */
    ThfMenuItemComponent.prototype.isOpened;
    /** @type {?} */
    ThfMenuItemComponent.prototype.label;
    /** @type {?} */
    ThfMenuItemComponent.prototype.level;
    /** @type {?} */
    ThfMenuItemComponent.prototype.link;
    /** @type {?} */
    ThfMenuItemComponent.prototype.shortLabel;
    /** @type {?} */
    ThfMenuItemComponent.prototype.type;
    /** @type {?} */
    ThfMenuItemComponent.prototype.menuSubItems;
    /**
     * @type {?}
     * @private
     */
    ThfMenuItemComponent.prototype.menuItemsService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGhmLW1lbnUtaXRlbS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdG90dnMvdGhmLXVpLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvdGhmLW1lbnUvdGhmLW1lbnUtaXRlbS90aGYtbWVudS1pdGVtLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFxQixTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFJM0YsT0FBTyxFQUFFLFlBQVksRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBR3JFLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLG9DQUFvQyxDQUFDOzs7TUFHbkUsc0JBQXNCLEdBQUcsRUFBRTs7Ozs7Ozs7QUFhakMsTUFBTSxPQUFPLG9CQUFvQjs7OztJQThGL0IsWUFBb0IsZ0JBQXFDO1FBQXJDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBcUI7UUEzRmpELGdCQUFXLEdBQVksS0FBSyxDQUFDO1FBQzdCLGVBQVUsR0FBWSxLQUFLLENBQUM7UUFJcEMsY0FBUyxHQUFXLENBQUMsQ0FBQztJQXNGdUMsQ0FBQzs7Ozs7O0lBeEU5RCxJQUE0QixVQUFVLENBQUMsVUFBa0I7UUFDdkQsSUFBSSxDQUFDLFdBQVcsR0FBRyxZQUFZLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDOUMsQ0FBQzs7OztJQUVELElBQUksVUFBVTtRQUNaLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQztJQUMxQixDQUFDOzs7Ozs7SUFlRCxJQUE0QixVQUFVLENBQUMsS0FBYztRQUNuRCxJQUFJLENBQUMsV0FBVyxHQUFHLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRTNDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUM7SUFDN0QsQ0FBQzs7OztJQUNELElBQUksVUFBVTtR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LFNBQUMsU0FBUzttQkFHZixLQUFLLFNBQUMsUUFBUTt5QkFHZCxLQUFLLFNBQUMsZUFBZTt1QkFHckIsS0FBSyxTQUFDLGFBQWE7bUJBWW5CLEtBQUssU0FBQyxRQUFROzJCQUVkLFNBQVMsU0FBQyxjQUFjLEVBQUUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFOzs7Ozs7O0lBdEY1QywyQ0FBNEI7Ozs7O0lBQzVCLDJDQUFxQzs7Ozs7SUFDckMsMENBQW9DOzs7OztJQUNwQyx5Q0FBc0M7O0lBRXRDLGlEQUFrQjs7SUFDbEIseUNBQXNCOzs7OztJQUV0QixnREFBdUM7O0lBR3ZDLHNDQUE2Qzs7SUFHN0MsMENBQTRDOztJQUc1QywwQ0FBMkM7O0lBWTNDLDZDQUFrRDs7SUFHbEQsb0NBQThCOztJQUc5QixrQ0FBMEI7O0lBRzFCLHdDQUF3Qzs7SUFzQnhDLHFDQUFnQzs7SUFHaEMscUNBQWdDOztJQUdoQyxvQ0FBK0I7O0lBRy9CLDBDQUEyQzs7SUFlM0Msb0NBQThCOztJQUU5Qiw0Q0FBdUU7Ozs7O0lBTTNELGdEQUE2QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgRWxlbWVudFJlZiwgSW5wdXQsIE9uRGVzdHJveSwgT25Jbml0LCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7IGNvbnZlcnRUb0ludCwgY29udmVydFRvQm9vbGVhbiB9IGZyb20gJy4uLy4uLy4uL3V0aWxzL3V0aWwnO1xuXG5pbXBvcnQgeyBUaGZNZW51SXRlbSB9IGZyb20gJy4uL3RoZi1tZW51LWl0ZW0uaW50ZXJmYWNlJztcbmltcG9ydCB7IFRoZk1lbnVJdGVtc1NlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy90aGYtbWVudS1pdGVtcy5zZXJ2aWNlJztcblxuLy8gdmFsb3IgcGFyYSBxdWUgY2FpYmFtIDMgbGluaGFzIGRlIGBsYWJlbGBcbmNvbnN0IHRoZk1lbnVJdGVtU3ViSXRlbVNpemUgPSA5ODtcblxuLyoqXG4gKiBAZG9jc1ByaXZhdGVcbiAqXG4gKiBAZGVzY3JpcHRpb25cbiAqXG4gKiBDb21wb25lbnRlIHF1ZSBpbXBsZW1lbnRhIGNhZGEgaXRlbSBkbyB0aGYtbWVudS5cbiAqL1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAndGhmLW1lbnUtaXRlbScsXG4gIHRlbXBsYXRlVXJsOiAnLi90aGYtbWVudS1pdGVtLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBUaGZNZW51SXRlbUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uRGVzdHJveSwgT25Jbml0IHtcblxuICBwcml2YXRlIF9iYWRnZVZhbHVlOiBudW1iZXI7XG4gIHByaXZhdGUgX2lzU2VsZWN0ZWQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSBfaXNTdWJJdGVtOiBib29sZWFuID0gZmFsc2U7XG4gIHByaXZhdGUgX3N1Ykl0ZW1zOiBBcnJheTxUaGZNZW51SXRlbT47XG5cbiAgaXNTZWxlY3RlZFN1Ykl0ZW07XG4gIG1heEhlaWdodDogbnVtYmVyID0gMDtcblxuICBwcml2YXRlIGl0ZW1TdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcblxuICAvLyBBw6fDo28gcXVlIHNlcsOhIGNoYW1hZGEgYW8gY2xpY2FyIG5vIGl0ZW0uXG4gIEBJbnB1dCgndC1hY3Rpb24nKSBhY3Rpb246IHN0cmluZyB8IEZ1bmN0aW9uO1xuXG4gIC8vIEluZGljYSBzZSBjb250w6ltIGFsZ3VtIGl0ZW0gZmlsaG8gY29tIG8gYmFkZ2UuXG4gIEBJbnB1dCgndC1iYWRnZS1hbGVydCcpIGJhZGdlQWxlcnQ6IGJvb2xlYW47XG5cbiAgLy8gQ29yIGRvIGJhZGdlLlxuICBASW5wdXQoJ3QtYmFkZ2UtY29sb3InKSBiYWRnZUNvbG9yOiBzdHJpbmc7XG5cbiAgLy8gVmFsb3IgZG8gYmFkZ2UuXG4gIEBJbnB1dCgndC1iYWRnZS12YWx1ZScpIHNldCBiYWRnZVZhbHVlKGJhZGdlVmFsdWU6IG51bWJlcikge1xuICAgIHRoaXMuX2JhZGdlVmFsdWUgPSBjb252ZXJ0VG9JbnQoYmFkZ2VWYWx1ZSk7XG4gIH1cblxuICBnZXQgYmFkZ2VWYWx1ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5fYmFkZ2VWYWx1ZTtcbiAgfVxuXG4gIC8vIEluZGljYSBzZSBvIG1lbnUgZXN0w6EgY29sYXBzYWRvXG4gIEBJbnB1dCgndC1jb2xsYXBzZWQtbWVudScpIGNvbGxhcHNlZE1lbnU6IGJvb2xlYW47XG5cbiAgLy8gw41jb25lIGRlIG1lbnVcbiAgQElucHV0KCd0LWljb24nKSBpY29uOiBzdHJpbmc7XG5cbiAgLy8gSWRlbnRpZmljYWRvciBkbyBpdGVtLlxuICBASW5wdXQoJ3QtaWQnKSBpZDogc3RyaW5nO1xuXG4gIC8vIEluZGljYSBzZSBvIGl0ZW0gZXN0w6EgYWJlcnRvIChtZW51IGFncnVwYWRvKVxuICBASW5wdXQoJ3QtaXMtb3BlbmVkJykgaXNPcGVuZWQ6IGJvb2xlYW47XG5cbiAgLy8gSW5kaWNhIHNlIG8gaXRlbSBlc3TDoSBzZWxlY2lvbmFkby5cbiAgQElucHV0KCd0LWlzLXNlbGVjdGVkJykgc2V0IGlzU2VsZWN0ZWQodmFsdWU6IGJvb2xlYW4pIHtcbiAgICB0aGlzLl9pc1NlbGVjdGVkID0gY29udmVydFRvQm9vbGVhbih2YWx1ZSk7XG5cbiAgICB0aGlzLmlzU2VsZWN0ZWRTdWJJdGVtID0gdGhpcy5pc1NlbGVjdGVkICYmIHRoaXMuaXNTdWJJdGVtO1xuICB9XG4gIGdldCBpc1NlbGVjdGVkKCkge1xuICAgIHJldHVybiB0aGlzLl9pc1NlbGVjdGVkO1xuICB9XG5cbiAgLy8gSW5kaWNhIHNlIG8gaXRlbSDDqSB1bSBzdWIgaXRlbVxuICBASW5wdXQoJ3QtaXMtc3ViLWl0ZW0nKSBzZXQgaXNTdWJJdGVtKHZhbHVlOiBib29sZWFuKSB7XG4gICAgdGhpcy5faXNTdWJJdGVtID0gY29udmVydFRvQm9vbGVhbih2YWx1ZSk7XG4gIH1cblxuICBnZXQgaXNTdWJJdGVtKCkge1xuICAgIHJldHVybiB0aGlzLl9pc1N1Ykl0ZW07XG4gIH1cblxuICAvLyBUZXh0byBxdWUgYXBhcmVjZXLDoSByZXByZXNlbnRhbmRvIG8gaXRlbS5cbiAgQElucHV0KCd0LWxhYmVsJykgbGFiZWw6IHN0cmluZztcblxuICAvLyBJbmRpY2EgcXVhbCBlbSBuw612ZWwgZG8gdGhmLW1lbnUgZW5jb250cmEtc2UuXG4gIEBJbnB1dCgndC1sZXZlbCcpIGxldmVsOiBudW1iZXI7XG5cbiAgLy8gTGluayBkbyBpdGVtLlxuICBASW5wdXQoJ3QtbGluaycpIGxpbms/OiBzdHJpbmc7XG5cbiAgLy8gVGV4dG8gcXVlIGFwYXJlY2Vyw6EgcmVwcmVzZW50YW5kbyBvIGl0ZW0uXG4gIEBJbnB1dCgndC1zaG9ydC1sYWJlbCcpIHNob3J0TGFiZWw6IHN0cmluZztcblxuICAvLyBMaXN0YSBkZSBzdWItaXRlbXMuXG4gIEBJbnB1dCgndC1zdWItaXRlbXMnKSBzZXQgc3ViSXRlbXMoc3ViaXRlbXM6IEFycmF5PFRoZk1lbnVJdGVtPikge1xuICAgIHRoaXMuX3N1Ykl0ZW1zID0gc3ViaXRlbXM7XG4gICAgaWYgKHRoaXMuaXNPcGVuZWQpIHtcbiAgICAgIHRoaXMuY2FsY01lbnVTdWJJdGVtc01heEhlaWdodCgpO1xuICAgIH1cbiAgfVxuXG4gIGdldCBzdWJJdGVtcygpIHtcbiAgICByZXR1cm4gdGhpcy5fc3ViSXRlbXM7XG4gIH1cblxuICAvLyBJbmRpY2EgbyB0aXBvIGRlIGl0ZW0sIGNvbW8gJ2ludGVybmFsTGluaycgb3UgJ3N1Ykl0ZW1zJy5cbiAgQElucHV0KCd0LXR5cGUnKSB0eXBlOiBzdHJpbmc7XG5cbiAgQFZpZXdDaGlsZCgnbWVudVN1Ykl0ZW1zJywgeyBzdGF0aWM6IGZhbHNlIH0pIG1lbnVTdWJJdGVtczogRWxlbWVudFJlZjtcblxuICBnZXQgY2FuU2hvd0JhZGdlKCkge1xuICAgIHJldHVybiB0aGlzLnR5cGUgIT09ICdzdWJJdGVtcycgJiYgKHRoaXMuYmFkZ2VWYWx1ZSB8fCB0aGlzLmJhZGdlVmFsdWUgPT09IDApICYmIHRoaXMuYmFkZ2VWYWx1ZSA+PSAwO1xuICB9XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBtZW51SXRlbXNTZXJ2aWNlOiBUaGZNZW51SXRlbXNTZXJ2aWNlKSB7IH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLml0ZW1TdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuXG4gICAgLy8gc3Vic2NyaWJlIHRvIG1lbnUgY29tcG9uZW50IG1lc3NhZ2VzXG4gICAgdGhpcy5pdGVtU3Vic2NyaXB0aW9uID0gdGhpcy5tZW51SXRlbXNTZXJ2aWNlLnJlY2VpdmVGcm9tUGFyZW50TWVudUNsaWNrZWQoKS5zdWJzY3JpYmUobWVudSA9PiB7XG4gICAgICB0aGlzLnByb2Nlc3NNZW51SXRlbShtZW51KTtcbiAgICB9KTtcbiAgfVxuXG4gIGNsaWNrTWVudUl0ZW0oZXZlbnQpOiB2b2lkIHtcbiAgICBpZiAoIShldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkpKSB7XG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAvLyBFbW1pdCB0byBwYXJlbnRcbiAgICAgIHRoaXMubWVudUl0ZW1zU2VydmljZS5zZW5kVG9QYXJlbnRNZW51Q2xpY2tlZCh7XG4gICAgICAgIGxpbms6IHRoaXMubGluayxcbiAgICAgICAgYWN0aW9uOiB0aGlzLmFjdGlvbixcbiAgICAgICAgaWQ6IHRoaXMuaWQsXG4gICAgICAgIGljb246IHRoaXMuaWNvbixcbiAgICAgICAgbGFiZWw6IHRoaXMubGFiZWwsXG4gICAgICAgIGxldmVsOiB0aGlzLmxldmVsLFxuICAgICAgICBzdWJJdGVtczogdGhpcy5zdWJJdGVtcyxcbiAgICAgICAgaXNTZWxlY3RlZDogdGhpcy5pc1NlbGVjdGVkLFxuICAgICAgICBpc09wZW5lZDogdGhpcy5pc09wZW5lZCxcbiAgICAgICAgc2hvcnRMYWJlbDogdGhpcy5zaG9ydExhYmVsLFxuICAgICAgICB0eXBlOiB0aGlzLnR5cGVcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWNjb3JkaW9uQW5pbWF0aW9uKG1lbnVBY3RpdmU6IFRoZk1lbnVJdGVtLCBtZW51T3BlbmVkOiBUaGZNZW51SXRlbSwgaGFzU3ViSXRlbU9wZW5lZDogYm9vbGVhbiwgYWN0aXZhdGVkQnlSb3V0ZTogYm9vbGVhbikge1xuXG4gICAgaWYgKHRoaXMuaWQgPT09IG1lbnVPcGVuZWRbJ2lkJ10pIHtcbiAgICAgIHRoaXMubWF4SGVpZ2h0ID0gdGhpcy5zdWJJdGVtcy5sZW5ndGggKiB0aGZNZW51SXRlbVN1Ykl0ZW1TaXplO1xuICAgIH1cblxuICAgIGlmIChoYXNTdWJJdGVtT3BlbmVkKSB7XG4gICAgICB0aGlzLm1heEhlaWdodCA9IG1lbnVPcGVuZWRbJ2lzT3BlbmVkJ10gP1xuICAgICAgICAodGhpcy5tYXhIZWlnaHQgKyBtZW51T3BlbmVkLnN1Ykl0ZW1zLmxlbmd0aCAqIHRoZk1lbnVJdGVtU3ViSXRlbVNpemUpIDpcbiAgICAgICAgKHRoaXMubWF4SGVpZ2h0IC0gbWVudU9wZW5lZC5zdWJJdGVtcy5sZW5ndGggKiB0aGZNZW51SXRlbVN1Ykl0ZW1TaXplKTtcblxuICAgICAgaWYgKGFjdGl2YXRlZEJ5Um91dGUpIHtcbiAgICAgICAgdGhpcy5tYXhIZWlnaHQgPSB0aGlzLmdldE1pbmltdW1IZWlnaHQoMCwgdGhpcywgbWVudUFjdGl2ZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhY3RpdmF0ZU1lbnUobWVudTogYW55KTogdm9pZCB7XG4gICAgdGhpcy5pc1NlbGVjdGVkID0gbWVudSAmJiB0aGlzLmlkID09PSBtZW51LmlkO1xuICB9XG5cbiAgcHJpdmF0ZSBjYWxjTWVudVN1Ykl0ZW1zTWF4SGVpZ2h0KCkge1xuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgY29uc3Qgc3ViSXRlbXMgPSBBcnJheS5mcm9tKHRoaXMubWVudVN1Ykl0ZW1zLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLnRoZi1tZW51LWl0ZW0nKSk7XG4gICAgICBzdWJJdGVtcy5mb3JFYWNoKChtZW51SXRlbTogYW55KSA9PiB0aGlzLm1heEhlaWdodCArPSBtZW51SXRlbS5vZmZzZXRIZWlnaHQpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRNaW5pbXVtSGVpZ2h0KG1pbmltdW1IZWlnaHQ6IG51bWJlciwgbWVudUl0ZW06IFRoZk1lbnVJdGVtLCBtZW51QWN0aXZlOiBUaGZNZW51SXRlbSkge1xuICAgIG1pbmltdW1IZWlnaHQgKz0gdGhmTWVudUl0ZW1TdWJJdGVtU2l6ZTtcblxuICAgIGlmIChtZW51SXRlbS5zdWJJdGVtcyAmJiB0aGlzLmhhc1N1Ykl0ZW0obWVudUl0ZW0uc3ViSXRlbXMsIG1lbnVBY3RpdmVbJ2lkJ10pKSB7XG4gICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgbWVudUl0ZW0uc3ViSXRlbXMubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgIG1pbmltdW1IZWlnaHQgPSB0aGlzLmdldE1pbmltdW1IZWlnaHQobWluaW11bUhlaWdodCwgbWVudUl0ZW0uc3ViSXRlbXNbaW5kZXhdLCBtZW51QWN0aXZlKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbWluaW11bUhlaWdodDtcbiAgfVxuXG4gIHByaXZhdGUgZ3JvdXBlZE1lbnUobWVudUFjdGl2ZTogVGhmTWVudUl0ZW0sIG1lbnVPcGVuZWQ6IFRoZk1lbnVJdGVtLCBhY3RpdmF0ZWRCeVJvdXRlOiBib29sZWFuID0gZmFsc2UpOiB2b2lkIHtcblxuICAgIGNvbnN0IGhhc1N1Ykl0ZW1PcGVuZWQgPSAobWVudU9wZW5lZCAmJiB0aGlzLmlkICE9PSBtZW51T3BlbmVkWydpZCddKSA/IHRoaXMuaGFzU3ViSXRlbSh0aGlzLnN1Ykl0ZW1zLCBtZW51T3BlbmVkWydpZCddKSA6IGZhbHNlO1xuXG4gICAgdGhpcy5pc09wZW5lZCA9IHRoaXMuaXNNZW51T3BlbmVkKG1lbnVPcGVuZWQsIGhhc1N1Ykl0ZW1PcGVuZWQpO1xuXG4gICAgdGhpcy5pc1NlbGVjdGVkID0gKG1lbnVBY3RpdmUgJiYgIXRoaXMuaXNPcGVuZWQpID8gdGhpcy5oYXNTdWJJdGVtKHRoaXMuc3ViSXRlbXMsIG1lbnVBY3RpdmVbJ2lkJ10pIDogZmFsc2U7XG5cbiAgICBpZiAoIXRoaXMuaXNPcGVuZWQpIHtcbiAgICAgIHRoaXMubWF4SGVpZ2h0ID0gMDtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5hY2NvcmRpb25BbmltYXRpb24obWVudUFjdGl2ZSwgbWVudU9wZW5lZCwgaGFzU3ViSXRlbU9wZW5lZCwgYWN0aXZhdGVkQnlSb3V0ZSk7XG4gIH1cblxuICBwcml2YXRlIGhhc1N1Ykl0ZW0oc3ViSXRlbXM6IEFycmF5PFRoZk1lbnVJdGVtPiwgaWQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGlmIChzdWJJdGVtcykge1xuICAgICAgcmV0dXJuIHN1Ykl0ZW1zLnNvbWUoaXRlbSA9PiB7XG4gICAgICAgIHJldHVybiBpdGVtWydpZCddID09PSBpZCA/IHRydWUgOiB0aGlzLmhhc1N1Ykl0ZW0oaXRlbS5zdWJJdGVtcywgaWQpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpc01lbnVPcGVuZWQobWVudU9wZW5lZDogVGhmTWVudUl0ZW0sIGhhc1N1Ykl0ZW1PcGVuZWQ6IGJvb2xlYW4pOiBib29sZWFuIHtcbiAgICBpZiAobWVudU9wZW5lZCkge1xuICAgICAgcmV0dXJuICh0aGlzLmlkID09PSBtZW51T3BlbmVkWydpZCddKSA/IG1lbnVPcGVuZWRbJ2lzT3BlbmVkJ10gOiBoYXNTdWJJdGVtT3BlbmVkO1xuICAgIH1cblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHByaXZhdGUgcHJvY2Vzc01lbnVJdGVtKG1lbnUpIHtcblxuICAgIGlmICh0aGlzLnR5cGUgPT09ICdpbnRlcm5hbExpbmsnKSB7XG4gICAgICB0aGlzLmFjdGl2YXRlTWVudShtZW51LmFjdGl2ZSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHRoaXMudHlwZSA9PT0gJ3N1Ykl0ZW1zJykge1xuICAgICAgdGhpcy5ncm91cGVkTWVudShtZW51LmFjdGl2ZSwgbWVudS5ncm91cGVkLCBtZW51LmFjdGl2YXRlZEJ5Um91dGUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgfVxuXG59XG4iXX0=