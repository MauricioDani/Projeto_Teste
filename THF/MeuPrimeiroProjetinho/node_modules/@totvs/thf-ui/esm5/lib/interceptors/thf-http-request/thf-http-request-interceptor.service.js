/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { HttpResponse } from '@angular/common/http';
import { throwError } from 'rxjs';
import { catchError, tap } from 'rxjs/operators';
import { ThfComponentInjectorService } from '../../services/thf-component-injector/thf-component-injector.service';
import { ThfLoadingOverlayComponent } from '../../components/thf-loading/thf-loading-overlay/thf-loading-overlay.component';
import { ThfHttpRequesControltService } from './thf-http-request-control-service';
import * as i0 from "@angular/core";
import * as i1 from "./thf-http-request-control-service";
import * as i2 from "../../services/thf-component-injector/thf-component-injector.service";
/** @type {?} */
var noCountPendingRequests = 'X-Totvs-No-Count-Pending-Requests';
/** @type {?} */
var screenLock = 'X-Totvs-Screen-Lock';
/**
 * \@description
 *
 * O serviço Totvs Http Request Interceptor realiza a contabilização de requisições pendentes na aplicação.
 *
 * Existe a possibilidade de não efetuar a contabilização das requisições pendentes, utilizando o parâmetro
 * `X-Totvs-No-Count-Pending-Requests`. Para isso deve ser informado no cabeçalho da requisição com o valor `'true'`,
 * por exemplo:
 *
 * ```
 * ...
 *  const headers = { 'X-Totvs-No-Count-Pending-Requests': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 * Para obter a quantidade de requisições pendentes, deve inscrever-se no método `getCountPendingRequests` do
 * serviço `ThfHttpRequestInterceptorService`, com isso, ao realizar requisições utilizando `HttpClient`,
 * será retornado a quantidade de requisições pendentes.
 *
 * Também existe a possibildade de travar a tela e mostrar uma imagem de _loading_ durante o processamento de uma requisição
 * deve-se passar o parâmetro `X-Totvs-Screen-Lock` no cabeçalho da requisição com valor `'true'`.
 *
 * por exemplo:
 *
 * ```
 * ...
 *  const headers = { 'X-Totvs-Screen-Lock': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 * > Após a validação no interceptor, o parâmetro será removido do cabeçalho da requisição.
 *
 * Ao importar o módulo `ThfModule` na aplicação, o `thf-http-request-interceptor` é automaticamente configurado sem a necessidade
 * de qualquer configuração extra.
 *
 *
 * Segue abaixo um exemplo de uso:
 *
 * ```
 * import { HttpClient } from '\@angular/common/http';
 *
 * ...
 *
 * \@Injectable()
 * export class CustomersService {
 *
 *  headers = { 'X-Totvs-No-Count-Pending-Requests': true, 'X-Totvs-Screen-Lock': 'true' }
 *  pendingRequests: number = 0;
 *  subscription: Subscription;
 *
 *  constructor(
 *    private http: HttpClient,
 *    private httpRequestInterceptor: ThfHttpRequestInterceptorService) { }
 *
 *  ngOnDestroy(): void {
 *    this.subscription.unsubscribe();
 *  }
 *
 *  ngOnInit(): void {
 *    this.subscription = this.httpRequestInterceptor.getCountPendingRequests().subscribe(data => {
 *      this.pendingRequests = data;
 *    });
 *  }
 *
 *  getCustomers() {
 *    return this.http.get(`/customers/1`, { headers: headers });
 *  }
 *
 *  ...
 *
 * }
 * ```
 *
 * \@example
 * <example name='thf-http-request-interceptor-labs' title='Totvs Http Request Interceptor Labs'>
 *  <file name='sample-thf-http-request-interceptor-labs.component.ts'> </file>
 *  <file name='sample-thf-http-request-interceptor-labs.component.html'> </file>
 * </example>
 */
var ThfHttpRequestInterceptorService = /** @class */ (function () {
    function ThfHttpRequestInterceptorService(controlHttpRequest, thfComponentInjector) {
        this.controlHttpRequest = controlHttpRequest;
        this.thfComponentInjector = thfComponentInjector;
        this.loadingOverlayComponent = undefined;
        this.pendingRequests = 0;
        this.overlayRequests = 0;
    }
    /**
     * @param {?} request
     * @param {?} next
     * @return {?}
     */
    ThfHttpRequestInterceptorService.prototype.intercept = /**
     * @param {?} request
     * @param {?} next
     * @return {?}
     */
    function (request, next) {
        var _this = this;
        /** @type {?} */
        var requestClone = request.clone();
        request = this.requestCloneWithoutHeaderParam([noCountPendingRequests, screenLock], request);
        this.setCountPendingRequests(true, requestClone);
        this.setCountOverlayRequests(true, requestClone);
        return next.handle(request).pipe(tap((/**
         * @param {?} response
         * @return {?}
         */
        function (response) {
            if (response instanceof HttpResponse) {
                _this.setCountPendingRequests(false, requestClone);
                _this.setCountOverlayRequests(false, requestClone);
            }
        })), catchError((/**
         * @param {?} error
         * @return {?}
         */
        function (error) {
            _this.setCountPendingRequests(false, requestClone);
            _this.setCountOverlayRequests(false, requestClone);
            return throwError(error);
        })));
    };
    /**
     * @return {?}
     */
    ThfHttpRequestInterceptorService.prototype.getCountPendingRequests = /**
     * @return {?}
     */
    function () {
        return this.controlHttpRequest.getControlHttpRequest();
    };
    /**
     * @private
     * @return {?}
     */
    ThfHttpRequestInterceptorService.prototype.buildLoading = /**
     * @private
     * @return {?}
     */
    function () {
        if (!this.loadingOverlayComponent) {
            this.loadingOverlayComponent = this.thfComponentInjector.createComponentInApplication(ThfLoadingOverlayComponent);
            this.loadingOverlayComponent.instance.screenLock = true;
            this.loadingOverlayComponent.instance.changeDetector.detectChanges();
        }
    };
    /**
     * @private
     * @return {?}
     */
    ThfHttpRequestInterceptorService.prototype.destroyLoading = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.loadingOverlayComponent) {
            this.thfComponentInjector.destroyComponentInApplication(this.loadingOverlayComponent);
            this.loadingOverlayComponent = undefined;
        }
    };
    /**
     * @private
     * @param {?} headersParams
     * @param {?} request
     * @return {?}
     */
    ThfHttpRequestInterceptorService.prototype.requestCloneWithoutHeaderParam = /**
     * @private
     * @param {?} headersParams
     * @param {?} request
     * @return {?}
     */
    function (headersParams, request) {
        /** @type {?} */
        var isRequestClone = false;
        headersParams.forEach((/**
         * @param {?} headerParam
         * @return {?}
         */
        function (headerParam) {
            if (request.headers.has(headerParam)) {
                request.headers.delete(headerParam);
                isRequestClone = true;
            }
        }));
        return isRequestClone ? request.clone({ headers: request.headers }) : request;
    };
    /**
     * @private
     * @param {?} isIncrement
     * @param {?} request
     * @return {?}
     */
    ThfHttpRequestInterceptorService.prototype.setCountPendingRequests = /**
     * @private
     * @param {?} isIncrement
     * @param {?} request
     * @return {?}
     */
    function (isIncrement, request) {
        /** @type {?} */
        var hasCountPendingRequestHeaderParam = request.headers.has(noCountPendingRequests);
        /** @type {?} */
        var headerParam = request.headers.get(noCountPendingRequests);
        if (hasCountPendingRequestHeaderParam && (headerParam.toString().toLowerCase() === 'true')) {
            return;
        }
        this.pendingRequests += isIncrement ? 1 : -1;
        this.controlHttpRequest.send(this.pendingRequests);
    };
    /**
     * @private
     * @param {?} isIncrement
     * @param {?} request
     * @return {?}
     */
    ThfHttpRequestInterceptorService.prototype.setCountOverlayRequests = /**
     * @private
     * @param {?} isIncrement
     * @param {?} request
     * @return {?}
     */
    function (isIncrement, request) {
        /** @type {?} */
        var hasOverlayRequestHeaderParam = request.headers.has(screenLock);
        if (hasOverlayRequestHeaderParam) {
            /** @type {?} */
            var headerParam = request.headers.get(screenLock);
            if (headerParam.toString().toLowerCase() === 'false') {
                return;
            }
            this.overlayRequests += isIncrement ? 1 : -1;
            this.overlayRequests > 0 ? this.buildLoading() : this.destroyLoading();
        }
    };
    ThfHttpRequestInterceptorService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    ThfHttpRequestInterceptorService.ctorParameters = function () { return [
        { type: ThfHttpRequesControltService },
        { type: ThfComponentInjectorService }
    ]; };
    /** @nocollapse */ ThfHttpRequestInterceptorService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function ThfHttpRequestInterceptorService_Factory() { return new ThfHttpRequestInterceptorService(i0.ɵɵinject(i1.ThfHttpRequesControltService), i0.ɵɵinject(i2.ThfComponentInjectorService)); }, token: ThfHttpRequestInterceptorService, providedIn: "root" });
    return ThfHttpRequestInterceptorService;
}());
export { ThfHttpRequestInterceptorService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    ThfHttpRequestInterceptorService.prototype.loadingOverlayComponent;
    /**
     * @type {?}
     * @private
     */
    ThfHttpRequestInterceptorService.prototype.pendingRequests;
    /**
     * @type {?}
     * @private
     */
    ThfHttpRequestInterceptorService.prototype.overlayRequests;
    /**
     * @type {?}
     * @private
     */
    ThfHttpRequestInterceptorService.prototype.controlHttpRequest;
    /**
     * @type {?}
     * @private
     */
    ThfHttpRequestInterceptorService.prototype.thfComponentInjector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGhmLWh0dHAtcmVxdWVzdC1pbnRlcmNlcHRvci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHRvdHZzL3RoZi11aS8iLCJzb3VyY2VzIjpbImxpYi9pbnRlcmNlcHRvcnMvdGhmLWh0dHAtcmVxdWVzdC90aGYtaHR0cC1yZXF1ZXN0LWludGVyY2VwdG9yLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBZ0IsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pELE9BQU8sRUFBd0QsWUFBWSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFMUcsT0FBTyxFQUFjLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM5QyxPQUFPLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRWpELE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLHNFQUFzRSxDQUFDO0FBQ25ILE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLGdGQUFnRixDQUFDO0FBRTVILE9BQU8sRUFBRSw0QkFBNEIsRUFBRSxNQUFNLG9DQUFvQyxDQUFDOzs7OztJQUU1RSxzQkFBc0IsR0FBRyxtQ0FBbUM7O0lBQzVELFVBQVUsR0FBRyxxQkFBcUI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQXFGeEM7SUFVRSwwQ0FDVSxrQkFBZ0QsRUFDaEQsb0JBQWlEO1FBRGpELHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBOEI7UUFDaEQseUJBQW9CLEdBQXBCLG9CQUFvQixDQUE2QjtRQVBuRCw0QkFBdUIsR0FBNkMsU0FBUyxDQUFDO1FBRTlFLG9CQUFlLEdBQVcsQ0FBQyxDQUFDO1FBQzVCLG9CQUFlLEdBQVcsQ0FBQyxDQUFDO0lBSTRCLENBQUM7Ozs7OztJQUVqRSxvREFBUzs7Ozs7SUFBVCxVQUFVLE9BQXlCLEVBQUUs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SUFHbEMsOERBQXdEOzs7OztJQUN4RCxnRUFBeUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnRSZWYsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEh0dHBFdmVudCwgSHR0cEhhbmRsZXIsIEh0dHBJbnRlcmNlcHRvciwgSHR0cFJlcXVlc3QsIEh0dHBSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcblxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBUaGZDb21wb25lbnRJbmplY3RvclNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy90aGYtY29tcG9uZW50LWluamVjdG9yL3RoZi1jb21wb25lbnQtaW5qZWN0b3Iuc2VydmljZSc7XG5pbXBvcnQgeyBUaGZMb2FkaW5nT3ZlcmxheUNvbXBvbmVudCB9IGZyb20gJy4uLy4uL2NvbXBvbmVudHMvdGhmLWxvYWRpbmcvdGhmLWxvYWRpbmctb3ZlcmxheS90aGYtbG9hZGluZy1vdmVybGF5LmNvbXBvbmVudCc7XG5cbmltcG9ydCB7IFRoZkh0dHBSZXF1ZXNDb250cm9sdFNlcnZpY2UgfSBmcm9tICcuL3RoZi1odHRwLXJlcXVlc3QtY29udHJvbC1zZXJ2aWNlJztcblxuY29uc3Qgbm9Db3VudFBlbmRpbmdSZXF1ZXN0cyA9ICdYLVRvdHZzLU5vLUNvdW50LVBlbmRpbmctUmVxdWVzdHMnO1xuY29uc3Qgc2NyZWVuTG9jayA9ICdYLVRvdHZzLVNjcmVlbi1Mb2NrJztcblxuLyoqXG4gKiBAZGVzY3JpcHRpb25cbiAqXG4gKiBPIHNlcnZpw6dvIFRvdHZzIEh0dHAgUmVxdWVzdCBJbnRlcmNlcHRvciByZWFsaXphIGEgY29udGFiaWxpemHDp8OjbyBkZSByZXF1aXNpw6fDtWVzIHBlbmRlbnRlcyBuYSBhcGxpY2HDp8Ojby5cbiAqXG4gKiBFeGlzdGUgYSBwb3NzaWJpbGlkYWRlIGRlIG7Do28gZWZldHVhciBhIGNvbnRhYmlsaXphw6fDo28gZGFzIHJlcXVpc2nDp8O1ZXMgcGVuZGVudGVzLCB1dGlsaXphbmRvIG8gcGFyw6JtZXRyb1xuICogYFgtVG90dnMtTm8tQ291bnQtUGVuZGluZy1SZXF1ZXN0c2AuIFBhcmEgaXNzbyBkZXZlIHNlciBpbmZvcm1hZG8gbm8gY2FiZcOnYWxobyBkYSByZXF1aXNpw6fDo28gY29tIG8gdmFsb3IgYCd0cnVlJ2AsXG4gKiBwb3IgZXhlbXBsbzpcbiAqXG4gKiBgYGBcbiAqIC4uLlxuICogIGNvbnN0IGhlYWRlcnMgPSB7ICdYLVRvdHZzLU5vLUNvdW50LVBlbmRpbmctUmVxdWVzdHMnOiAndHJ1ZScgfTtcbiAqXG4gKiAgdGhpcy5odHRwLmdldChgL2N1c3RvbWVycy8xYCwgeyBoZWFkZXJzOiBoZWFkZXJzIH0pO1xuICogLi4uXG4gKlxuICogYGBgXG4gKiBQYXJhIG9idGVyIGEgcXVhbnRpZGFkZSBkZSByZXF1aXNpw6fDtWVzIHBlbmRlbnRlcywgZGV2ZSBpbnNjcmV2ZXItc2Ugbm8gbcOpdG9kbyBgZ2V0Q291bnRQZW5kaW5nUmVxdWVzdHNgIGRvXG4gKiBzZXJ2acOnbyBgVGhmSHR0cFJlcXVlc3RJbnRlcmNlcHRvclNlcnZpY2VgLCBjb20gaXNzbywgYW8gcmVhbGl6YXIgcmVxdWlzacOnw7VlcyB1dGlsaXphbmRvIGBIdHRwQ2xpZW50YCxcbiAqIHNlcsOhIHJldG9ybmFkbyBhIHF1YW50aWRhZGUgZGUgcmVxdWlzacOnw7VlcyBwZW5kZW50ZXMuXG4gKlxuICogVGFtYsOpbSBleGlzdGUgYSBwb3NzaWJpbGRhZGUgZGUgdHJhdmFyIGEgdGVsYSBlIG1vc3RyYXIgdW1hIGltYWdlbSBkZSBfbG9hZGluZ18gZHVyYW50ZSBvIHByb2Nlc3NhbWVudG8gZGUgdW1hIHJlcXVpc2nDp8Ojb1xuICogZGV2ZS1zZSBwYXNzYXIgbyBwYXLDom1ldHJvIGBYLVRvdHZzLVNjcmVlbi1Mb2NrYCBubyBjYWJlw6dhbGhvIGRhIHJlcXVpc2nDp8OjbyBjb20gdmFsb3IgYCd0cnVlJ2AuXG4gKlxuICogcG9yIGV4ZW1wbG86XG4gKlxuICogYGBgXG4gKiAuLi5cbiAqICBjb25zdCBoZWFkZXJzID0geyAnWC1Ub3R2cy1TY3JlZW4tTG9jayc6ICd0cnVlJyB9O1xuICpcbiAqICB0aGlzLmh0dHAuZ2V0KGAvY3VzdG9tZXJzLzFgLCB7IGhlYWRlcnM6IGhlYWRlcnMgfSk7XG4gKiAuLi5cbiAqXG4gKiBgYGBcbiAqID4gQXDDs3MgYSB2YWxpZGHDp8OjbyBubyBpbnRlcmNlcHRvciwgbyBwYXLDom1ldHJvIHNlcsOhIHJlbW92aWRvIGRvIGNhYmXDp2FsaG8gZGEgcmVxdWlzacOnw6NvLlxuICpcbiAqIEFvIGltcG9ydGFyIG8gbcOzZHVsbyBgVGhmTW9kdWxlYCBuYSBhcGxpY2HDp8OjbywgbyBgdGhmLWh0dHAtcmVxdWVzdC1pbnRlcmNlcHRvcmAgw6kgYXV0b21hdGljYW1lbnRlIGNvbmZpZ3VyYWRvIHNlbSBhIG5lY2Vzc2lkYWRlXG4gKiBkZSBxdWFscXVlciBjb25maWd1cmHDp8OjbyBleHRyYS5cbiAqXG4gKlxuICogU2VndWUgYWJhaXhvIHVtIGV4ZW1wbG8gZGUgdXNvOlxuICpcbiAqIGBgYFxuICogaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbiAqXG4gKiAuLi5cbiAqXG4gKiBASW5qZWN0YWJsZSgpXG4gKiBleHBvcnQgY2xhc3MgQ3VzdG9tZXJzU2VydmljZSB7XG4gKlxuICogIGhlYWRlcnMgPSB7ICdYLVRvdHZzLU5vLUNvdW50LVBlbmRpbmctUmVxdWVzdHMnOiB0cnVlLCAnWC1Ub3R2cy1TY3JlZW4tTG9jayc6ICd0cnVlJyB9XG4gKiAgcGVuZGluZ1JlcXVlc3RzOiBudW1iZXIgPSAwO1xuICogIHN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuICpcbiAqICBjb25zdHJ1Y3RvcihcbiAqICAgIHByaXZhdGUgaHR0cDogSHR0cENsaWVudCxcbiAqICAgIHByaXZhdGUgaHR0cFJlcXVlc3RJbnRlcmNlcHRvcjogVGhmSHR0cFJlcXVlc3RJbnRlcmNlcHRvclNlcnZpY2UpIHsgfVxuICpcbiAqICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAqICAgIHRoaXMuc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gKiAgfVxuICpcbiAqICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAqICAgIHRoaXMuc3Vic2NyaXB0aW9uID0gdGhpcy5odHRwUmVxdWVzdEludGVyY2VwdG9yLmdldENvdW50UGVuZGluZ1JlcXVlc3RzKCkuc3Vic2NyaWJlKGRhdGEgPT4ge1xuICogICAgICB0aGlzLnBlbmRpbmdSZXF1ZXN0cyA9IGRhdGE7XG4gKiAgICB9KTtcbiAqICB9XG4gKlxuICogIGdldEN1c3RvbWVycygpIHtcbiAqICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KGAvY3VzdG9tZXJzLzFgLCB7IGhlYWRlcnM6IGhlYWRlcnMgfSk7XG4gKiAgfVxuICpcbiAqICAuLi5cbiAqXG4gKiB9XG4gKiBgYGBcbiAqXG4gKiBAZXhhbXBsZVxuICogPGV4YW1wbGUgbmFtZT0ndGhmLWh0dHAtcmVxdWVzdC1pbnRlcmNlcHRvci1sYWJzJyB0aXRsZT0nVG90dnMgSHR0cCBSZXF1ZXN0IEludGVyY2VwdG9yIExhYnMnPlxuICogIDxmaWxlIG5hbWU9J3NhbXBsZS10aGYtaHR0cC1yZXF1ZXN0LWludGVyY2VwdG9yLWxhYnMuY29tcG9uZW50LnRzJz4gPC9maWxlPlxuICogIDxmaWxlIG5hbWU9J3NhbXBsZS10aGYtaHR0cC1yZXF1ZXN0LWludGVyY2VwdG9yLWxhYnMuY29tcG9uZW50Lmh0bWwnPiA8L2ZpbGU+XG4gKiA8L2V4YW1wbGU+XG4gKi9cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFRoZkh0dHBSZXF1ZXN0SW50ZXJjZXB0b3JTZXJ2aWNlIGltcGxlbWVudHMgSHR0cEludGVyY2VwdG9yIHtcblxuICBwcml2YXRlIGxvYWRpbmdPdmVybGF5Q29tcG9uZW50OiBDb21wb25lbnRSZWY8VGhmTG9hZGluZ092ZXJsYXlDb21wb25lbnQ+ID0gdW5kZWZpbmVkO1xuXG4gIHByaXZhdGUgcGVuZGluZ1JlcXVlc3RzOiBudW1iZXIgPSAwO1xuICBwcml2YXRlIG92ZXJsYXlSZXF1ZXN0czogbnVtYmVyID0gMDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGNvbnRyb2xIdHRwUmVxdWVzdDogVGhmSHR0cFJlcXVlc0NvbnRyb2x0U2VydmljZSxcbiAgICBwcml2YXRlIHRoZkNvbXBvbmVudEluamVjdG9yOiBUaGZDb21wb25lbnRJbmplY3RvclNlcnZpY2UpIHsgIH1cblxuICBpbnRlcmNlcHQocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55PiwgbmV4dDogSHR0cEhhbmRsZXIpIHtcblxuICAgIGNvbnN0IHJlcXVlc3RDbG9uZSA9IHJlcXVlc3QuY2xvbmUoKTtcblxuICAgIHJlcXVlc3QgPSB0aGlzLnJlcXVlc3RDbG9uZVdpdGhvdXRIZWFkZXJQYXJhbShbbm9Db3VudFBlbmRpbmdSZXF1ZXN0cywgc2NyZWVuTG9ja10sIHJlcXVlc3QpO1xuXG4gICAgdGhpcy5zZXRDb3VudFBlbmRpbmdSZXF1ZXN0cyh0cnVlLCByZXF1ZXN0Q2xvbmUpO1xuICAgIHRoaXMuc2V0Q291bnRPdmVybGF5UmVxdWVzdHModHJ1ZSwgcmVxdWVzdENsb25lKTtcblxuICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXF1ZXN0KS5waXBlKFxuICAgICAgdGFwKChyZXNwb25zZTogSHR0cEV2ZW50PGFueT4pID0+IHtcbiAgICAgICAgaWYgKHJlc3BvbnNlIGluc3RhbmNlb2YgSHR0cFJlc3BvbnNlKSB7XG4gICAgICAgICAgdGhpcy5zZXRDb3VudFBlbmRpbmdSZXF1ZXN0cyhmYWxzZSwgcmVxdWVzdENsb25lKTtcbiAgICAgICAgICB0aGlzLnNldENvdW50T3ZlcmxheVJlcXVlc3RzKGZhbHNlLCByZXF1ZXN0Q2xvbmUpO1xuICAgICAgICB9XG4gICAgICB9KSxcbiAgICAgIGNhdGNoRXJyb3IoZXJyb3IgPT4ge1xuICAgICAgICB0aGlzLnNldENvdW50UGVuZGluZ1JlcXVlc3RzKGZhbHNlLCByZXF1ZXN0Q2xvbmUpO1xuICAgICAgICB0aGlzLnNldENvdW50T3ZlcmxheVJlcXVlc3RzKGZhbHNlLCByZXF1ZXN0Q2xvbmUpO1xuXG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGVycm9yKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIGdldENvdW50UGVuZGluZ1JlcXVlc3RzKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIHRoaXMuY29udHJvbEh0dHBSZXF1ZXN0LmdldENvbnRyb2xIdHRwUmVxdWVzdCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZExvYWRpbmcoKSB7XG4gICAgaWYgKCF0aGlzLmxvYWRpbmdPdmVybGF5Q29tcG9uZW50KSB7XG4gICAgICB0aGlzLmxvYWRpbmdPdmVybGF5Q29tcG9uZW50ID0gdGhpcy50aGZDb21wb25lbnRJbmplY3Rvci5jcmVhdGVDb21wb25lbnRJbkFwcGxpY2F0aW9uKFRoZkxvYWRpbmdPdmVybGF5Q29tcG9uZW50KTtcbiAgICAgIHRoaXMubG9hZGluZ092ZXJsYXlDb21wb25lbnQuaW5zdGFuY2Uuc2NyZWVuTG9jayA9IHRydWU7XG4gICAgICB0aGlzLmxvYWRpbmdPdmVybGF5Q29tcG9uZW50Lmluc3RhbmNlLmNoYW5nZURldGVjdG9yLmRldGVjdENoYW5nZXMoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGRlc3Ryb3lMb2FkaW5nKCkge1xuICAgIGlmICh0aGlzLmxvYWRpbmdPdmVybGF5Q29tcG9uZW50KSB7XG4gICAgICB0aGlzLnRoZkNvbXBvbmVudEluamVjdG9yLmRlc3Ryb3lDb21wb25lbnRJbkFwcGxpY2F0aW9uKHRoaXMubG9hZGluZ092ZXJsYXlDb21wb25lbnQpO1xuICAgICAgdGhpcy5sb2FkaW5nT3ZlcmxheUNvbXBvbmVudCA9IHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlcXVlc3RDbG9uZVdpdGhvdXRIZWFkZXJQYXJhbShoZWFkZXJzUGFyYW1zOiBBcnJheTxzdHJpbmc+LCByZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KTogSHR0cFJlcXVlc3Q8YW55PiB7XG4gICAgbGV0IGlzUmVxdWVzdENsb25lID0gZmFsc2U7XG5cbiAgICBoZWFkZXJzUGFyYW1zLmZvckVhY2goaGVhZGVyUGFyYW0gPT4ge1xuICAgICAgaWYgKHJlcXVlc3QuaGVhZGVycy5oYXMoaGVhZGVyUGFyYW0pKSB7XG4gICAgICAgIHJlcXVlc3QuaGVhZGVycy5kZWxldGUoaGVhZGVyUGFyYW0pO1xuICAgICAgICBpc1JlcXVlc3RDbG9uZSA9IHRydWU7XG4gICAgICB9XG5cbiAgICB9KTtcblxuICAgIHJldHVybiBpc1JlcXVlc3RDbG9uZSA/IHJlcXVlc3QuY2xvbmUoe2hlYWRlcnM6IHJlcXVlc3QuaGVhZGVyc30pIDogcmVxdWVzdDtcbiAgfVxuXG4gIHByaXZhdGUgc2V0Q291bnRQZW5kaW5nUmVxdWVzdHMoaXNJbmNyZW1lbnQ6IGJvb2xlYW4sIHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pIHtcblxuICAgIGNvbnN0IGhhc0NvdW50UGVuZGluZ1JlcXVlc3RIZWFkZXJQYXJhbSA9IHJlcXVlc3QuaGVhZGVycy5oYXMobm9Db3VudFBlbmRpbmdSZXF1ZXN0cyk7XG4gICAgY29uc3QgaGVhZGVyUGFyYW0gPSByZXF1ZXN0LmhlYWRlcnMuZ2V0KG5vQ291bnRQZW5kaW5nUmVxdWVzdHMpO1xuXG4gICAgaWYgKGhhc0NvdW50UGVuZGluZ1JlcXVlc3RIZWFkZXJQYXJhbSAmJiAoaGVhZGVyUGFyYW0udG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpID09PSAndHJ1ZScgKSApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLnBlbmRpbmdSZXF1ZXN0cyArPSBpc0luY3JlbWVudCA/IDEgOiAtMTtcbiAgICB0aGlzLmNvbnRyb2xIdHRwUmVxdWVzdC5zZW5kKHRoaXMucGVuZGluZ1JlcXVlc3RzKTtcblxuICB9XG5cbiAgcHJpdmF0ZSBzZXRDb3VudE92ZXJsYXlSZXF1ZXN0cyhpc0luY3JlbWVudDogYm9vbGVhbiwgcmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pikge1xuICAgIGNvbnN0IGhhc092ZXJsYXlSZXF1ZXN0SGVhZGVyUGFyYW0gPSByZXF1ZXN0LmhlYWRlcnMuaGFzKHNjcmVlbkxvY2spO1xuXG4gICAgaWYgKGhhc092ZXJsYXlSZXF1ZXN0SGVhZGVyUGFyYW0pIHtcbiAgICAgIGNvbnN0IGhlYWRlclBhcmFtID0gcmVxdWVzdC5oZWFkZXJzLmdldChzY3JlZW5Mb2NrKTtcblxuICAgICAgaWYgKGhlYWRlclBhcmFtLnRvU3RyaW5nKCkudG9Mb3dlckNhc2UoKSA9PT0gJ2ZhbHNlJykge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIHRoaXMub3ZlcmxheVJlcXVlc3RzICs9IGlzSW5jcmVtZW50ID8gMSA6IC0xO1xuICAgICAgdGhpcy5vdmVybGF5UmVxdWVzdHMgPiAwID8gdGhpcy5idWlsZExvYWRpbmcoKSA6IHRoaXMuZGVzdHJveUxvYWRpbmcoKTtcbiAgICB9XG4gIH1cblxufVxuIl19