/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { ChangeDetectorRef, Component, ElementRef, Renderer2, ViewChild } from '@angular/core';
import { v4 as uuid } from 'uuid';
import { ThfModalBaseComponent } from './thf-modal-base.component';
import { ThfModalService } from './thf-modal-service';
/**
 * \@docsExtends ThfModalBaseComponent
 *
 * \@example
 *
 * <example name="thf-modal-basic" title="Totvs Modal Basic">
 *  <file name="sample-thf-modal-basic/sample-thf-modal-basic.component.html"> </file>
 *  <file name="sample-thf-modal-basic/sample-thf-modal-basic.component.ts"> </file>
 * </example>
 *
 * <example name="thf-modal-labs" title="Totvs Modal Labs">
 *  <file name="sample-thf-modal-labs/sample-thf-modal-labs.component.html"> </file>
 *  <file name="sample-thf-modal-labs/sample-thf-modal-labs.component.ts"> </file>
 * </example>
 *
 * <example name="thf-modal-fruits-salad" title="Totvs Modal - Fruits Salad">
 *  <file name="sample-thf-modal-fruits-salad/sample-thf-modal-fruits-salad.component.html"> </file>
 *  <file name="sample-thf-modal-fruits-salad/sample-thf-modal-fruits-salad.component.ts"> </file>
 * </example>
 */
var ThfModalComponent = /** @class */ (function (_super) {
    tslib_1.__extends(ThfModalComponent, _super);
    function ThfModalComponent(thfModalService, renderer, changeDetector) {
        var _this = _super.call(this) || this;
        _this.thfModalService = thfModalService;
        _this.renderer = renderer;
        _this.changeDetector = changeDetector;
        _this.focusableElements = 'input, select, textarea, button:not([disabled]), a';
        _this.id = uuid();
        return _this;
    }
    /**
     * @param {?=} xClosed
     * @return {?}
     */
    ThfModalComponent.prototype.close = /**
     * @param {?=} xClosed
     * @return {?}
     */
    function (xClosed) {
        if (xClosed === void 0) { xClosed = false; }
        this.thfModalService.modalActive = undefined;
        _super.prototype.close.call(this, xClosed);
        this.removeEventListeners();
        if (this.sourceElement) {
            this.sourceElement.focus();
        }
    };
    /**
     * @param {?} event
     * @return {?}
     */
    ThfModalComponent.prototype.closeModalOnEscapeKey = /**
     * @param {?} event
     * @return {?}
     */
    function (event) {
        if (!this.hideClose) {
            event.preventDefault();
            event.stopPropagation();
            this.close();
        }
    };
    /**
     * @return {?}
     */
    ThfModalComponent.prototype.getPrimaryActionButtonType = /**
     * @return {?}
     */
    function () {
        return this.primaryAction.danger ? 'danger' : 'primary';
    };
    /**
     * @return {?}
     */
    ThfModalComponent.prototype.getSecondaryActionButtonType = /**
     * @return {?}
     */
    function () {
        return this.secondaryAction && this.secondaryAction.danger && !this.primaryAction.danger ? 'danger' : 'default';
    };
    /**
     * @param {?} event
     * @return {?}
     */
    ThfModalComponent.prototype.onClickOut = /**
     * @param {?} event
     * @return {?}
     */
    function (event) {
        if (this.clickOut && !this.modalContent.nativeElement.contains(event.target)) {
            this.close();
        }
    };
    /**
     * @return {?}
     */
    ThfModalComponent.prototype.open = /**
     * @return {?}
     */
    function () {
        this.sourceElement = document.activeElement;
        _super.prototype.open.call(this);
        this.handleFocus();
    };
    /**
     * @private
     * @return {?}
     */
    ThfModalComponent.prototype.handleFocus = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        this.thfModalService.modalActive = this.id;
        setTimeout((/**
         * @return {?}
         */
        function () {
            if (_this.modalContent) {
                _this.initFocus();
                document.addEventListener('focus', _this.focusFunction, true);
            }
        }));
    };
    /**
     * @private
     * @return {?}
     */
    ThfModalComponent.prototype.initFocus = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        this.focusFunction = (/**
         * @param {?} event
         * @return {?}
         */
        function (event) {
            _this.thfModalService.modalActive = _this.thfModalService.modalActive || _this.id;
            /** @type {?} */
            var modalElement = _this.modalContent.nativeElement;
            if (!modalElement.contains(event.target) && _this.thfModalService.modalActive === _this.id) {
                event.stopPropagation();
                _this.firstElement.focus();
            }
        });
        this.setFirstElement();
        if (this.hideClose) {
            this.firstElement.focus();
        }
        else {
            /** @type {?} */
            var firstFieldElement = this.modalContent.nativeElement.querySelectorAll(this.focusableElements)[1] ||
                this.modalContent.nativeElement;
            firstFieldElement.focus();
        }
    };
    /**
     * @private
     * @return {?}
     */
    ThfModalComponent.prototype.removeEventListeners = /**
     * @private
     * @return {?}
     */
    function () {
        document.removeEventListener('focus', this.focusFunction, true);
    };
    /**
     * @private
     * @return {?}
     */
    ThfModalComponent.prototype.setFirstElement = /**
     * @private
     * @return {?}
     */
    function () {
        this.firstElement = this.modalContent.nativeElement.querySelector(this.focusableElements) || this.modalContent.nativeElement;
    };
    ThfModalComponent.decorators = [
        { type: Component, args: [{
                    selector: 'thf-modal',
                    template: "<div *ngIf=\"!isHidden\"\n  class=\"thf-modal\"\n  tabindex=\"0\"\n  (keydown.esc)=\"closeModalOnEscapeKey($event)\">\n\n  <div class=\"thf-modal-overlay\">\n    <div class=\"thf-modal-container thf-pb-2 thf-pt-2\" (click)=\"onClickOut($event)\">\n\n      <div class=\"thf-modal-vertical-align\">\n        <div #modalContent\n          class=\"thf-modal-content thf-modal-{{ size }}\"\n          tabindex=\"-1\">\n\n          <div class=\"thf-modal-header\">\n            <div class=\"thf-modal-title thf-text-ellipsis\">\n              {{ title }}\n            </div>\n\n            <a *ngIf=\"!hideClose\"\n              class=\"thf-modal-header-close-button\"\n              tabindex=\"0\"\n              (click)=\"close(true)\">\n              <span class=\"thf-icon thf-icon-close\"></span>\n            </a>\n          </div>\n\n          <div class=\"thf-modal-body\">\n            <ng-content></ng-content>\n          </div>\n\n          <div class=\"thf-modal-footer\">\n            <thf-button *ngIf=\"secondaryAction\"\n              [t-disabled]=\"secondaryAction.disabled\"\n              [t-label]=\"secondaryAction.label\"\n              [t-loading]=\"secondaryAction.loading\"\n              [t-type]=\"getSecondaryActionButtonType()\"\n              (t-click)=\"secondaryAction.action()\">\n            </thf-button>\n\n            <thf-button\n              class=\"thf-button-modal-first-action\"\n              [t-disabled]=\"primaryAction.disabled\"\n              [t-label]=\"primaryAction.label\"\n              [t-loading]=\"primaryAction.loading\"\n              [t-type]=\"getPrimaryActionButtonType()\"\n              (t-click)=\"primaryAction.action()\">\n            </thf-button>\n          </div>\n\n        </div>\n      </div>\n\n    </div>\n  </div>\n</div>\n\n"
                }] }
    ];
    /** @nocollapse */
    ThfModalComponent.ctorParameters = function () { return [
        { type: ThfModalService },
        { type: Renderer2 },
        { type: ChangeDetectorRef }
    ]; };
    ThfModalComponent.propDecorators = {
        modalContent: [{ type: ViewChild, args: ['modalContent', { read: ElementRef, static: false },] }]
    };
    return ThfModalComponent;
}(ThfModalBaseComponent));
export { ThfModalComponent };
if (false) {
    /** @type {?} */
    ThfModalComponent.prototype.modalContent;
    /**
     * @type {?}
     * @private
     */
    ThfModalComponent.prototype.firstElement;
    /**
     * @type {?}
     * @private
     */
    ThfModalComponent.prototype.focusFunction;
    /**
     * @type {?}
     * @private
     */
    ThfModalComponent.prototype.focusableElements;
    /**
     * @type {?}
     * @private
     */
    ThfModalComponent.prototype.id;
    /**
     * @type {?}
     * @private
     */
    ThfModalComponent.prototype.sourceElement;
    /** @type {?} */
    ThfModalComponent.prototype.onResizeListener;
    /**
     * @type {?}
     * @private
     */
    ThfModalComponent.prototype.thfModalService;
    /**
     * @type {?}
     * @private
     */
    ThfModalComponent.prototype.renderer;
    /**
     * @type {?}
     * @private
     */
    ThfModalComponent.prototype.changeDetector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGhmLW1vZGFsLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B0b3R2cy90aGYtdWkvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy90aGYtbW9kYWwvdGhmLW1vZGFsLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFL0YsT0FBTyxFQUFFLEVBQUUsSUFBSSxJQUFJLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFbEMsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDbkUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUF1QnREO0lBSXVDLDZDQUFxQjtJQVkxRCwyQkFBb0IsZUFBZ0MsRUFBVSxRQUFtQixFQUFVLGNBQWlDO1FBQTVILFlBQ0UsaUJBQU8sU0FDUjtRQUZtQixxQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFBVSxjQUFRLEdBQVIsUUFBUSxDQUFXO1FBQVUsb0JBQWMsR0FBZCxjQUFjLENBQW1CO1FBTnBILHVCQUFpQixHQUFHLG9EQUFvRCxDQUFDO1FBQ3pFLFFBQUUsR0FBVyxJQUFJLEVBQUUsQ0FBQzs7SUFPNUIsQ0FBQzs7Ozs7SUFFRCxpQ0FBSzs7OztJQUFMLFVBQU0sT0FBZTtRQUFmLHdCQUFBLEVBQUEsZUFBZTtRQUNuQixJQUFJLENBQUMsZUFBZSxDQUFDLFdBQVcsR0FBRyxTQUFTLENBQUM7UUFFN0MsaUJBQU0sS0FBSyxZQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXJCLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1FBRTVCLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRTtZQUN0QixJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxDQUFDO1NBQzVCO0lBQ0gs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QUFRLENBQUMsbUJBQW1CLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDbEUsQ0FBQzs7Ozs7SUFFTywyQ0FBZTs7OztJQUF2QjtRQUNFLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDO0lBQy9ILENBQUM7O2dCQXRHRixTQUFTLFNBQUM7b0JBQ1QsUUFBUSxFQUFFLFdBQVc7b0JBQ3JCLCt3REFBeUM7aUJBQzFDOzs7O2dCQTFCUSxlQUFlO2dCQUwyQixTQUFTO2dCQUFuRCxpQkFBaUI7OzsrQkFrQ3ZCLFNBQVMsU0FBQyxjQUFjLEVBQUUsRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUU7O0lBa0doRSx3QkFBQztDQUFBLEFBeEdELENBSXVDLHFCQUFxQixHQW9HM0Q7U0FwR1ksaUJBQWlCOzs7SUFFNUIseUNBQXlGOzs7OztJQUV6Rix5Q0FBcUI7Ozs7O0lBQ3JCLDBDQUFzQjs7Ozs7SUFDdEIsOENBQWlGOzs7OztJQUNqRiwrQkFBNEI7Ozs7O0lBQzVCLDBDQUFzQjs7SUFFdEIsNkNBQTZCOzs7OztJQUVqQiw0Q0FBd0M7Ozs7O0lBQUUscUNBQTJCOzs7OztJQUFFLDJDQUF5QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENoYW5nZURldGVjdG9yUmVmLCBDb21wb25lbnQsIEVsZW1lbnRSZWYsIFJlbmRlcmVyMiwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IHY0IGFzIHV1aWQgfSBmcm9tICd1dWlkJztcblxuaW1wb3J0IHsgVGhmTW9kYWxCYXNlQ29tcG9uZW50IH0gZnJvbSAnLi90aGYtbW9kYWwtYmFzZS5jb21wb25lbnQnO1xuaW1wb3J0IHsgVGhmTW9kYWxTZXJ2aWNlIH0gZnJvbSAnLi90aGYtbW9kYWwtc2VydmljZSc7XG5cbi8qKlxuICogQGRvY3NFeHRlbmRzIFRoZk1vZGFsQmFzZUNvbXBvbmVudFxuICpcbiAqIEBleGFtcGxlXG4gKlxuICogPGV4YW1wbGUgbmFtZT1cInRoZi1tb2RhbC1iYXNpY1wiIHRpdGxlPVwiVG90dnMgTW9kYWwgQmFzaWNcIj5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXRoZi1tb2RhbC1iYXNpYy9zYW1wbGUtdGhmLW1vZGFsLWJhc2ljLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXRoZi1tb2RhbC1iYXNpYy9zYW1wbGUtdGhmLW1vZGFsLWJhc2ljLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XG4gKiA8L2V4YW1wbGU+XG4gKlxuICogPGV4YW1wbGUgbmFtZT1cInRoZi1tb2RhbC1sYWJzXCIgdGl0bGU9XCJUb3R2cyBNb2RhbCBMYWJzXCI+XG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS10aGYtbW9kYWwtbGFicy9zYW1wbGUtdGhmLW1vZGFsLWxhYnMuY29tcG9uZW50Lmh0bWxcIj4gPC9maWxlPlxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtdGhmLW1vZGFsLWxhYnMvc2FtcGxlLXRoZi1tb2RhbC1sYWJzLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XG4gKiA8L2V4YW1wbGU+XG4gKlxuICogPGV4YW1wbGUgbmFtZT1cInRoZi1tb2RhbC1mcnVpdHMtc2FsYWRcIiB0aXRsZT1cIlRvdHZzIE1vZGFsIC0gRnJ1aXRzIFNhbGFkXCI+XG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS10aGYtbW9kYWwtZnJ1aXRzLXNhbGFkL3NhbXBsZS10aGYtbW9kYWwtZnJ1aXRzLXNhbGFkLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXRoZi1tb2RhbC1mcnVpdHMtc2FsYWQvc2FtcGxlLXRoZi1tb2RhbC1mcnVpdHMtc2FsYWQuY29tcG9uZW50LnRzXCI+IDwvZmlsZT5cbiAqIDwvZXhhbXBsZT5cbiAqL1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICd0aGYtbW9kYWwnLFxuICB0ZW1wbGF0ZVVybDogJy4vdGhmLW1vZGFsLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBUaGZNb2RhbENvbXBvbmVudCBleHRlbmRzIFRoZk1vZGFsQmFzZUNvbXBvbmVudCB7XG5cbiAgQFZpZXdDaGlsZCgnbW9kYWxDb250ZW50JywgeyByZWFkOiBFbGVtZW50UmVmLCBzdGF0aWM6IGZhbHNlIH0pIG1vZGFsQ29udGVudDogRWxlbWVudFJlZjtcblxuICBwcml2YXRlIGZpcnN0RWxlbWVudDtcbiAgcHJpdmF0ZSBmb2N1c0Z1bmN0aW9uO1xuICBwcml2YXRlIGZvY3VzYWJsZUVsZW1lbnRzID0gJ2lucHV0LCBzZWxlY3QsIHRleHRhcmVhLCBidXR0b246bm90KFtkaXNhYmxlZF0pLCBhJztcbiAgcHJpdmF0ZSBpZDogc3RyaW5nID0gdXVpZCgpO1xuICBwcml2YXRlIHNvdXJjZUVsZW1lbnQ7XG5cbiAgb25SZXNpemVMaXN0ZW5lcjogKCkgPT4gdm9pZDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHRoZk1vZGFsU2VydmljZTogVGhmTW9kYWxTZXJ2aWNlLCBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsIHByaXZhdGUgY2hhbmdlRGV0ZWN0b3I6IENoYW5nZURldGVjdG9yUmVmKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIGNsb3NlKHhDbG9zZWQgPSBmYWxzZSkge1xuICAgIHRoaXMudGhmTW9kYWxTZXJ2aWNlLm1vZGFsQWN0aXZlID0gdW5kZWZpbmVkO1xuXG4gICAgc3VwZXIuY2xvc2UoeENsb3NlZCk7XG5cbiAgICB0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXJzKCk7XG5cbiAgICBpZiAodGhpcy5zb3VyY2VFbGVtZW50KSB7XG4gICAgICB0aGlzLnNvdXJjZUVsZW1lbnQuZm9jdXMoKTtcbiAgICB9XG4gIH1cblxuICBjbG9zZU1vZGFsT25Fc2NhcGVLZXkoZXZlbnQpIHtcbiAgICBpZiAoIXRoaXMuaGlkZUNsb3NlKSB7XG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICB0aGlzLmNsb3NlKCk7XG4gICAgfVxuICB9XG5cbiAgZ2V0UHJpbWFyeUFjdGlvbkJ1dHRvblR5cGUoKSB7XG4gICAgcmV0dXJuIHRoaXMucHJpbWFyeUFjdGlvbi5kYW5nZXIgPyAnZGFuZ2VyJyA6ICdwcmltYXJ5JztcbiAgfVxuXG4gIGdldFNlY29uZGFyeUFjdGlvbkJ1dHRvblR5cGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuc2Vjb25kYXJ5QWN0aW9uICYmIHRoaXMuc2Vjb25kYXJ5QWN0aW9uLmRhbmdlciAmJiAhdGhpcy5wcmltYXJ5QWN0aW9uLmRhbmdlciA/ICdkYW5nZXInIDogJ2RlZmF1bHQnO1xuICB9XG5cbiAgb25DbGlja091dChldmVudCkge1xuICAgIGlmICh0aGlzLmNsaWNrT3V0ICYmICF0aGlzLm1vZGFsQ29udGVudC5uYXRpdmVFbGVtZW50LmNvbnRhaW5zKGV2ZW50LnRhcmdldCkpIHtcbiAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICB9XG4gIH1cblxuICBvcGVuKCkge1xuICAgIHRoaXMuc291cmNlRWxlbWVudCA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7XG5cbiAgICBzdXBlci5vcGVuKCk7XG5cbiAgICB0aGlzLmhhbmRsZUZvY3VzKCk7XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZUZvY3VzKCk6IGFueSB7XG4gICAgdGhpcy50aGZNb2RhbFNlcnZpY2UubW9kYWxBY3RpdmUgPSB0aGlzLmlkO1xuXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBpZiAodGhpcy5tb2RhbENvbnRlbnQpIHtcbiAgICAgICAgdGhpcy5pbml0Rm9jdXMoKTtcbiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZm9jdXMnLCB0aGlzLmZvY3VzRnVuY3Rpb24sIHRydWUpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0Rm9jdXMoKSB7XG4gICAgdGhpcy5mb2N1c0Z1bmN0aW9uID0gKGV2ZW50OiBhbnkpID0+IHtcbiAgICAgIHRoaXMudGhmTW9kYWxTZXJ2aWNlLm1vZGFsQWN0aXZlID0gdGhpcy50aGZNb2RhbFNlcnZpY2UubW9kYWxBY3RpdmUgfHwgdGhpcy5pZDtcbiAgICAgIGNvbnN0IG1vZGFsRWxlbWVudCA9IHRoaXMubW9kYWxDb250ZW50Lm5hdGl2ZUVsZW1lbnQ7XG5cbiAgICAgIGlmICghbW9kYWxFbGVtZW50LmNvbnRhaW5zKGV2ZW50LnRhcmdldCkgJiYgdGhpcy50aGZNb2RhbFNlcnZpY2UubW9kYWxBY3RpdmUgPT09IHRoaXMuaWQpIHtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIHRoaXMuZmlyc3RFbGVtZW50LmZvY3VzKCk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHRoaXMuc2V0Rmlyc3RFbGVtZW50KCk7XG5cbiAgICBpZiAodGhpcy5oaWRlQ2xvc2UpIHtcbiAgICAgIHRoaXMuZmlyc3RFbGVtZW50LmZvY3VzKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGZpcnN0RmllbGRFbGVtZW50ID1cbiAgICAgICAgdGhpcy5tb2RhbENvbnRlbnQubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKHRoaXMuZm9jdXNhYmxlRWxlbWVudHMpWzFdIHx8XG4gICAgICAgIHRoaXMubW9kYWxDb250ZW50Lm5hdGl2ZUVsZW1lbnQ7XG4gICAgICBmaXJzdEZpZWxkRWxlbWVudC5mb2N1cygpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlRXZlbnRMaXN0ZW5lcnMoKSB7XG4gICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignZm9jdXMnLCB0aGlzLmZvY3VzRnVuY3Rpb24sIHRydWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRGaXJzdEVsZW1lbnQoKSB7XG4gICAgdGhpcy5maXJzdEVsZW1lbnQgPSB0aGlzLm1vZGFsQ29udGVudC5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IodGhpcy5mb2N1c2FibGVFbGVtZW50cykgfHwgdGhpcy5tb2RhbENvbnRlbnQubmF0aXZlRWxlbWVudDtcbiAgfVxuXG59XG4iXX0=