/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { map } from 'rxjs/operators';
import { addZero, convertDateToISOExtended } from '../../utils/util';
export class ThfPageJobSchedulerService {
    /**
     * @param {?} http
     */
    constructor(http) {
        this.http = http;
        this.endpoint = '/';
        this.headers = new HttpHeaders({
            'X-TOTVS-SCREEN-LOCK': 'true'
        });
    }
    /**
     * @param {?=} config
     * @return {?}
     */
    configServiceApi(config = {}) {
        this.endpoint = config.endpoint;
    }
    // Cria um recurso
    /**
     * @param {?} resource
     * @return {?}
     */
    createResource(resource) {
        /** @type {?} */
        const jobScheduler = this.convertToJobScheduler(resource);
        return this.http.post(`${this.endpoint}`, jobScheduler, { headers: this.headers });
    }
    /**
     * @return {?}
     */
    getHeadProcesses() {
        /** @type {?} */
        const headers = { 'X-Totvs-No-Error': 'true' };
        return this.http.head(`${this.endpoint}/processes`, { headers });
    }
    // Busca parametros pelo processo id
    /**
     * @param {?} processId
     * @return {?}
     */
    getParametersByProcess(processId) {
        return this.http.get(`${this.endpoint}/processes/${processId}/parameters`, { headers: this.headers })
            .pipe(map((/**
         * @param {?} resource
         * @return {?}
         */
        (resource) => resource.items)));
    }
    // Busca um único recurso
    /**
     * @param {?} id
     * @return {?}
     */
    getProcess(id) {
        return this.http.get(`${this.endpoint}/processes/${id}`, { headers: this.headers });
    }
    // Busca uma lista de processos
    /**
     * @param {?=} params
     * @return {?}
     */
    getProcesses(params = {}) {
        return this.http.get(`${this.endpoint}/processes`, { params });
    }
    // Busca um único recurso
    /**
     * @param {?} id
     * @return {?}
     */
    getResource(id) {
        return this.http.get(`${this.endpoint}/${id}`, { headers: this.headers })
            .pipe(map((/**
         * @param {?} resource
         * @return {?}
         */
        resource => this.convertToJobSchedulerInternal(resource))));
    }
    // Atualiza um recurso
    /**
     * @param {?} id
     * @param {?} resource
     * @return {?}
     */
    updateResource(id, resource) {
        /** @type {?} */
        const jobScheduler = this.convertToJobScheduler(resource);
        return this.http.put(`${this.endpoint}/${id}`, jobScheduler, { headers: this.headers });
    }
    /**
     * @private
     * @param {?} jobSchedulerInternal
     * @return {?}
     */
    convertToJobScheduler(jobSchedulerInternal) {
        /** @type {?} */
        const jobScheduler = Object.assign({}, jobSchedulerInternal);
        if (jobSchedulerInternal.periodicity) {
            if (jobSchedulerInternal.periodicity === 'single') {
                jobScheduler.recurrent = false;
            }
            else {
                Object.assign(jobScheduler, this.convertToPeriodicity(jobSchedulerInternal));
            }
        }
        if (jobSchedulerInternal.firstExecutionHour) {
            jobScheduler.firstExecution =
                this.replaceHourFirstExecution(jobSchedulerInternal.firstExecution, jobSchedulerInternal.firstExecutionHour);
        }
        if (!Object.keys(this.returnValidExecutionParameter(jobScheduler.executionParameter)).length) {
            delete jobScheduler.executionParameter;
        }
        this.removeInvalidKeys(jobScheduler);
        return jobScheduler;
    }
    /**
     * @private
     * @param {?=} jobScheduler
     * @return {?}
     */
    convertToJobSchedulerInternal(jobScheduler = (/** @type {?} */ ({}))) {
        /** @type {?} */
        const jobSchedulerInternal = Object.assign({}, jobScheduler);
        if (jobScheduler.firstExecution) {
            jobSchedulerInternal.firstExecutionHour = this.getHourFirstExecution(jobScheduler.firstExecution);
        }
        Object.assign(jobSchedulerInternal, this.convertToPeriodicityInternal(jobScheduler));
        this.removeInvalidKeys(jobSchedulerInternal, ['weekly', 'monthly', 'daily']);
        return jobSchedulerInternal;
    }
    /**
     * @private
     * @param {?} value
     * @return {?}
     */
    convertToPeriodicity(value) {
        /** @type {?} */
        const newValue = {};
        /** @type {?} */
        const valuePeriodicity = value.periodicity;
        if (valuePeriodicity) {
            newValue[valuePeriodicity] = {};
            if (valuePeriodicity === 'monthly') {
                newValue[valuePeriodicity].day = value.dayOfMonth ? parseInt(value.dayOfMonth, 10) : 0;
            }
            else if (valuePeriodicity === 'weekly') {
                newValue[valuePeriodicity].daysOfWeek = value.daysOfWeek;
            }
            newValue[valuePeriodicity].hour = value.hour ? parseInt(value.hour.split(':')[0], 10) : 0;
            newValue[valuePeriodicity].minute = value.hour ? parseInt(value.hour.split(':')[1], 10) : 0;
        }
        return newValue;
    }
    /**
     * @private
     * @param {?=} value
     * @return {?}
     */
    convertToPeriodicityInternal(value = (/** @type {?} */ ({}))) {
        if (value.monthly) {
            return {
                periodicity: 'monthly',
                hour: `${addZero(value.monthly.hour)}:${addZero(value.monthly.minute)}`,
                dayOfMonth: value.monthly.day
            };
        }
        else if (value.daily) {
            return {
                periodicity: 'daily',
                hour: `${addZero(value.daily.hour)}:${addZero(value.daily.minute)}`
            };
        }
        else if (value.weekly) {
            return {
                periodicity: 'weekly',
                hour: `${addZero(value.weekly.hour)}:${addZero(value.weekly.minute)}`,
                daysOfWeek: [...value.weekly.daysOfWeek]
            };
        }
        else {
            return {
                periodicity: 'single'
            };
        }
    }
    /**
     * @private
     * @param {?} date
     * @return {?}
     */
    getCurrentHour(date) {
        /** @type {?} */
        const hours = addZero(date.getHours());
        /** @type {?} */
        const minutes = addZero(date.getMinutes());
        return `${hours}:${minutes}`;
    }
    /**
     * @private
     * @param {?} firstExecutionDate
     * @return {?}
     */
    getHourFirstExecution(firstExecutionDate) {
        return this.getCurrentHour(new Date(firstExecutionDate));
    }
    /**
     * @private
     * @param {?} value
     * @param {?=} keys
     * @return {?}
     */
    removeInvalidKeys(value, keys) {
        /** @type {?} */
        const invalidKeys = keys || ['periodicity', 'hour', 'minute', 'day', 'daysOfWeek', 'dayOfMonth', 'firstExecutionHour'];
        Object.keys(value).forEach((/**
         * @param {?} key
         * @return {?}
         */
        key => {
            if (invalidKeys.includes(key)) {
                delete value[key];
            }
        }));
    }
    /**
     * @private
     * @param {?} date
     * @param {?} time
     * @return {?}
     */
    replaceHourFirstExecution(date, time) {
        /** @type {?} */
        const firstExecutionDate = new Date(date);
        /** @type {?} */
        const timeSplited = time.split(':');
        /** @type {?} */
        const hours = parseInt(timeSplited[0], 10);
        /** @type {?} */
        const minutes = parseInt(timeSplited[1], 10);
        firstExecutionDate.setHours(hours, minutes);
        return convertDateToISOExtended(firstExecutionDate);
    }
    /**
     * @private
     * @param {?} parameter
     * @return {?}
     */
    returnValidExecutionParameter(parameter) {
        /** @type {?} */
        const newParameter = Object.assign({}, parameter);
        for (const key in newParameter) {
            if (newParameter.hasOwnProperty(key) && newParameter[key] === undefined) {
                delete newParameter[key];
            }
        }
        return newParameter;
    }
}
ThfPageJobSchedulerService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
ThfPageJobSchedulerService.ctorParameters = () => [
    { type: HttpClient }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    ThfPageJobSchedulerService.prototype.endpoint;
    /** @type {?} */
    ThfPageJobSchedulerService.prototype.headers;
    /**
     * @type {?}
     * @private
     */
    ThfPageJobSchedulerService.prototype.http;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGhmLXBhZ2Utam9iLXNjaGVkdWxlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHRvdHZzL3RoZi10ZW1wbGF0ZXMvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy90aGYtcGFnZS1qb2Itc2NoZWR1bGVyL3RoZi1wYWdlLWpvYi1zY2hlZHVsZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUMvRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRzNDLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVyQyxPQUFPLEVBQUUsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFPckUsTUFBTSxPQUFPLDBCQUEwQjs7OztJQVFyQyxZQUFvQixJQUFnQjtRQUFoQixTQUFJLEdBQUosSUFBSSxDQUFZO1FBTjVCLGFBQVEsR0FBRyxHQUFHLENBQUM7UUFFZCxZQUFPLEdBQWdCLElBQUksV0FBVyxDQUFDO1lBQzlDLHFCQUFxQixFQUFFLE1BQU07U0FDOUIsQ0FBQyxDQUFDO0lBRXFDLENBQUM7Ozs7O0lBRXpDLGdCQUFnQixDQUFDLFNBQWdDLEVBQUU7UUFDakQsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDO0lBQ2xDLENBQUM7Ozs7OztJQUdELGNBQWMsQ0FBQyxRQUFROztjQUNmLFlBQVksR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsUUFBUSxDQUFDO1FBRXpELE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUUsWUFBWSxFQUFFLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO0lBQ3JGLENBQUM7Ozs7SUFFRCxnQkFBZ0I7O2NBQ1Is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RW5DLFdBQVcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQzs7Y0FFN0IsS0FBSyxHQUFHLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDOztjQUNwQyxPQUFPLEdBQUcsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUM7UUFFNUMsa0JBQWtCLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztRQUU1QyxPQUFPLHdCQUF3QixDQUFDLGtCQUFrQixDQUFDLENBQUM7SUFDdEQsQ0FBQzs7Ozs7O0lBRU8sNkJBQTZCLENBQUMsU0FBaUI7O2NBQy9DLFlBQVkscUJBQVEsU0FBUyxDQUFFO1FBRXJDLEtBQUssTUFBTSxHQUFHLElBQUksWUFBWSxFQUFFO1lBQzlCLElBQUksWUFBWSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsSUFBSSxZQUFZLENBQUMsR0FBRyxDQUFDLEtBQUssU0FBUyxFQUFFO2dCQUN2RSxPQUFPLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUMxQjtTQUNGO1FBRUQsT0FBTyxZQUFZLENBQUM7SUFDdEIsQ0FBQzs7O1lBM0xGLFVBQVU7Ozs7WUFaRixVQUFVOzs7Ozs7O0lBZWpCLDhDQUF1Qjs7SUFFdkIsNkNBRUc7Ozs7O0lBRVMsMENBQXdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cEhlYWRlcnMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgYWRkWmVybywgY29udmVydERhdGVUb0lTT0V4dGVuZGVkIH0gZnJvbSAnLi4vLi4vdXRpbHMvdXRpbCc7XG5pbXBvcnQgeyBUaGZEeW5hbWljRm9ybUZpZWxkIH0gZnJvbSAnQHRvdHZzL3RoZi11aSc7XG5cbmltcG9ydCB7IFRoZkpvYlNjaGVkdWxlciB9IGZyb20gJy4vaW50ZXJmYWNlcy90aGYtam9iLXNjaGVkdWxlci5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgVGhmSm9iU2NoZWR1bGVySW50ZXJuYWwgfSBmcm9tICcuL2ludGVyZmFjZXMvdGhmLWpvYi1zY2hlZHVsZXItaW50ZXJuYWwuaW50ZXJmYWNlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFRoZlBhZ2VKb2JTY2hlZHVsZXJTZXJ2aWNlIHtcblxuICBwcml2YXRlIGVuZHBvaW50ID0gJy8nO1xuXG4gIHJlYWRvbmx5IGhlYWRlcnM6IEh0dHBIZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKHtcbiAgICAnWC1UT1RWUy1TQ1JFRU4tTE9DSyc6ICd0cnVlJ1xuICB9KTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQpIHsgfVxuXG4gIGNvbmZpZ1NlcnZpY2VBcGkoY29uZmlnOiB7IGVuZHBvaW50Pzogc3RyaW5nIH0gPSB7fSkge1xuICAgIHRoaXMuZW5kcG9pbnQgPSBjb25maWcuZW5kcG9pbnQ7XG4gIH1cblxuICAvLyBDcmlhIHVtIHJlY3Vyc29cbiAgY3JlYXRlUmVzb3VyY2UocmVzb3VyY2UpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IGpvYlNjaGVkdWxlciA9IHRoaXMuY29udmVydFRvSm9iU2NoZWR1bGVyKHJlc291cmNlKTtcblxuICAgIHJldHVybiB0aGlzLmh0dHAucG9zdChgJHt0aGlzLmVuZHBvaW50fWAsIGpvYlNjaGVkdWxlciwgeyBoZWFkZXJzOiB0aGlzLmhlYWRlcnMgfSk7XG4gIH1cblxuICBnZXRIZWFkUHJvY2Vzc2VzKCkge1xuICAgIGNvbnN0IGhlYWRlcnMgPSB7ICdYLVRvdHZzLU5vLUVycm9yJzogJ3RydWUnIH07XG5cbiAgICByZXR1cm4gdGhpcy5odHRwLmhlYWQoYCR7dGhpcy5lbmRwb2ludH0vcHJvY2Vzc2VzYCwgeyBoZWFkZXJzIH0pO1xuICB9XG5cbiAgLy8gQnVzY2EgcGFyYW1ldHJvcyBwZWxvIHByb2Nlc3NvIGlkXG4gIGdldFBhcmFtZXRlcnNCeVByb2Nlc3MocHJvY2Vzc0lkOiBzdHJpbmcgfCBudW1iZXIpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KGAke3RoaXMuZW5kcG9pbnR9L3Byb2Nlc3Nlcy8ke3Byb2Nlc3NJZH0vcGFyYW1ldGVyc2AsIHsgaGVhZGVyczogdGhpcy5oZWFkZXJzIH0pXG4gICAgLnBpcGUobWFwKChyZXNvdXJjZTogeyBpdGVtczogQXJyYXk8VGhmRHluYW1pY0Zvcm1GaWVsZD4gfSkgPT4gcmVzb3VyY2UuaXRlbXMpKTtcbiAgfVxuXG4gIC8vIEJ1c2NhIHVtIMO6bmljbyByZWN1cnNvXG4gIGdldFByb2Nlc3MoaWQ6IHN0cmluZyB8IG51bWJlcik6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQoYCR7dGhpcy5lbmRwb2ludH0vcHJvY2Vzc2VzLyR7aWR9YCwgeyBoZWFkZXJzOiB0aGlzLmhlYWRlcnMgfSk7XG4gIH1cblxuICAvLyBCdXNjYSB1bWEgbGlzdGEgZGUgcHJvY2Vzc29zXG4gIGdldFByb2Nlc3NlcyhwYXJhbXM6IHt9ID0ge30pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KGAke3RoaXMuZW5kcG9pbnR9L3Byb2Nlc3Nlc2AsIHsgcGFyYW1zIH0pO1xuICB9XG5cbiAgLy8gQnVzY2EgdW0gw7puaWNvIHJlY3Vyc29cbiAgZ2V0UmVzb3VyY2UoaWQ6IHN0cmluZyB8IG51bWJlcik6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQoYCR7dGhpcy5lbmRwb2ludH0vJHtpZH1gLCB7IGhlYWRlcnM6IHRoaXMuaGVhZGVycyB9KVxuICAgICAgLnBpcGUobWFwKHJlc291cmNlID0+IHRoaXMuY29udmVydFRvSm9iU2NoZWR1bGVySW50ZXJuYWwocmVzb3VyY2UpKSk7XG4gIH1cblxuICAvLyBBdHVhbGl6YSB1bSByZWN1cnNvXG4gIHVwZGF0ZVJlc291cmNlKGlkLCByZXNvdXJjZSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3Qgam9iU2NoZWR1bGVyID0gdGhpcy5jb252ZXJ0VG9Kb2JTY2hlZHVsZXIocmVzb3VyY2UpO1xuXG4gICAgcmV0dXJuIHRoaXMuaHR0cC5wdXQoYCR7dGhpcy5lbmRwb2ludH0vJHtpZH1gLCBqb2JTY2hlZHVsZXIsIHsgaGVhZGVyczogdGhpcy5oZWFkZXJzIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjb252ZXJ0VG9Kb2JTY2hlZHVsZXIoam9iU2NoZWR1bGVySW50ZXJuYWwpOiBUaGZKb2JTY2hlZHVsZXIge1xuICAgIGNvbnN0IGpvYlNjaGVkdWxlciA9IHsgLi4uam9iU2NoZWR1bGVySW50ZXJuYWwgfTtcblxuICAgIGlmIChqb2JTY2hlZHVsZXJJbnRlcm5hbC5wZXJpb2RpY2l0eSkge1xuXG4gICAgICBpZiAoam9iU2NoZWR1bGVySW50ZXJuYWwucGVyaW9kaWNpdHkgPT09ICdzaW5nbGUnKSB7XG4gICAgICAgIGpvYlNjaGVkdWxlci5yZWN1cnJlbnQgPSBmYWxzZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIE9iamVjdC5hc3NpZ24oam9iU2NoZWR1bGVyLCB0aGlzLmNvbnZlcnRUb1BlcmlvZGljaXR5KGpvYlNjaGVkdWxlckludGVybmFsKSk7XG4gICAgICB9XG5cbiAgICB9XG5cbiAgICBpZiAoam9iU2NoZWR1bGVySW50ZXJuYWwuZmlyc3RFeGVjdXRpb25Ib3VyKSB7XG4gICAgICBqb2JTY2hlZHVsZXIuZmlyc3RFeGVjdXRpb24gPVxuICAgICAgICB0aGlzLnJlcGxhY2VIb3VyRmlyc3RFeGVjdXRpb24oam9iU2NoZWR1bGVySW50ZXJuYWwuZmlyc3RFeGVjdXRpb24sIGpvYlNjaGVkdWxlckludGVybmFsLmZpcnN0RXhlY3V0aW9uSG91cik7XG4gICAgfVxuXG4gICAgaWYgKCFPYmplY3Qua2V5cyh0aGlzLnJldHVyblZhbGlkRXhlY3V0aW9uUGFyYW1ldGVyKGpvYlNjaGVkdWxlci5leGVjdXRpb25QYXJhbWV0ZXIpKS5sZW5ndGgpIHtcbiAgICAgIGRlbGV0ZSBqb2JTY2hlZHVsZXIuZXhlY3V0aW9uUGFyYW1ldGVyO1xuICAgIH1cblxuICAgIHRoaXMucmVtb3ZlSW52YWxpZEtleXMoam9iU2NoZWR1bGVyKTtcblxuICAgIHJldHVybiBqb2JTY2hlZHVsZXI7XG4gIH1cblxuICBwcml2YXRlIGNvbnZlcnRUb0pvYlNjaGVkdWxlckludGVybmFsKGpvYlNjaGVkdWxlciA9IDxhbnk+IHt9KTogVGhmSm9iU2NoZWR1bGVySW50ZXJuYWwge1xuICAgIGNvbnN0IGpvYlNjaGVkdWxlckludGVybmFsID0geyAuLi5qb2JTY2hlZHVsZXIgfTtcblxuICAgIGlmIChqb2JTY2hlZHVsZXIuZmlyc3RFeGVjdXRpb24pIHtcbiAgICAgIGpvYlNjaGVkdWxlckludGVybmFsLmZpcnN0RXhlY3V0aW9uSG91ciA9IHRoaXMuZ2V0SG91ckZpcnN0RXhlY3V0aW9uKGpvYlNjaGVkdWxlci5maXJzdEV4ZWN1dGlvbik7XG4gICAgfVxuXG4gICAgT2JqZWN0LmFzc2lnbihqb2JTY2hlZHVsZXJJbnRlcm5hbCwgdGhpcy5jb252ZXJ0VG9QZXJpb2RpY2l0eUludGVybmFsKGpvYlNjaGVkdWxlcikpO1xuXG4gICAgdGhpcy5yZW1vdmVJbnZhbGlkS2V5cyhqb2JTY2hlZHVsZXJJbnRlcm5hbCwgWyd3ZWVrbHknLCAnbW9udGhseScsICdkYWlseSddKTtcblxuICAgIHJldHVybiBqb2JTY2hlZHVsZXJJbnRlcm5hbDtcbiAgfVxuXG4gIHByaXZhdGUgY29udmVydFRvUGVyaW9kaWNpdHkodmFsdWU6IHsgcGVyaW9kaWNpdHk6IHN0cmluZyAsIGRheU9mTW9udGg/OiBzdHJpbmcsIGRheXNPZldlZWs/OiBudW1iZXIsIGhvdXI/OiBzdHJpbmcgfSkge1xuICAgIGNvbnN0IG5ld1ZhbHVlID0ge307XG4gICAgY29uc3QgdmFsdWVQZXJpb2RpY2l0eSA9IHZhbHVlLnBlcmlvZGljaXR5O1xuXG4gICAgaWYgKHZhbHVlUGVyaW9kaWNpdHkpIHtcbiAgICAgIG5ld1ZhbHVlW3ZhbHVlUGVyaW9kaWNpdHldID0ge307XG5cbiAgICAgIGlmICh2YWx1ZVBlcmlvZGljaXR5ID09PSAnbW9udGhseScpIHtcbiAgICAgICAgbmV3VmFsdWVbdmFsdWVQZXJpb2RpY2l0eV0uZGF5ID0gdmFsdWUuZGF5T2ZNb250aCA/IHBhcnNlSW50KHZhbHVlLmRheU9mTW9udGgsIDEwKSA6IDA7XG4gICAgICB9IGVsc2UgaWYgKHZhbHVlUGVyaW9kaWNpdHkgPT09ICd3ZWVrbHknKSB7XG4gICAgICAgIG5ld1ZhbHVlW3ZhbHVlUGVyaW9kaWNpdHldLmRheXNPZldlZWsgPSB2YWx1ZS5kYXlzT2ZXZWVrO1xuICAgICAgfVxuXG4gICAgICBuZXdWYWx1ZVt2YWx1ZVBlcmlvZGljaXR5XS5ob3VyID0gdmFsdWUuaG91ciA/IHBhcnNlSW50KHZhbHVlLmhvdXIuc3BsaXQoJzonKVswXSwgMTApIDogMDtcbiAgICAgIG5ld1ZhbHVlW3ZhbHVlUGVyaW9kaWNpdHldLm1pbnV0ZSA9IHZhbHVlLmhvdXIgPyBwYXJzZUludCh2YWx1ZS5ob3VyLnNwbGl0KCc6JylbMV0sIDEwKSA6IDA7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ld1ZhbHVlO1xuICB9XG5cbiAgcHJpdmF0ZSBjb252ZXJ0VG9QZXJpb2RpY2l0eUludGVybmFsKHZhbHVlID0gPGFueT4ge30pIHtcbiAgICBpZiAodmFsdWUubW9udGhseSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcGVyaW9kaWNpdHk6ICdtb250aGx5JyxcbiAgICAgICAgaG91cjogYCR7YWRkWmVybyh2YWx1ZS5tb250aGx5LmhvdXIpfToke2FkZFplcm8odmFsdWUubW9udGhseS5taW51dGUpfWAsXG4gICAgICAgIGRheU9mTW9udGg6IHZhbHVlLm1vbnRobHkuZGF5XG4gICAgICB9O1xuICAgIH0gZWxzZSBpZiAodmFsdWUuZGFpbHkpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHBlcmlvZGljaXR5OiAnZGFpbHknLFxuICAgICAgICBob3VyOiBgJHthZGRaZXJvKHZhbHVlLmRhaWx5LmhvdXIpfToke2FkZFplcm8odmFsdWUuZGFpbHkubWludXRlKX1gXG4gICAgICB9O1xuICAgIH0gZWxzZSBpZiAodmFsdWUud2Vla2x5KSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBwZXJpb2RpY2l0eTogJ3dlZWtseScsXG4gICAgICAgIGhvdXI6IGAke2FkZFplcm8odmFsdWUud2Vla2x5LmhvdXIpfToke2FkZFplcm8odmFsdWUud2Vla2x5Lm1pbnV0ZSl9YCxcbiAgICAgICAgZGF5c09mV2VlazogWy4uLnZhbHVlLndlZWtseS5kYXlzT2ZXZWVrXVxuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcGVyaW9kaWNpdHk6ICdzaW5nbGUnXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q3VycmVudEhvdXIoZGF0ZTogRGF0ZSk6IHN0cmluZyB7XG4gICAgY29uc3QgaG91cnMgPSBhZGRaZXJvKGRhdGUuZ2V0SG91cnMoKSk7XG4gICAgY29uc3QgbWludXRlcyA9IGFkZFplcm8oZGF0ZS5nZXRNaW51dGVzKCkpO1xuXG4gICAgcmV0dXJuIGAke2hvdXJzfToke21pbnV0ZXN9YDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0SG91ckZpcnN0RXhlY3V0aW9uKGZpcnN0RXhlY3V0aW9uRGF0ZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5nZXRDdXJyZW50SG91cihuZXcgRGF0ZShmaXJzdEV4ZWN1dGlvbkRhdGUpKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlSW52YWxpZEtleXModmFsdWU6IG9iamVjdCwga2V5cz86IEFycmF5PHN0cmluZz4pIHtcbiAgICBjb25zdCBpbnZhbGlkS2V5cyA9IGtleXMgfHwgWydwZXJpb2RpY2l0eScsICdob3VyJywgJ21pbnV0ZScsICdkYXknLCAnZGF5c09mV2VlaycsICdkYXlPZk1vbnRoJywgJ2ZpcnN0RXhlY3V0aW9uSG91ciddO1xuXG4gICAgT2JqZWN0LmtleXModmFsdWUpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgIGlmIChpbnZhbGlkS2V5cy5pbmNsdWRlcyhrZXkpKSB7XG4gICAgICAgIGRlbGV0ZSB2YWx1ZVtrZXldO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSByZXBsYWNlSG91ckZpcnN0RXhlY3V0aW9uKGRhdGU6IHN0cmluZywgdGltZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCBmaXJzdEV4ZWN1dGlvbkRhdGUgPSBuZXcgRGF0ZShkYXRlKTtcblxuICAgIGNvbnN0IHRpbWVTcGxpdGVkID0gdGltZS5zcGxpdCgnOicpO1xuXG4gICAgY29uc3QgaG91cnMgPSBwYXJzZUludCh0aW1lU3BsaXRlZFswXSwgMTApO1xuICAgIGNvbnN0IG1pbnV0ZXMgPSBwYXJzZUludCh0aW1lU3BsaXRlZFsxXSwgMTApO1xuXG4gICAgZmlyc3RFeGVjdXRpb25EYXRlLnNldEhvdXJzKGhvdXJzLCBtaW51dGVzKTtcblxuICAgIHJldHVybiBjb252ZXJ0RGF0ZVRvSVNPRXh0ZW5kZWQoZmlyc3RFeGVjdXRpb25EYXRlKTtcbiAgfVxuXG4gIHByaXZhdGUgcmV0dXJuVmFsaWRFeGVjdXRpb25QYXJhbWV0ZXIocGFyYW1ldGVyOiBvYmplY3QpIHtcbiAgICBjb25zdCBuZXdQYXJhbWV0ZXIgPSB7IC4uLnBhcmFtZXRlciB9O1xuXG4gICAgZm9yIChjb25zdCBrZXkgaW4gbmV3UGFyYW1ldGVyKSB7XG4gICAgICBpZiAobmV3UGFyYW1ldGVyLmhhc093blByb3BlcnR5KGtleSkgJiYgbmV3UGFyYW1ldGVyW2tleV0gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBkZWxldGUgbmV3UGFyYW1ldGVyW2tleV07XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ld1BhcmFtZXRlcjtcbiAgfVxuXG59XG4iXX0=